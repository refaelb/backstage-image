{"version":3,"file":"immutableJSONPatch.js","names":["_immutabilityHelpers","require","_jsonPointer","_utils","immutableJSONPatch","document","operations","options","updatedDocument","i","length","validateJSONPatchOperation","operation","before","result","undefined","json","Error","previousDocument","path","parsePath","op","add","value","remove","replace","copy","parseFrom","from","move","test","JSON","stringify","after","setIn","deleteIn","isArrayItem","insertAt","getIn","removedJson","concat","compileJSONPointer","existsIn","actualValue","isEqual","parent","initial","Array","isArray","resolvePathIndex","last","parentPath","ops","includes","pointer","parseJSONPointer","fromPointer"],"sources":["../../src/immutableJSONPatch.ts"],"sourcesContent":["import {\n  deleteIn,\n  existsIn,\n  getIn,\n  insertAt,\n  setIn\n} from './immutabilityHelpers.js'\nimport { compileJSONPointer, parseJSONPointer } from './jsonPointer.js'\nimport {\n  JSONArray,\n  JSONValue,\n  JSONObject,\n  JSONPatchDocument,\n  JSONPatchOperation,\n  JSONPatchOptions,\n  JSONPath,\n  JSONPointer\n} from './types'\nimport { initial, isEqual, last } from './utils.js'\n\n/**\n * Apply a patch to a JSON object\n * The original JSON object will not be changed,\n * instead, the patch is applied in an immutable way\n */\nexport function immutableJSONPatch (document: JSONValue, operations: JSONPatchDocument, options?:JSONPatchOptions) : JSONValue {\n  let updatedDocument = document\n\n  for (let i = 0; i < operations.length; i++) {\n    validateJSONPatchOperation(operations[i])\n\n    let operation: JSONPatchOperation = operations[i]\n\n    // TODO: test before\n    if (options && options.before) {\n      const result = options.before(updatedDocument, operation)\n      if (result !== undefined) {\n        if (result.document !== undefined) {\n          updatedDocument = result.document\n        }\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        if (result.json !== undefined) {\n          // TODO: deprecated since v5.0.0. Cleanup this warning some day\n          throw new Error('Deprecation warning: returned object property \".json\" has been renamed to \".document\"')\n        }\n        if (result.operation !== undefined) {\n          operation = result.operation\n        }\n      }\n    }\n\n    const previousDocument = updatedDocument\n    const path = parsePath(updatedDocument, operation.path)\n    if (operation.op === 'add') {\n      updatedDocument = add(updatedDocument, path, operation.value)\n    } else if (operation.op === 'remove') {\n      updatedDocument = remove(updatedDocument as JSONObject | JSONArray, path)\n    } else if (operation.op === 'replace') {\n      updatedDocument = replace(updatedDocument, path, operation.value)\n    } else if (operation.op === 'copy') {\n      updatedDocument = copy(updatedDocument, path, parseFrom(operation.from))\n    } else if (operation.op === 'move') {\n      updatedDocument = move(updatedDocument, path, parseFrom(operation.from))\n    } else if (operation.op === 'test') {\n      test(updatedDocument, path, operation.value)\n    } else {\n      throw new Error('Unknown JSONPatch operation ' + JSON.stringify(operation))\n    }\n\n    // TODO: test after\n    if (options && options.after) {\n      const result = options.after(updatedDocument, operation, previousDocument)\n      if (result !== undefined) {\n        updatedDocument = result\n      }\n    }\n  }\n\n  return updatedDocument\n}\n\n/**\n * Replace an existing item\n */\nexport function replace (document: JSONValue, path: JSONPath, value: JSONValue) : JSONValue {\n  return setIn(document, path, value)\n}\n\n/**\n * Remove an item or property\n */\nexport function remove<T extends JSONArray | JSONObject> (document: T, path: JSONPath) : T {\n  return deleteIn(document, path)\n}\n\n/**\n * Add an item or property\n */\nexport function add (document: JSONValue, path: JSONPath, value: JSONValue) : JSONValue {\n  if (isArrayItem(document, path)) {\n    return insertAt(document, path, value)\n  } else {\n    return setIn(document, path, value)\n  }\n}\n\n/**\n * Copy a value\n */\nexport function copy (document: JSONValue, path: JSONPath, from: JSONPath) : JSONValue {\n  const value = getIn(document, from)\n\n  if (isArrayItem(document, path)) {\n    return insertAt(document, path, value)\n  } else {\n    const value = getIn(document, from)\n\n    return setIn(document, path, value)\n  }\n}\n\n/**\n * Move a value\n */\nexport function move (document: JSONValue, path: JSONPath, from: JSONPath) : JSONValue {\n  const value = getIn(document, from)\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  const removedJson = deleteIn(document, from)\n\n  return isArrayItem(removedJson, path)\n    ? insertAt(removedJson, path, value)\n    : setIn(removedJson, path, value)\n}\n\n/**\n * Test whether the data contains the provided value at the specified path.\n * Throws an error when the test fails\n */\nexport function test (document: JSONValue, path: JSONPath, value: JSONValue) {\n  if (value === undefined) {\n    throw new Error(`Test failed: no value provided (path: \"${compileJSONPointer(path)}\")`)\n  }\n\n  if (!existsIn(document, path)) {\n    throw new Error(`Test failed: path not found (path: \"${compileJSONPointer(path)}\")`)\n  }\n\n  const actualValue = getIn(document, path)\n  if (!isEqual(actualValue, value)) {\n    throw new Error(`Test failed, value differs (path: \"${compileJSONPointer(path)}\")`)\n  }\n}\n\nexport function isArrayItem (document: JSONValue, path: JSONPath) : document is JSONArray {\n  if (path.length === 0) {\n    return false\n  }\n\n  const parent = getIn(document, initial(path))\n\n  return Array.isArray(parent)\n}\n\n/**\n * Resolve the path index of an array, resolves indexes '-'\n * @returns Returns the resolved path\n */\nexport function resolvePathIndex (document: JSONValue, path: JSONPath) : JSONPath {\n  if (last(path) !== '-') {\n    return path\n  }\n\n  const parentPath = initial(path)\n  const parent = getIn(document, parentPath)\n\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  return parentPath.concat(parent.length)\n}\n\n/**\n * Validate a JSONPatch operation.\n * Throws an error when there is an issue\n */\nexport function validateJSONPatchOperation (operation: JSONPatchOperation) {\n  // TODO: write unit tests\n  const ops = ['add', 'remove', 'replace', 'copy', 'move', 'test']\n\n  if (!ops.includes(operation.op)) {\n    throw new Error('Unknown JSONPatch op ' + JSON.stringify(operation.op))\n  }\n\n  if (typeof operation.path !== 'string') {\n    throw new Error('Required property \"path\" missing or not a string in operation ' + JSON.stringify(operation))\n  }\n\n  if (operation.op === 'copy' || operation.op === 'move') {\n    if (typeof operation.from !== 'string') {\n      throw new Error('Required property \"from\" missing or not a string in operation ' + JSON.stringify(operation))\n    }\n  }\n}\n\nexport function parsePath (document: JSONValue, pointer: JSONPointer) : JSONPath {\n  return resolvePathIndex(document, parseJSONPointer(pointer))\n}\n\nexport function parseFrom (fromPointer: JSONPointer) : JSONPath {\n  return parseJSONPointer(fromPointer)\n}\n"],"mappings":"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"}