# Spotify Plugins for Backstage: Role-Based Access Control (RBAC) - Frontend

![](https://spotify-plugins-for-backstage-readme-images.spotifycdn.com/rbac.png)

The RBAC plugin works with the [Backstage permission framework](https://backstage.io/docs/permissions/overview) to provide support for role-based access control in Backstage. The Backstage permission framework is a system in the open-source Backstage project, which allows granular control of access to specific resources or actions. The permission framework is currently supported in the Catalog and TechDocs, with other core features soon to come. In the future, we’ll encourage third-party plugin authors to add permission support too — which can be done without changes to the Backstage core.

Permissions are controlled in a Backstage instance through a **policy**. A policy is simply an async function which receives a request to authorize a specific action for a user and (optional) resource, and returns a decision on whether to authorize that permission. Without the RBAC plugin, integrators must implement their own policies from scratch, or adapt reusable policies written by others.

The RBAC plugin allows you to control permissions in Backstage without writing code. Instead, you can manage your policy using the RBAC interface integrated with Backstage. Once you publish the changes to your policy, they will be reflected immediately.

With the RBAC plugin, you manage the permissions in your Backstage instance by assigning users and groups to roles, and configuring the rules that should apply for each role. You can use powerful matching features to keep your policy short, or supply granular decisions for each available permission and role.

## Prerequisites

### 1. Install the RBAC Backend plugin

You must install the [RBAC Backend](https://npmjs.com/@spotify/backstage-plugin-rbac-backend) and all of its prerequisites before installing the RBAC frontend.

## Installation

### 1. Getting the plugin

Add the RBAC packages as dependencies to your Backstage instance:

```bash
yarn workspace app add @spotify/backstage-plugin-rbac
```

### 2. Install RBAC frontend

First install the RBAC routes in the app within the `packages/app/src/App.tsx`. This will provide the UI for authoring your RBAC policy under the `/rbac` route. Note that this route can only be accessed by the `authorizedUsers` configured above.

```diff
  // packages/app/src/App.tsx

+ import { RBACRoot } from '@spotify/backstage-plugin-rbac';

  /* ... */

  const routes = (
    <FlatRoutes>
      /* ... */
+     <Route path="/rbac" element={<RBACRoot />} />
    </FlatRoutes>
  );
```

RBAC also provides a sidebar item that will only be visible to RBAC `authorizedUsers`. This is an optional step, but it provides an easy way for RBAC authorized users to access the plugin.

```diff
  // packages/app/src/components/Root.tsx

+ import { RBACSidebarItem } from '@spotify/backstage-plugin-rbac';

export const Root = ({ children }: PropsWithChildren<{}>) => (
  <SidebarPage>
    <Sidebar>
      <SidebarLogo />

      /* ... */

      <SidebarScrollWrapper>
        <SidebarItem icon={MapIcon} to="tech-radar" text="Tech Radar" />
        <SidebarItem
          icon={SkillExchangeIcon}
          to="skill-exchange"
          text="Skill Exchange"
        />
        <SidebarItem icon={PulseIcon} to="pulse" text="Pulse" />
        <SidebarItem icon={SoundcheckIcon} to="soundcheck" text="Soundcheck" />
+       <RBACSidebarItem />
      </SidebarScrollWrapper>
    </Sidebar>
  </SidebarPage>
);
```

### 3. Configure an initial policy

When there is no published RBAC policy, the default behaviour of RBAC is to deny all authorization requests sent to the permission framework. With this in mind, it's preferable to publish a simple RBAC policy before proceeding to install RBAC in the permission framework.

The following instructions configure RBAC with a policy that allows all authorization requests. If you want to start with something more complex, refer to later sections of this documentation.

1. Open the RBAC UI by visiting the `/rbac` path in your Backstage instance, or clicking the RBAC item in the sidebar (if you've installed the `RBACSidebarItem`).
1. Click "New Version" to start working on a new draft policy, and choose a name for it.
1. Click "New Role" to create a role within the policy, and give that a name too.
1. Click the "New Permission Decision" button in the Permission Decisions table on the right hand side.
1. In the dialog, select "Match All Permissions".
1. Confirm that "Allow" is already selected at the bottom of the dialog.
1. Click "Save".
1. Confirm that the Members table on the left hand side contains a row for "All" users.
1. Click "Back to Policy"
1. Click "Save Draft"
1. Click "Publish", and confirm publishing in the confirmation dialog.

### 4. Install the RBAC policy in the permission framework

To use the RBAC policy in the Backstage instance, we replace the `TestPermissionPolicy` we created when setting up the permission framework with an `RBACPolicy` instance which uses the roles we define in the UI.

Adjust `packages/backend/src/plugins/permission.ts` as follows:

```diff
  import { createRouter } from '@backstage/plugin-permission-backend';
- import {
-   AuthorizeResult,
-   PolicyDecision,
- } from '@backstage/plugin-permission-common';
- import { PermissionPolicy } from '@backstage/plugin-permission-node';
+ import { RBACPolicyBuilder } from '@spotify/backstage-plugin-rbac-backend';
  import { Router } from 'express';
  import { PluginEnvironment } from '../types';

- class TestPermissionPolicy implements PermissionPolicy {
-   async handle(): Promise<PolicyDecision> {
-     return { result: AuthorizeResult.ALLOW };
-   }
- }
-
  export default async function createPlugin(
    env: PluginEnvironment,
  ): Promise<Router> {
    return await createRouter({
      config: env.config,
      logger: env.logger,
      discovery: env.discovery,
-     policy: new TestPermissionPolicy(),
+     policy: await RBACPolicyBuilder.create(env).build(),
      identity: env.identity,
    });
 }
```

### 5. Check everything is working

If you've followed all the steps up to this point, the RBAC policy is now in place! You should find that Backstage adheres to the policy you configured in step 3. If you have any problems, please reach out to us and we'll be happy to provide support.

## Working with the RBAC UI

### Publishing Lifecycle

The RBAC UI provides the ability to build **RBAC policies**. When a policy is first created, it is in **draft** state, and doesn't have any effect on the behavior of Backstage. You can save draft policies while you're working on them, and come back to them later. Once a draft policy is ready, it can be **published**. There is only one published policy in Backstage at any given time. A newly-published policy replaces the existing one, which moves to **inactive** state. Inactive policies can be republished at any time.

### Policy Overview

The RBAC policy is configured by defining one or more **roles**, to which you can add users/groups as members. Each role can have multiple **permission decisions** configured, which match one or more **permissions**, and specify the authorization **decision** that should be made for those permissions.

Users can be a member of multiple roles, and roles can overlap in the permissions they match. When a given permission matches multiple times, the **first match** will be the one used to determine the decision returned.

### Matching permissions

Permissions are a core concept in the Backstage permission framework. Each plugin can define a set of permissions that control what users can see and do within that plugin. Each [permission](https://github.com/backstage/backstage/blob/master/plugins/permission-common/src/types/permission.ts#L39) is an object with the following fields:

- **name**: a string which uniquely identifies the permission, such as `catalog.entity.read`
- **attributes**: an object containing attributes which describe the characteristics of the permission, to allow matching multiple permissions when making a policy decision. We expect the number of supported attributes to increase over time, but for now, the only attribute is `action`, which can be set to `"create"`, `"read"`, `"update"`, or `"delete"`.
- **resourceType**: the type of resource expected to be supplied when authorizing this permission, if applicable (for example `catalog-entity`).

In the RBAC UI, it's possible to match a single specific permission by name, or to match using a combination of resourceType and actions in order to match multiple permissions with a single entry in the list. It's also possible to match all permissions with a single entry - this is mostly useful for defining a fallback at the end of your policy, in case no other permission decision in the policy matched a request.

### Specifying decisions

The RBAC UI supports definitive `allow` or `deny` decisions, as well as [conditional decisions](https://backstage.io/docs/permissions/writing-a-policy#conditional-decisions) whose result can vary based on characteristics of the resource being authorized. Conditional decisions can only be returned for permissions with a resourceType - the RBAC UI handles enabling and disabling the "conditional" option as needed.

Conditional decisions contain one or more **conditions**, which are exported by permissioned plugins and tied to a resourceType. The condition `HAS_ANNOTATION`, for example, is tied to the `catalog-entity` resourceType, and checks whether a catalog entity has a certain annotation. Multiple conditions can be combined using "any of" (return `allow` when any one of these conditions is true), or "all of" (only return `allow` when all of these conditions is true). It's also possible to negate conditions using "not", and combinations of conditions and logical operators can be deeply nested if needed.

## Other features

### Import / Export

The RBAC plugin allows users to export existing policies, a feature which can be found within the policy page. You can import the resulting yaml file back into RBAC, which will result in a draft policy identical to the exported policy. This can be useful when working with multiple Backstage instances with similar configurations.

### Default policy

The RBAC plugin allows Backstage administrators to configure a default policy for deployment. Setting a default policy allows RBAC to enforce an active policy from the start, before any administrator has interacted with the RBAC UI. You can set a default policy by:

1. Create a draft policy in the RBAC UI that represents the policy that you would like to become the default policy.
1. Go to the draft policy page, and download the policy by clicking "Export." Alternatively, you can export any previous version or the active policy from the respective policy pages.
1. Add a `defaultPolicy` field under the `rbac` field in your `app-config.yaml`, and point it to the file you saved from the previous step:

```yaml
permission:
  rbac:
    defaultPolicy:
      $include: ./default-rbac-policy.yaml
```

1. You should now see that your Backstage instance behaves as configured in your default policy, even though you have not yet authored any other policies using the RBAC UI.

**NOTE:** The default policy will be active if and only if no other active policies already exist.

### Fallback policy

By default, when a request to the RBAC backend fails, RBAC will automatically switch to denying all permissions. You can configure this behavior by specifying a fallback policy in your `app-config.yaml` in the exact same way as the default policy:

```yaml
permission:
  rbac:
    fallbackPolicy:
      $include: ./fallback-rbac-policy.yaml
```

### Decision resolution strategy

Multiple decisions from multiple roles could be applicable to a single user when authorizing a permission request. By default, the `any-allow` strategy will be selected for a new policy.

You can change the decision resolution strategy for a policy and read more about the options by following the steps below:

1. Go to the draft policy page and click the `more options` icon on the top right.
2. Select `Options`.
3. Select which resolution strategy makes sense for your policy.
4. Click `Back to Policy` when you are done. Your policy will be automatically updated with your selection, and it will be saved and/or published when save and publish your policy.

### Policy tester

The policy tester is designed to display simulated policy decisions for a given set of permissions, helping you ensure that the configured policy returns the expected decisions. For each [Permission](https://backstage.io/docs/permissions/concepts#permission) selected in the UI, the policy tester will output the decision that would be returned by the policy in question for a user assigned to all of the selected policy roles. If the given permission request requires certain conditions to be met, the policy tester will list exactly which conditions would be required.

You can find the policy tester in the Policy page of any active, draft, or previous policies.
