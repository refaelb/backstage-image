"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useMediaQuery = void 0;
var react_1 = require("react");
var const_1 = require("../util/const");
var queriesMap = new Map();
var createQueryEntry = function (query) {
    var mql = matchMedia(query);
    var dispatchers = new Set();
    var listener = function () {
        dispatchers.forEach(function (d) { return d(mql.matches); });
    };
    if (mql.addEventListener)
        mql.addEventListener('change', listener, { passive: true });
    else
        mql.addListener(listener);
    return {
        mql: mql,
        dispatchers: dispatchers,
        listener: listener,
    };
};
var querySubscribe = function (query, setState) {
    var entry = queriesMap.get(query);
    if (!entry) {
        entry = createQueryEntry(query);
        queriesMap.set(query, entry);
    }
    entry.dispatchers.add(setState);
    setState(entry.mql.matches);
};
var queryUnsubscribe = function (query, setState) {
    var entry = queriesMap.get(query);
    // else path is impossible to test in normal situation
    /* istanbul ignore else */
    if (entry) {
        var mql = entry.mql, dispatchers = entry.dispatchers, listener = entry.listener;
        dispatchers.delete(setState);
        if (!dispatchers.size) {
            queriesMap.delete(query);
            if (mql.removeEventListener)
                mql.removeEventListener('change', listener);
            else
                mql.removeListener(listener);
        }
    }
};
/**
 * Tracks the state of CSS media query.
 *
 * @param query CSS media query to track.
 * @param options Hook options:
 * `initializeWithValue` (default: `true`) - Determine media query match state on first render. Setting
 * this to false will make the hook yield `undefined` on first render.
 */
function useMediaQuery(query, options) {
    if (options === void 0) { options = {}; }
    var _a = options.initializeWithValue, initializeWithValue = _a === void 0 ? true : _a;
    if (!const_1.isBrowser) {
        initializeWithValue = false;
    }
    var _b = (0, react_1.useState)(function () {
        if (initializeWithValue) {
            var entry = queriesMap.get(query);
            if (!entry) {
                entry = createQueryEntry(query);
                queriesMap.set(query, entry);
            }
            return entry.mql.matches;
        }
    }), state = _b[0], setState = _b[1];
    (0, react_1.useEffect)(function () {
        querySubscribe(query, setState);
        return function () { return queryUnsubscribe(query, setState); };
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [query]);
    return state;
}
exports.useMediaQuery = useMediaQuery;
