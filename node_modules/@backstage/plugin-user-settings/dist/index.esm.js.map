{"version":3,"file":"index.esm.js","sources":["../src/apis/StorageApi/UserSettingsStorage.ts","../src/components/Settings.tsx","../src/components/UserSettingsTab/UserSettingsTab.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WebStorage } from '@backstage/core-app-api';\nimport {\n  DiscoveryApi,\n  ErrorApi,\n  FetchApi,\n  IdentityApi,\n  StorageApi,\n  StorageValueSnapshot,\n} from '@backstage/core-plugin-api';\nimport { ResponseError } from '@backstage/errors';\nimport { JsonValue, Observable } from '@backstage/types';\nimport ObservableImpl from 'zen-observable';\n\nconst JSON_HEADERS = {\n  'Content-Type': 'application/json; charset=utf-8',\n  Accept: 'application/json',\n};\n\nconst buckets = new Map<string, UserSettingsStorage>();\n\n/**\n * An implementation of the storage API, that uses the user-settings backend to\n * persist the data in the DB.\n *\n * @public\n */\nexport class UserSettingsStorage implements StorageApi {\n  private subscribers = new Set<\n    ZenObservable.SubscriptionObserver<StorageValueSnapshot<JsonValue>>\n  >();\n\n  private readonly observables = new Map<\n    string,\n    Observable<StorageValueSnapshot<JsonValue>>\n  >();\n\n  private constructor(\n    private readonly namespace: string,\n    private readonly fetchApi: FetchApi,\n    private readonly discoveryApi: DiscoveryApi,\n    private readonly errorApi: ErrorApi,\n    private readonly identityApi: IdentityApi,\n    private readonly fallback: WebStorage,\n  ) {}\n\n  static create(options: {\n    fetchApi: FetchApi;\n    discoveryApi: DiscoveryApi;\n    errorApi: ErrorApi;\n    identityApi: IdentityApi;\n    namespace?: string;\n  }): UserSettingsStorage {\n    return new UserSettingsStorage(\n      options.namespace ?? 'default',\n      options.fetchApi,\n      options.discoveryApi,\n      options.errorApi,\n      options.identityApi,\n      WebStorage.create({\n        namespace: options.namespace,\n        errorApi: options.errorApi,\n      }),\n    );\n  }\n\n  forBucket(name: string): StorageApi {\n    // use dot instead of slash separator to have nicer URLs\n    const bucketPath = `${this.namespace}.${name}`;\n\n    if (!buckets.has(bucketPath)) {\n      buckets.set(\n        bucketPath,\n        new UserSettingsStorage(\n          bucketPath,\n          this.fetchApi,\n          this.discoveryApi,\n          this.errorApi,\n          this.identityApi,\n          this.fallback,\n        ),\n      );\n    }\n\n    return buckets.get(bucketPath)!;\n  }\n\n  async remove(key: string): Promise<void> {\n    const fetchUrl = await this.getFetchUrl(key);\n\n    const response = await this.fetchApi.fetch(fetchUrl, {\n      method: 'DELETE',\n    });\n\n    if (!response.ok && response.status !== 404) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    this.notifyChanges({ key, presence: 'absent' });\n  }\n\n  async set<T extends JsonValue>(key: string, data: T): Promise<void> {\n    if (!(await this.isSignedIn())) {\n      await this.fallback.set(key, data);\n      this.notifyChanges({ key, presence: 'present', value: data });\n      return;\n    }\n\n    const fetchUrl = await this.getFetchUrl(key);\n\n    const response = await this.fetchApi.fetch(fetchUrl, {\n      method: 'PUT',\n      headers: JSON_HEADERS,\n      body: JSON.stringify({ value: data }),\n    });\n\n    if (!response.ok) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    const { value } = await response.json();\n\n    this.notifyChanges({ key, value, presence: 'present' });\n  }\n\n  observe$<T extends JsonValue>(\n    key: string,\n  ): Observable<StorageValueSnapshot<T>> {\n    if (!this.observables.has(key)) {\n      this.observables.set(\n        key,\n        new ObservableImpl<StorageValueSnapshot<JsonValue>>(subscriber => {\n          this.subscribers.add(subscriber);\n\n          // TODO(freben): Introduce server polling or similar, to ensure that different devices update when values change\n          Promise.resolve()\n            .then(() => this.get(key))\n            .then(snapshot => subscriber.next(snapshot))\n            .catch(error => this.errorApi.post(error));\n\n          return () => {\n            this.subscribers.delete(subscriber);\n          };\n        }).filter(({ key: messageKey }) => messageKey === key),\n      );\n    }\n\n    return this.observables.get(key) as Observable<StorageValueSnapshot<T>>;\n  }\n\n  snapshot<T extends JsonValue>(key: string): StorageValueSnapshot<T> {\n    return { key, presence: 'unknown' };\n  }\n\n  private async get<T extends JsonValue>(\n    key: string,\n  ): Promise<StorageValueSnapshot<T>> {\n    if (!(await this.isSignedIn())) {\n      // This explicitly uses WebStorage, which we know is synchronous and doesn't return presence: unknown\n      return this.fallback.snapshot(key);\n    }\n\n    const fetchUrl = await this.getFetchUrl(key);\n    const response = await this.fetchApi.fetch(fetchUrl);\n\n    if (response.status === 404) {\n      return { key, presence: 'absent' };\n    }\n\n    if (!response.ok) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    try {\n      const { value: rawValue } = await response.json();\n      const value = JSON.parse(JSON.stringify(rawValue), (_key, val) => {\n        if (typeof val === 'object' && val !== null) {\n          Object.freeze(val);\n        }\n        return val;\n      });\n\n      return { key, presence: 'present', value };\n    } catch {\n      // If the value is not valid JSON, we return an unknown presence. This should never happen\n      return { key, presence: 'absent' };\n    }\n  }\n\n  private async getFetchUrl(key: string) {\n    const baseUrl = await this.discoveryApi.getBaseUrl('user-settings');\n    const encodedNamespace = encodeURIComponent(this.namespace);\n    const encodedKey = encodeURIComponent(key);\n    return `${baseUrl}/buckets/${encodedNamespace}/keys/${encodedKey}`;\n  }\n\n  private async notifyChanges<T extends JsonValue>(\n    snapshot: StorageValueSnapshot<T>,\n  ) {\n    for (const subscription of this.subscribers) {\n      try {\n        subscription.next(snapshot);\n      } catch {\n        // ignore\n      }\n    }\n  }\n\n  private async isSignedIn(): Promise<boolean> {\n    try {\n      const credentials = await this.identityApi.getCredentials();\n      return credentials?.token ? true : false;\n    } catch {\n      return false;\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport SettingsIcon from '@material-ui/icons/Settings';\nimport { settingsRouteRef } from '../plugin';\nimport { SidebarItem } from '@backstage/core-components';\nimport { useRouteRef, IconComponent } from '@backstage/core-plugin-api';\n\n/** @public */\nexport const Settings = (props: { icon?: IconComponent }) => {\n  const routePath = useRouteRef(settingsRouteRef);\n  const Icon = props.icon ? props.icon : SettingsIcon;\n  return <SidebarItem text=\"Settings\" to={routePath()} icon={Icon} />;\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React, { PropsWithChildren } from 'react';\nimport { attachComponentData } from '@backstage/core-plugin-api';\nimport {\n  LAYOUT_ROUTE_DATA_KEY,\n  SettingsLayout,\n} from '../SettingsLayout/SettingsLayout';\n\n/** @public @deprecated Use SettingsLayout.Route approach instead */\nexport const USER_SETTINGS_TAB_KEY = LAYOUT_ROUTE_DATA_KEY;\n\n/** @public @deprecated Use SettingsLayoutRouteProps instead */\nexport type UserSettingsTabProps = PropsWithChildren<{\n  /**\n   * The path to the tab in the settings route\n   * @example `/settings/advanced`\n   */\n  path: string;\n  /** The title of the tab. It will also reflect in the document title when the tab is active */\n  title: string;\n}>;\n\n/**\n * Renders a tab inside the settings page\n * @param props - Component props\n * @public\n * @deprecated Use SettingsLayout.Route instead\n */\nexport const UserSettingsTab = (props: UserSettingsTabProps) => (\n  <SettingsLayout.Route path={props.path} title={props.title}>\n    <>props.children</>\n  </SettingsLayout.Route>\n);\n\nattachComponentData(UserSettingsTab, USER_SETTINGS_TAB_KEY, 'UserSettingsTab');\n"],"names":[],"mappings":"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"}