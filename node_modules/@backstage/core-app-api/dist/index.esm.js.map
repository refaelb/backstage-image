{"version":3,"file":"index.esm.js","sources":["../src/apis/system/ApiAggregator.ts","../src/apis/system/ApiProvider.tsx","../src/apis/system/ApiResolver.ts","../src/apis/system/ApiFactoryRegistry.ts","../src/lib/loginPopup.ts","../src/lib/AuthConnector/DefaultAuthConnector.ts","../src/lib/AuthConnector/DirectAuthConnector.ts","../src/lib/AuthSessionManager/common.ts","../src/lib/subjects.ts","../src/lib/AuthSessionManager/SessionStateTracker.ts","../src/lib/AuthSessionManager/RefreshingAuthSessionManager.ts","../src/lib/AuthSessionManager/StaticAuthSessionManager.ts","../src/lib/AuthSessionManager/AuthSessionStore.ts","../src/apis/implementations/auth/oauth2/OAuth2.ts","../src/apis/implementations/auth/github/GithubAuth.ts","../src/apis/implementations/auth/gitlab/GitlabAuth.ts","../src/apis/implementations/auth/google/GoogleAuth.ts","../src/apis/implementations/auth/okta/OktaAuth.ts","../src/apis/implementations/auth/saml/types.ts","../src/apis/implementations/auth/saml/SamlAuth.ts","../src/apis/implementations/auth/microsoft/MicrosoftAuth.ts","../src/apis/implementations/auth/onelogin/OneLoginAuth.ts","../src/apis/implementations/auth/bitbucket/BitbucketAuth.ts","../src/apis/implementations/auth/bitbucketServer/BitbucketServerAuth.ts","../src/apis/implementations/auth/atlassian/AtlassianAuth.ts","../src/apis/implementations/AlertApi/AlertApiForwarder.ts","../src/apis/implementations/AnalyticsApi/MultipleAnalyticsApi.ts","../src/apis/implementations/AnalyticsApi/NoOpAnalyticsApi.ts","../src/apis/implementations/AppThemeApi/AppThemeSelector.ts","../src/apis/implementations/DiscoveryApi/UrlPatternDiscovery.ts","../src/apis/implementations/DiscoveryApi/FrontendHostDiscovery.ts","../src/apis/implementations/ErrorApi/ErrorAlerter.ts","../src/apis/implementations/ErrorApi/ErrorApiForwarder.ts","../src/apis/implementations/ErrorApi/UnhandledErrorForwarder.ts","../src/apis/implementations/FeatureFlagsApi/LocalStorageFeatureFlags.tsx","../src/apis/implementations/FetchApi/createFetchApi.ts","../src/apis/implementations/FetchApi/IdentityAuthInjectorFetchMiddleware.ts","../src/apis/implementations/FetchApi/PluginProtocolResolverFetchMiddleware.ts","../src/apis/implementations/FetchApi/FetchMiddlewares.ts","../src/apis/implementations/OAuthRequestApi/OAuthPendingRequests.ts","../src/apis/implementations/OAuthRequestApi/OAuthRequestManager.ts","../src/apis/implementations/StorageApi/WebStorage.ts","../src/app/InternalAppContext.ts","../src/app/isReactRouterBeta.tsx","../src/routing/RouteTracker.tsx","../src/app/AppRouter.tsx","../src/extensions/traversal.ts","../src/plugins/collectors.ts","../src/routing/FeatureFlagged.tsx","../src/routing/collectors.tsx","../src/routing/types.ts","../src/routing/helpers.ts","../src/routing/RouteResolver.ts","../src/routing/RoutingProvider.tsx","../src/routing/validation.ts","../src/app/AppContext.tsx","../src/apis/implementations/IdentityApi/AppIdentityProxy.ts","../src/app/AppThemeProvider.tsx","../src/app/defaultConfigLoader.ts","../src/apis/system/ApiRegistry.ts","../src/app/resolveRouteBindings.ts","../src/apis/implementations/AppLanguageApi/AppLanguageSelector.ts","../../core-plugin-api/src/translation/TranslationResource.ts","../../core-plugin-api/src/translation/TranslationRef.ts","../src/apis/implementations/TranslationApi/I18nextTranslationApi.ts","../src/app/overrideBaseUrlConfigs.ts","../src/app/AppManager.tsx","../src/app/createSpecializedApp.tsx","../src/routing/FlatRoutes.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiRef, ApiHolder } from '@backstage/core-plugin-api';\n\n/**\n * An ApiHolder that queries multiple other holders from for\n * an Api implementation, returning the first one encountered..\n */\nexport class ApiAggregator implements ApiHolder {\n  private readonly holders: ApiHolder[];\n\n  constructor(...holders: ApiHolder[]) {\n    this.holders = holders;\n  }\n\n  get<T>(apiRef: ApiRef<T>): T | undefined {\n    for (const holder of this.holders) {\n      const api = holder.get(apiRef);\n      if (api) {\n        return api;\n      }\n    }\n    return undefined;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useContext, ReactNode, PropsWithChildren } from 'react';\nimport PropTypes from 'prop-types';\nimport { ApiHolder } from '@backstage/core-plugin-api';\nimport { ApiAggregator } from './ApiAggregator';\nimport {\n  createVersionedValueMap,\n  createVersionedContext,\n} from '@backstage/version-bridge';\n\n/**\n * Prop types for the ApiProvider component.\n * @public\n */\nexport type ApiProviderProps = {\n  apis: ApiHolder;\n  children: ReactNode;\n};\n\nconst ApiContext = createVersionedContext<{ 1: ApiHolder }>('api-context');\n\n/**\n * Provides an {@link @backstage/core-plugin-api#ApiHolder} for consumption in\n * the React tree.\n *\n * @public\n */\nexport const ApiProvider = (props: PropsWithChildren<ApiProviderProps>) => {\n  const { apis, children } = props;\n  const parentHolder = useContext(ApiContext)?.atVersion(1);\n  const holder = parentHolder ? new ApiAggregator(apis, parentHolder) : apis;\n\n  return (\n    <ApiContext.Provider\n      value={createVersionedValueMap({ 1: holder })}\n      children={children}\n    />\n  );\n};\n\nApiProvider.propTypes = {\n  apis: PropTypes.shape({ get: PropTypes.func.isRequired }).isRequired,\n  children: PropTypes.node,\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiRef,\n  ApiHolder,\n  AnyApiRef,\n  TypesToApiRefs,\n} from '@backstage/core-plugin-api';\nimport { ApiFactoryHolder } from './types';\n\n/**\n * Handles the actual on-demand instantiation and memoization of APIs out of\n * an {@link ApiFactoryHolder}.\n *\n * @public\n */\nexport class ApiResolver implements ApiHolder {\n  /**\n   * Validate factories by making sure that each of the apis can be created\n   * without hitting any circular dependencies.\n   */\n  static validateFactories(\n    factories: ApiFactoryHolder,\n    apis: Iterable<AnyApiRef>,\n  ) {\n    for (const api of apis) {\n      const heap = [api];\n      const allDeps = new Set<AnyApiRef>();\n\n      while (heap.length) {\n        const apiRef = heap.shift()!;\n        const factory = factories.get(apiRef);\n        if (!factory) {\n          continue;\n        }\n\n        for (const dep of Object.values(factory.deps)) {\n          if (dep.id === api.id) {\n            throw new Error(`Circular dependency of api factory for ${api}`);\n          }\n          if (!allDeps.has(dep)) {\n            allDeps.add(dep);\n            heap.push(dep);\n          }\n        }\n      }\n    }\n  }\n\n  private readonly apis = new Map<string, unknown>();\n\n  constructor(private readonly factories: ApiFactoryHolder) {}\n\n  get<T>(ref: ApiRef<T>): T | undefined {\n    return this.load(ref);\n  }\n\n  private load<T>(ref: ApiRef<T>, loading: AnyApiRef[] = []): T | undefined {\n    const impl = this.apis.get(ref.id);\n    if (impl) {\n      return impl as T;\n    }\n\n    const factory = this.factories.get(ref);\n    if (!factory) {\n      return undefined;\n    }\n\n    if (loading.includes(factory.api)) {\n      throw new Error(`Circular dependency of api factory for ${factory.api}`);\n    }\n\n    const deps = this.loadDeps(ref, factory.deps, [...loading, factory.api]);\n    const api = factory.factory(deps);\n    this.apis.set(ref.id, api);\n    return api as T;\n  }\n\n  private loadDeps<T>(\n    dependent: ApiRef<unknown>,\n    apis: TypesToApiRefs<T>,\n    loading: AnyApiRef[],\n  ): T {\n    const impls = {} as T;\n\n    for (const key in apis) {\n      if (apis.hasOwnProperty(key)) {\n        const ref = apis[key];\n\n        const api = this.load(ref, loading);\n        if (!api) {\n          throw new Error(\n            `No API factory available for dependency ${ref} of dependent ${dependent}`,\n          );\n        }\n        impls[key] = api;\n      }\n    }\n\n    return impls;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiFactoryHolder } from './types';\nimport {\n  ApiRef,\n  ApiFactory,\n  AnyApiRef,\n  AnyApiFactory,\n} from '@backstage/core-plugin-api';\n\n/**\n * Scope type when registering API factories.\n * @public\n */\nexport type ApiFactoryScope =\n  | 'default' // Default factories registered by core and plugins\n  | 'app' // Factories registered in the app, overriding default ones\n  | 'static'; // APIs that can't be overridden, e.g. config\n\nenum ScopePriority {\n  default = 10,\n  app = 50,\n  static = 100,\n}\n\ntype FactoryTuple = {\n  priority: number;\n  factory: AnyApiFactory;\n};\n\n/**\n * ApiFactoryRegistry is an ApiFactoryHolder implementation that enables\n * registration of API Factories with different scope.\n *\n * Each scope has an assigned priority, where factories registered with\n * higher priority scopes override ones with lower priority.\n *\n * @public\n */\nexport class ApiFactoryRegistry implements ApiFactoryHolder {\n  private readonly factories = new Map<string, FactoryTuple>();\n\n  /**\n   * Register a new API factory. Returns true if the factory was added\n   * to the registry.\n   *\n   * A factory will not be added to the registry if there is already\n   * an existing factory with the same or higher priority.\n   */\n  register<Api, Impl extends Api, Deps extends { [name in string]: unknown }>(\n    scope: ApiFactoryScope,\n    factory: ApiFactory<Api, Impl, Deps>,\n  ) {\n    const priority = ScopePriority[scope];\n    const existing = this.factories.get(factory.api.id);\n    if (existing && existing.priority >= priority) {\n      return false;\n    }\n\n    this.factories.set(factory.api.id, { priority, factory });\n    return true;\n  }\n\n  get<T>(\n    api: ApiRef<T>,\n  ): ApiFactory<T, T, { [x: string]: unknown }> | undefined {\n    const tuple = this.factories.get(api.id);\n    if (!tuple) {\n      return undefined;\n    }\n    return tuple.factory as ApiFactory<T, T, { [x: string]: unknown }>;\n  }\n\n  getAllApis(): Set<AnyApiRef> {\n    const refs = new Set<AnyApiRef>();\n    for (const { factory } of this.factories.values()) {\n      refs.add(factory.api);\n    }\n    return refs;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Options used to open a login popup.\n */\nexport type LoginPopupOptions = {\n  /**\n   * The URL that the auth popup should point to\n   */\n  url: string;\n\n  /**\n   * The name of the popup, as in second argument to window.open\n   */\n  name: string;\n\n  /**\n   * The origin of the final popup page that will post a message to this window.\n   */\n  origin: string;\n\n  /**\n   * The width of the popup in pixels, defaults to 500\n   */\n  width?: number;\n\n  /**\n   * The height of the popup in pixels, defaults to 700\n   */\n  height?: number;\n};\n\ntype AuthResult =\n  | {\n      type: 'authorization_response';\n      response: unknown;\n    }\n  | {\n      type: 'authorization_response';\n      error: {\n        name: string;\n        message: string;\n      };\n    };\n\n/**\n * Show a popup pointing to a URL that starts an auth flow. Implementing the receiving\n * end of the postMessage mechanism outlined in https://tools.ietf.org/html/draft-sakimura-oauth-wmrm-00\n *\n * The redirect handler of the flow should use postMessage to communicate back\n * to the app window. The message posted to the app must match the AuthResult type.\n *\n * The returned promise resolves to the response of the message that was posted from the auth popup.\n */\nexport function showLoginPopup(options: LoginPopupOptions): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const width = options.width || 500;\n    const height = options.height || 700;\n    const left = window.screen.width / 2 - width / 2;\n    const top = window.screen.height / 2 - height / 2;\n\n    const popup = window.open(\n      options.url,\n      options.name,\n      `menubar=no,location=no,resizable=no,scrollbars=no,status=no,width=${width},height=${height},top=${top},left=${left}`,\n    );\n\n    let targetOrigin = '';\n\n    if (!popup || typeof popup.closed === 'undefined' || popup.closed) {\n      const error = new Error('Failed to open auth popup.');\n      error.name = 'PopupRejectedError';\n      reject(error);\n      return;\n    }\n\n    const messageListener = (event: MessageEvent) => {\n      if (event.source !== popup) {\n        return;\n      }\n      if (event.origin !== options.origin) {\n        return;\n      }\n      const { data } = event;\n\n      if (data.type === 'config_info') {\n        targetOrigin = data.targetOrigin;\n        return;\n      }\n\n      if (data.type !== 'authorization_response') {\n        return;\n      }\n      const authResult = data as AuthResult;\n\n      if ('error' in authResult) {\n        const error = new Error(authResult.error.message);\n        error.name = authResult.error.name;\n        // TODO: proper error type\n        // error.extra = authResult.error.extra;\n        reject(error);\n      } else {\n        resolve(authResult.response);\n      }\n      done();\n    };\n\n    const intervalId = setInterval(() => {\n      if (popup.closed) {\n        const errMessage = `Login failed, ${\n          targetOrigin && targetOrigin !== window.location.origin\n            ? `Incorrect app origin, expected ${targetOrigin}`\n            : 'popup was closed'\n        }`;\n        const error = new Error(errMessage);\n        error.name = 'PopupClosedError';\n        reject(error);\n        done();\n      }\n    }, 100);\n\n    function done() {\n      window.removeEventListener('message', messageListener);\n      clearInterval(intervalId);\n    }\n\n    window.addEventListener('message', messageListener);\n  });\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  AuthProviderInfo,\n  ConfigApi,\n  DiscoveryApi,\n  OAuthRequestApi,\n  OAuthRequester,\n} from '@backstage/core-plugin-api';\nimport { showLoginPopup } from '../loginPopup';\nimport { AuthConnector, CreateSessionOptions, PopupOptions } from './types';\n\nlet warned = false;\n\ntype Options<AuthSession> = {\n  /**\n   * DiscoveryApi instance used to locate the auth backend endpoint.\n   */\n  discoveryApi: DiscoveryApi;\n  /**\n   * Environment hint passed on to auth backend, for example 'production' or 'development'\n   */\n  environment: string;\n  /**\n   * Information about the auth provider to be shown to the user.\n   * The ID Must match the backend auth plugin configuration, for example 'google'.\n   */\n  provider: AuthProviderInfo;\n  /**\n   * API used to instantiate an auth requester.\n   */\n  oauthRequestApi: OAuthRequestApi;\n  /**\n   * Function used to join together a set of scopes, defaults to joining with a space character.\n   */\n  joinScopes?: (scopes: Set<string>) => string;\n  /**\n   * Function used to transform an auth response into the session type.\n   */\n  sessionTransform?(response: any): AuthSession | Promise<AuthSession>;\n  /**\n   * ConfigApi instance used to configure authentication flow of pop-up or redirect.\n   */\n  configApi?: ConfigApi;\n  /**\n   * Options used to configure auth popup\n   */\n  popupOptions?: PopupOptions;\n};\n\nfunction defaultJoinScopes(scopes: Set<string>) {\n  return [...scopes].join(' ');\n}\n\n/**\n * DefaultAuthConnector is the default auth connector in Backstage. It talks to the\n * backend auth plugin through the standardized API, and requests user permission\n * via the OAuthRequestApi.\n */\nexport class DefaultAuthConnector<AuthSession>\n  implements AuthConnector<AuthSession>\n{\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly environment: string;\n  private readonly provider: AuthProviderInfo;\n  private readonly joinScopesFunc: (scopes: Set<string>) => string;\n  private readonly authRequester: OAuthRequester<AuthSession>;\n  private readonly sessionTransform: (response: any) => Promise<AuthSession>;\n  private readonly enableExperimentalRedirectFlow: boolean;\n  private readonly popupOptions: PopupOptions | undefined;\n  constructor(options: Options<AuthSession>) {\n    const {\n      configApi,\n      discoveryApi,\n      environment,\n      provider,\n      joinScopes = defaultJoinScopes,\n      oauthRequestApi,\n      sessionTransform = id => id,\n      popupOptions,\n    } = options;\n\n    if (!warned && !configApi) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        'DEPRECATION WARNING: Authentication providers require a configApi instance to configure the authentication flow. Please provide one to the authentication provider constructor.',\n      );\n      warned = true;\n    }\n\n    this.enableExperimentalRedirectFlow = configApi\n      ? configApi.getOptionalBoolean('enableExperimentalRedirectFlow') ?? false\n      : false;\n\n    this.authRequester = oauthRequestApi.createAuthRequester({\n      provider,\n      onAuthRequest: async scopes => {\n        if (!this.enableExperimentalRedirectFlow) {\n          return this.showPopup(scopes);\n        }\n        return this.executeRedirect(scopes);\n      },\n    });\n\n    this.discoveryApi = discoveryApi;\n    this.environment = environment;\n    this.provider = provider;\n    this.joinScopesFunc = joinScopes;\n    this.sessionTransform = sessionTransform;\n    this.popupOptions = popupOptions;\n  }\n\n  async createSession(options: CreateSessionOptions): Promise<AuthSession> {\n    if (options.instantPopup) {\n      if (this.enableExperimentalRedirectFlow) {\n        return this.executeRedirect(options.scopes);\n      }\n      return this.showPopup(options.scopes);\n    }\n    return this.authRequester(options.scopes);\n  }\n\n  async refreshSession(scopes?: Set<string>): Promise<any> {\n    const res = await fetch(\n      await this.buildUrl('/refresh', {\n        optional: true,\n        ...(scopes && { scope: this.joinScopesFunc(scopes) }),\n      }),\n      {\n        headers: {\n          'x-requested-with': 'XMLHttpRequest',\n        },\n        credentials: 'include',\n      },\n    ).catch(error => {\n      throw new Error(`Auth refresh request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(\n        `Auth refresh request failed, ${res.statusText}`,\n      );\n      error.status = res.status;\n      throw error;\n    }\n\n    const authInfo = await res.json();\n\n    if (authInfo.error) {\n      const error = new Error(authInfo.error.message);\n      if (authInfo.error.name) {\n        error.name = authInfo.error.name;\n      }\n      throw error;\n    }\n    return await this.sessionTransform(authInfo);\n  }\n\n  async removeSession(): Promise<void> {\n    const res = await fetch(await this.buildUrl('/logout'), {\n      method: 'POST',\n      headers: {\n        'x-requested-with': 'XMLHttpRequest',\n      },\n      credentials: 'include',\n    }).catch(error => {\n      throw new Error(`Logout request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(`Logout request failed, ${res.statusText}`);\n      error.status = res.status;\n      throw error;\n    }\n  }\n\n  private async showPopup(scopes: Set<string>): Promise<AuthSession> {\n    const scope = this.joinScopesFunc(scopes);\n    const popupUrl = await this.buildUrl('/start', {\n      scope,\n      origin: window.location.origin,\n      flow: 'popup',\n    });\n\n    const width = this.popupOptions?.size?.fullscreen\n      ? window.screen.width\n      : this.popupOptions?.size?.width || 450;\n\n    const height = this.popupOptions?.size?.fullscreen\n      ? window.screen.height\n      : this.popupOptions?.size?.height || 730;\n\n    const payload = await showLoginPopup({\n      url: popupUrl,\n      name: `${this.provider.title} Login`,\n      origin: new URL(popupUrl).origin,\n      width,\n      height,\n    });\n\n    return await this.sessionTransform(payload);\n  }\n\n  private async executeRedirect(scopes: Set<string>): Promise<AuthSession> {\n    const scope = this.joinScopesFunc(scopes);\n    // redirect to auth api\n    window.location.href = await this.buildUrl('/start', {\n      scope,\n      origin: window.location.origin,\n      redirectUrl: window.location.href,\n      flow: 'redirect',\n    });\n    // return a promise that never resolves\n    return new Promise(() => {});\n  }\n\n  private async buildUrl(\n    path: string,\n    query?: { [key: string]: string | boolean | undefined },\n  ): Promise<string> {\n    const baseUrl = await this.discoveryApi.getBaseUrl('auth');\n    const queryString = this.buildQueryString({\n      ...query,\n      env: this.environment,\n    });\n\n    return `${baseUrl}/${this.provider.id}${path}${queryString}`;\n  }\n\n  private buildQueryString(query?: {\n    [key: string]: string | boolean | undefined;\n  }): string {\n    if (!query) {\n      return '';\n    }\n\n    const queryString = Object.entries<string | boolean | undefined>(query)\n      .map(([key, value]) => {\n        if (typeof value === 'string') {\n          return `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n        } else if (value) {\n          return encodeURIComponent(key);\n        }\n        return undefined;\n      })\n      .filter(Boolean)\n      .join('&');\n\n    if (!queryString) {\n      return '';\n    }\n    return `?${queryString}`;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { AuthProviderInfo, DiscoveryApi } from '@backstage/core-plugin-api';\nimport { showLoginPopup } from '../loginPopup';\n\ntype Options = {\n  discoveryApi: DiscoveryApi;\n  environment?: string;\n  provider: AuthProviderInfo;\n};\nexport class DirectAuthConnector<DirectAuthResponse> {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly environment: string | undefined;\n  private readonly provider: AuthProviderInfo;\n\n  constructor(options: Options) {\n    const { discoveryApi, environment, provider } = options;\n\n    this.discoveryApi = discoveryApi;\n    this.environment = environment;\n    this.provider = provider;\n  }\n\n  async createSession(): Promise<DirectAuthResponse> {\n    const popupUrl = await this.buildUrl('/start');\n    const payload = await showLoginPopup({\n      url: popupUrl,\n      name: `${this.provider.title} Login`,\n      origin: new URL(popupUrl).origin,\n      width: 450,\n      height: 730,\n    });\n\n    return {\n      ...payload,\n      id: payload.profile.email,\n    };\n  }\n\n  async refreshSession(): Promise<any> {}\n\n  async removeSession(): Promise<void> {\n    const res = await fetch(await this.buildUrl('/logout'), {\n      method: 'POST',\n      headers: {\n        'x-requested-with': 'XMLHttpRequest',\n      },\n      credentials: 'include',\n    }).catch(error => {\n      throw new Error(`Logout request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(`Logout request failed, ${res.statusText}`);\n      error.status = res.status;\n      throw error;\n    }\n  }\n\n  private async buildUrl(path: string): Promise<string> {\n    const baseUrl = await this.discoveryApi.getBaseUrl('auth');\n    return `${baseUrl}/${this.provider.id}${path}?env=${this.environment}`;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { SessionScopesFunc } from './types';\n\nexport function hasScopes(\n  searched: Set<string>,\n  searchFor: Set<string>,\n): boolean {\n  for (const scope of searchFor) {\n    if (!searched.has(scope)) {\n      return false;\n    }\n  }\n  return true;\n}\n\ntype ScopeHelperOptions<T> = {\n  sessionScopes: SessionScopesFunc<T> | undefined;\n  defaultScopes?: Set<string>;\n};\n\nexport class SessionScopeHelper<T> {\n  constructor(private readonly options: ScopeHelperOptions<T>) {}\n\n  sessionExistsAndHasScope(\n    session: T | undefined,\n    scopes?: Set<string>,\n  ): boolean {\n    if (!session) {\n      return false;\n    }\n    if (!scopes) {\n      return true;\n    }\n    if (this.options.sessionScopes === undefined) {\n      return true;\n    }\n    const sessionScopes = this.options.sessionScopes(session);\n    return hasScopes(sessionScopes, scopes);\n  }\n\n  getExtendedScope(session: T | undefined, scopes?: Set<string>) {\n    const newScope = new Set(this.options.defaultScopes);\n    if (session && this.options.sessionScopes !== undefined) {\n      const sessionScopes = this.options.sessionScopes(session);\n      for (const scope of sessionScopes) {\n        newScope.add(scope);\n      }\n    }\n    if (scopes) {\n      for (const scope of scopes) {\n        newScope.add(scope);\n      }\n    }\n    return newScope;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Observable } from '@backstage/types';\nimport ObservableImpl from 'zen-observable';\n\n// TODO(Rugvip): These are stopgap and probably incomplete implementations of subjects.\n// If we add a more complete Observables library they should be replaced.\n\n/**\n * A basic implementation of ReactiveX publish subjects.\n *\n * A subject is a convenient way to create an observable when you want\n * to fan out a single value to all subscribers.\n *\n * See http://reactivex.io/documentation/subject.html\n */\nexport class PublishSubject<T>\n  implements Observable<T>, ZenObservable.SubscriptionObserver<T>\n{\n  private isClosed = false;\n  private terminatingError?: Error;\n\n  private readonly observable = new ObservableImpl<T>(subscriber => {\n    if (this.isClosed) {\n      if (this.terminatingError) {\n        subscriber.error(this.terminatingError);\n      } else {\n        subscriber.complete();\n      }\n      return () => {};\n    }\n\n    this.subscribers.add(subscriber);\n    return () => {\n      this.subscribers.delete(subscriber);\n    };\n  });\n\n  private readonly subscribers = new Set<\n    ZenObservable.SubscriptionObserver<T>\n  >();\n\n  [Symbol.observable]() {\n    return this;\n  }\n\n  get closed() {\n    return this.isClosed;\n  }\n\n  next(value: T) {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.subscribers.forEach(subscriber => subscriber.next(value));\n  }\n\n  error(error: Error) {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.isClosed = true;\n    this.terminatingError = error;\n    this.subscribers.forEach(subscriber => subscriber.error(error));\n  }\n\n  complete() {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.isClosed = true;\n    this.subscribers.forEach(subscriber => subscriber.complete());\n  }\n\n  subscribe(observer: ZenObservable.Observer<T>): ZenObservable.Subscription;\n  subscribe(\n    onNext: (value: T) => void,\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription;\n  subscribe(\n    onNext: ZenObservable.Observer<T> | ((value: T) => void),\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription {\n    const observer =\n      typeof onNext === 'function'\n        ? {\n            next: onNext,\n            error: onError,\n            complete: onComplete,\n          }\n        : onNext;\n\n    return this.observable.subscribe(observer);\n  }\n}\n\n/**\n * A basic implementation of ReactiveX behavior subjects.\n *\n * A subject is a convenient way to create an observable when you want\n * to fan out a single value to all subscribers.\n *\n * The BehaviorSubject will emit the most recently emitted value or error\n * whenever a new observer subscribes to the subject.\n *\n * See http://reactivex.io/documentation/subject.html\n */\n\nexport class BehaviorSubject<T>\n  implements Observable<T>, ZenObservable.SubscriptionObserver<T>\n{\n  private isClosed: boolean;\n  private currentValue: T;\n  private terminatingError: Error | undefined;\n  private readonly observable: Observable<T>;\n\n  constructor(value: T) {\n    this.isClosed = false;\n    this.currentValue = value;\n    this.terminatingError = undefined;\n    this.observable = new ObservableImpl<T>(subscriber => {\n      if (this.isClosed) {\n        if (this.terminatingError) {\n          subscriber.error(this.terminatingError);\n        } else {\n          subscriber.complete();\n        }\n        return () => {};\n      }\n\n      subscriber.next(this.currentValue);\n\n      this.subscribers.add(subscriber);\n      return () => {\n        this.subscribers.delete(subscriber);\n      };\n    });\n  }\n\n  private readonly subscribers = new Set<\n    ZenObservable.SubscriptionObserver<T>\n  >();\n\n  [Symbol.observable]() {\n    return this;\n  }\n\n  get closed() {\n    return this.isClosed;\n  }\n\n  next(value: T) {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.currentValue = value;\n    this.subscribers.forEach(subscriber => subscriber.next(value));\n  }\n\n  error(error: Error) {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.isClosed = true;\n    this.terminatingError = error;\n    this.subscribers.forEach(subscriber => subscriber.error(error));\n  }\n\n  complete() {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.isClosed = true;\n    this.subscribers.forEach(subscriber => subscriber.complete());\n  }\n\n  subscribe(observer: ZenObservable.Observer<T>): ZenObservable.Subscription;\n  subscribe(\n    onNext: (value: T) => void,\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription;\n  subscribe(\n    onNext: ZenObservable.Observer<T> | ((value: T) => void),\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription {\n    const observer =\n      typeof onNext === 'function'\n        ? {\n            next: onNext,\n            error: onError,\n            complete: onComplete,\n          }\n        : onNext;\n\n    return this.observable.subscribe(observer);\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BehaviorSubject } from '../subjects';\nimport { SessionState } from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\n\nexport class SessionStateTracker {\n  private readonly subject = new BehaviorSubject<SessionState>(\n    SessionState.SignedOut,\n  );\n\n  private signedIn: boolean = false;\n\n  setIsSignedIn(isSignedIn: boolean) {\n    if (this.signedIn !== isSignedIn) {\n      this.signedIn = isSignedIn;\n      this.subject.next(\n        this.signedIn ? SessionState.SignedIn : SessionState.SignedOut,\n      );\n    }\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  SessionManager,\n  SessionScopesFunc,\n  SessionShouldRefreshFunc,\n  GetSessionOptions,\n} from './types';\nimport { AuthConnector } from '../AuthConnector';\nimport { SessionScopeHelper, hasScopes } from './common';\nimport { SessionStateTracker } from './SessionStateTracker';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  connector: AuthConnector<T>;\n  /** Used to get the scope of the session */\n  sessionScopes: SessionScopesFunc<T>;\n  /** Used to check if the session needs to be refreshed */\n  sessionShouldRefresh: SessionShouldRefreshFunc<T>;\n  /** The default scopes that should always be present in a session, defaults to none. */\n  defaultScopes?: Set<string>;\n};\n\n/**\n * RefreshingAuthSessionManager manages an underlying session that has\n * and expiration time and needs to be refreshed periodically.\n */\nexport class RefreshingAuthSessionManager<T> implements SessionManager<T> {\n  private readonly connector: AuthConnector<T>;\n  private readonly helper: SessionScopeHelper<T>;\n  private readonly sessionScopesFunc: SessionScopesFunc<T>;\n  private readonly sessionShouldRefreshFunc: SessionShouldRefreshFunc<T>;\n  private readonly stateTracker = new SessionStateTracker();\n\n  private refreshPromise?: Promise<T>;\n  private currentSession: T | undefined;\n\n  constructor(options: Options<T>) {\n    const {\n      connector,\n      defaultScopes = new Set(),\n      sessionScopes,\n      sessionShouldRefresh,\n    } = options;\n\n    this.connector = connector;\n    this.sessionScopesFunc = sessionScopes;\n    this.sessionShouldRefreshFunc = sessionShouldRefresh;\n    this.helper = new SessionScopeHelper({ sessionScopes, defaultScopes });\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    if (\n      this.helper.sessionExistsAndHasScope(this.currentSession, options.scopes)\n    ) {\n      const shouldRefresh = this.sessionShouldRefreshFunc(this.currentSession!);\n      if (!shouldRefresh) {\n        return this.currentSession!;\n      }\n\n      try {\n        const refreshedSession = await this.collapsedSessionRefresh(\n          options.scopes,\n        );\n        const currentScopes = this.sessionScopesFunc(this.currentSession!);\n        const refreshedScopes = this.sessionScopesFunc(refreshedSession);\n        if (hasScopes(refreshedScopes, currentScopes)) {\n          this.currentSession = refreshedSession;\n        }\n        return refreshedSession;\n      } catch (error) {\n        if (options.optional) {\n          return undefined;\n        }\n        throw error;\n      }\n    }\n\n    // The user may still have a valid refresh token in their cookies. Attempt to\n    // initiate a fresh session through the backend using that refresh token.\n    //\n    // We skip this check if an instant login popup is requested, as we need to\n    // stay in a synchronous call stack from the user interaction. The downside\n    // is that the user will sometimes be requested to log in even if they\n    // already had an existing session.\n    if (!this.currentSession && !options.instantPopup) {\n      try {\n        const newSession = await this.collapsedSessionRefresh(options.scopes);\n        this.currentSession = newSession;\n        // The session might not have the scopes requested so go back and check again\n        return this.getSession(options);\n      } catch {\n        // If the refresh attempt fails we assume we don't have a session, so continue to create one.\n      }\n    }\n\n    // If we continue here we will show a popup, so exit if this is an optional session request.\n    if (options.optional) {\n      return undefined;\n    }\n\n    // We can call authRequester multiple times, the returned session will contain all requested scopes.\n    this.currentSession = await this.connector.createSession({\n      ...options,\n      scopes: this.helper.getExtendedScope(this.currentSession, options.scopes),\n    });\n    this.stateTracker.setIsSignedIn(true);\n    return this.currentSession;\n  }\n\n  async removeSession() {\n    this.currentSession = undefined;\n    await this.connector.removeSession();\n    this.stateTracker.setIsSignedIn(false);\n  }\n\n  sessionState$() {\n    return this.stateTracker.sessionState$();\n  }\n\n  private async collapsedSessionRefresh(scopes?: Set<string>): Promise<T> {\n    if (this.refreshPromise) {\n      return this.refreshPromise;\n    }\n\n    this.refreshPromise = this.connector.refreshSession(\n      this.helper.getExtendedScope(this.currentSession, scopes),\n    );\n\n    try {\n      const session = await this.refreshPromise;\n      this.stateTracker.setIsSignedIn(true);\n      return session;\n    } finally {\n      delete this.refreshPromise;\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { MutableSessionManager, GetSessionOptions } from './types';\nimport { AuthConnector } from '../AuthConnector';\nimport { SessionScopeHelper } from './common';\nimport { SessionStateTracker } from './SessionStateTracker';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  connector: AuthConnector<T>;\n  /** Used to get the scope of the session */\n  sessionScopes?: (session: T) => Set<string>;\n  /** The default scopes that should always be present in a session, defaults to none. */\n  defaultScopes?: Set<string>;\n};\n\n/**\n * StaticAuthSessionManager manages an underlying session that does not expire.\n */\nexport class StaticAuthSessionManager<T> implements MutableSessionManager<T> {\n  private readonly connector: AuthConnector<T>;\n  private readonly helper: SessionScopeHelper<T>;\n  private readonly stateTracker = new SessionStateTracker();\n\n  private currentSession: T | undefined;\n\n  constructor(options: Options<T>) {\n    const { connector, defaultScopes = new Set(), sessionScopes } = options;\n\n    this.connector = connector;\n    this.helper = new SessionScopeHelper({ sessionScopes, defaultScopes });\n  }\n\n  setSession(session: T | undefined): void {\n    this.currentSession = session;\n    this.stateTracker.setIsSignedIn(Boolean(session));\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    if (\n      this.helper.sessionExistsAndHasScope(this.currentSession, options.scopes)\n    ) {\n      return this.currentSession;\n    }\n\n    // If we continue here we will show a popup, so exit if this is an optional session request.\n    if (options.optional) {\n      return undefined;\n    }\n\n    // We can call authRequester multiple times, the returned session will contain all requested scopes.\n    this.currentSession = await this.connector.createSession({\n      ...options,\n      scopes: this.helper.getExtendedScope(this.currentSession, options.scopes),\n    });\n    this.stateTracker.setIsSignedIn(true);\n    return this.currentSession;\n  }\n\n  /**\n   * We don't call this.connector.removeSession here, since this session manager\n   * is intended to be static. As such there's no need to hit the remote logout\n   * endpoint - simply discarding the local session state when signing out is\n   * enough.\n   */\n  async removeSession() {\n    this.currentSession = undefined;\n    this.stateTracker.setIsSignedIn(false);\n  }\n\n  sessionState$() {\n    return this.stateTracker.sessionState$();\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ZodSchema } from 'zod';\nimport {\n  MutableSessionManager,\n  SessionScopesFunc,\n  SessionShouldRefreshFunc,\n  GetSessionOptions,\n} from './types';\nimport { SessionScopeHelper } from './common';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  manager: MutableSessionManager<T>;\n  /** Storage key to use to store sessions */\n  storageKey: string;\n  /** The schema used to validate the stored data */\n  schema: ZodSchema<T>;\n  /** Used to get the scope of the session */\n  sessionScopes?: SessionScopesFunc<T>;\n  /** Used to check if the session needs to be refreshed, defaults to never refresh */\n  sessionShouldRefresh?: SessionShouldRefreshFunc<T>;\n};\n\n/**\n * AuthSessionStore decorates another SessionManager with a functionality\n * to store the session in local storage.\n *\n * Session is serialized to JSON with special support for following types: Set.\n */\nexport class AuthSessionStore<T> implements MutableSessionManager<T> {\n  private readonly manager: MutableSessionManager<T>;\n  private readonly storageKey: string;\n  private readonly schema: ZodSchema<T>;\n  private readonly sessionShouldRefreshFunc: SessionShouldRefreshFunc<T>;\n  private readonly helper: SessionScopeHelper<T>;\n\n  constructor(options: Options<T>) {\n    const {\n      manager,\n      storageKey,\n      schema,\n      sessionScopes,\n      sessionShouldRefresh = () => false,\n    } = options;\n\n    this.manager = manager;\n    this.storageKey = storageKey;\n    this.schema = schema;\n    this.sessionShouldRefreshFunc = sessionShouldRefresh;\n    this.helper = new SessionScopeHelper({\n      sessionScopes,\n      defaultScopes: new Set(),\n    });\n  }\n\n  setSession(session: T | undefined): void {\n    this.manager.setSession(session);\n    this.saveSession(session);\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    const { scopes } = options;\n    const session = this.loadSession();\n\n    if (this.helper.sessionExistsAndHasScope(session, scopes)) {\n      const shouldRefresh = this.sessionShouldRefreshFunc(session!);\n\n      if (!shouldRefresh) {\n        this.manager.setSession(session!);\n        return session!;\n      }\n    }\n\n    const newSession = await this.manager.getSession(options);\n    this.saveSession(newSession);\n    return newSession;\n  }\n\n  async removeSession() {\n    localStorage.removeItem(this.storageKey);\n    await this.manager.removeSession();\n  }\n\n  sessionState$() {\n    return this.manager.sessionState$();\n  }\n\n  private loadSession(): T | undefined {\n    try {\n      const sessionJson = localStorage.getItem(this.storageKey);\n      if (sessionJson) {\n        const session = JSON.parse(sessionJson, (_key, value) => {\n          if (value?.__type === 'Set') {\n            return new Set(value.__value);\n          }\n          return value;\n        });\n\n        try {\n          return this.schema.parse(session);\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.log(\n            `Failed to load session from local storage because it did not conform to the expected schema, ${e}`,\n          );\n          throw e;\n        }\n      }\n\n      return undefined;\n    } catch (error) {\n      localStorage.removeItem(this.storageKey);\n      return undefined;\n    }\n  }\n\n  private saveSession(session: T | undefined) {\n    if (session === undefined) {\n      localStorage.removeItem(this.storageKey);\n      return;\n    }\n\n    try {\n      this.schema.parse(session);\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `Failed to save session to local storage because it did not conform to the expected schema, ${e}`,\n      );\n      return;\n    }\n\n    localStorage.setItem(\n      this.storageKey,\n      JSON.stringify(session, (_key, value) => {\n        if (value instanceof Set) {\n          return {\n            __type: 'Set',\n            __value: Array.from(value),\n          };\n        }\n        return value;\n      }),\n    );\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DefaultAuthConnector,\n  PopupOptions,\n} from '../../../../lib/AuthConnector';\nimport { RefreshingAuthSessionManager } from '../../../../lib/AuthSessionManager';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport {\n  AuthRequestOptions,\n  BackstageIdentityResponse,\n  OAuthApi,\n  OpenIdConnectApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  SessionState,\n  SessionApi,\n  BackstageIdentityApi,\n  BackstageUserIdentity,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { OAuth2Session } from './types';\nimport { OAuthApiCreateOptions } from '../types';\n\n/**\n * OAuth2 create options.\n * @public\n */\nexport type OAuth2CreateOptions = OAuthApiCreateOptions & {\n  scopeTransform?: (scopes: string[]) => string[];\n  popupOptions?: PopupOptions;\n};\n\nexport type OAuth2Response = {\n  providerInfo: {\n    accessToken: string;\n    idToken: string;\n    scope: string;\n    expiresInSeconds?: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: {\n    token: string;\n    expiresInSeconds?: number;\n    identity: BackstageUserIdentity;\n  };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'oauth2',\n  title: 'Your Identity Provider',\n  icon: () => null,\n};\n\n/**\n * Implements a generic OAuth2 flow for auth.\n *\n * @public\n */\nexport default class OAuth2\n  implements\n    OAuthApi,\n    OpenIdConnectApi,\n    ProfileInfoApi,\n    BackstageIdentityApi,\n    SessionApi\n{\n  static create(options: OAuth2CreateOptions) {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = [],\n      scopeTransform = x => x,\n      popupOptions,\n    } = options;\n\n    const connector = new DefaultAuthConnector({\n      configApi,\n      discoveryApi,\n      environment,\n      provider,\n      oauthRequestApi: oauthRequestApi,\n      sessionTransform({\n        backstageIdentity,\n        ...res\n      }: OAuth2Response): OAuth2Session {\n        const session: OAuth2Session = {\n          ...res,\n          providerInfo: {\n            idToken: res.providerInfo.idToken,\n            accessToken: res.providerInfo.accessToken,\n            scopes: OAuth2.normalizeScopes(\n              scopeTransform,\n              res.providerInfo.scope,\n            ),\n            expiresAt: res.providerInfo.expiresInSeconds\n              ? new Date(Date.now() + res.providerInfo.expiresInSeconds * 1000)\n              : undefined,\n          },\n        };\n        if (backstageIdentity) {\n          // TODO(Rugvip): This fallback can be removed a few releases after 1.18. It's there to avoid\n          //               breaking deployments that update their frontend before updating their backend.\n          const expInSec =\n            backstageIdentity.expiresInSeconds ??\n            res.providerInfo.expiresInSeconds;\n          session.backstageIdentity = {\n            token: backstageIdentity.token,\n            identity: backstageIdentity.identity,\n            expiresAt: expInSec\n              ? new Date(Date.now() + expInSec * 1000)\n              : undefined,\n          };\n        }\n        return session;\n      },\n      popupOptions,\n    });\n\n    const sessionManager = new RefreshingAuthSessionManager({\n      connector,\n      defaultScopes: new Set(defaultScopes),\n      sessionScopes: (session: OAuth2Session) => session.providerInfo.scopes,\n      sessionShouldRefresh: (session: OAuth2Session) => {\n        // TODO(Rugvip): Optimize to use separate checks for provider vs backstage session expiration\n        let min = Infinity;\n        if (session.providerInfo?.expiresAt) {\n          min = Math.min(\n            min,\n            (session.providerInfo.expiresAt.getTime() - Date.now()) / 1000,\n          );\n        }\n        if (session.backstageIdentity?.expiresAt) {\n          min = Math.min(\n            min,\n            (session.backstageIdentity.expiresAt.getTime() - Date.now()) / 1000,\n          );\n        }\n        return min < 60 * 5;\n      },\n    });\n\n    return new OAuth2({ sessionManager, scopeTransform });\n  }\n\n  private readonly sessionManager: SessionManager<OAuth2Session>;\n  private readonly scopeTransform: (scopes: string[]) => string[];\n\n  private constructor(options: {\n    sessionManager: SessionManager<OAuth2Session>;\n    scopeTransform: (scopes: string[]) => string[];\n  }) {\n    this.sessionManager = options.sessionManager;\n    this.scopeTransform = options.scopeTransform;\n  }\n\n  async signIn() {\n    await this.getAccessToken();\n  }\n\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  async getAccessToken(\n    scope?: string | string[],\n    options?: AuthRequestOptions,\n  ) {\n    const normalizedScopes = OAuth2.normalizeScopes(this.scopeTransform, scope);\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: normalizedScopes,\n    });\n    return session?.providerInfo.accessToken ?? '';\n  }\n\n  async getIdToken(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: new Set(['openid']),\n    });\n    return session?.providerInfo.idToken ?? '';\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentityResponse | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n\n  private static normalizeScopes(\n    scopeTransform: (scopes: string[]) => string[],\n    scopes?: string | string[],\n  ): Set<string> {\n    if (!scopes) {\n      return new Set();\n    }\n\n    const scopeList = Array.isArray(scopes)\n      ? scopes\n      : scopes.split(/[\\s|,]/).filter(Boolean);\n\n    return new Set(scopeTransform(scopeList));\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { githubAuthApiRef } from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\nimport { OAuthApiCreateOptions } from '../types';\n\nconst DEFAULT_PROVIDER = {\n  id: 'github',\n  title: 'GitHub',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to GitHub products.\n *\n * @public\n */\nexport default class GithubAuth {\n  static create(options: OAuthApiCreateOptions): typeof githubAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = ['read:user'],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { gitlabAuthApiRef } from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\nimport { OAuthApiCreateOptions } from '../types';\n\nconst DEFAULT_PROVIDER = {\n  id: 'gitlab',\n  title: 'GitLab',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to GitLab products.\n *\n * @public\n */\nexport default class GitlabAuth {\n  static create(options: OAuthApiCreateOptions): typeof gitlabAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = ['read_user'],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { googleAuthApiRef } from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\nimport { OAuthApiCreateOptions } from '../types';\n\nconst DEFAULT_PROVIDER = {\n  id: 'google',\n  title: 'Google',\n  icon: () => null,\n};\n\nconst SCOPE_PREFIX = 'https://www.googleapis.com/auth/';\n\n/**\n * Implements the OAuth flow to Google products.\n *\n * @public\n */\nexport default class GoogleAuth {\n  static create(options: OAuthApiCreateOptions): typeof googleAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      defaultScopes = [\n        'openid',\n        `${SCOPE_PREFIX}userinfo.email`,\n        `${SCOPE_PREFIX}userinfo.profile`,\n      ],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n      scopeTransform(scopes: string[]) {\n        return scopes.map(scope => {\n          if (scope === 'openid') {\n            return scope;\n          }\n\n          if (scope === 'profile' || scope === 'email') {\n            return `${SCOPE_PREFIX}userinfo.${scope}`;\n          }\n\n          if (scope.startsWith(SCOPE_PREFIX)) {\n            return scope;\n          }\n\n          return `${SCOPE_PREFIX}${scope}`;\n        });\n      },\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { oktaAuthApiRef } from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\nimport { OAuthApiCreateOptions } from '../types';\n\nconst DEFAULT_PROVIDER = {\n  id: 'okta',\n  title: 'Okta',\n  icon: () => null,\n};\n\nconst OKTA_OIDC_SCOPES: Set<String> = new Set([\n  'openid',\n  'profile',\n  'email',\n  'phone',\n  'address',\n  'groups',\n  'offline_access',\n]);\n\nconst OKTA_SCOPE_PREFIX: string = 'okta.';\n\n/**\n * Implements the OAuth flow to Okta products.\n *\n * @public\n */\nexport default class OktaAuth {\n  static create(options: OAuthApiCreateOptions): typeof oktaAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = ['openid', 'email', 'profile', 'offline_access'],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n      scopeTransform(scopes) {\n        return scopes.map(scope => {\n          if (OKTA_OIDC_SCOPES.has(scope)) {\n            return scope;\n          }\n\n          if (scope.startsWith(OKTA_SCOPE_PREFIX)) {\n            return scope;\n          }\n\n          return `${OKTA_SCOPE_PREFIX}${scope}`;\n        });\n      },\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageIdentityResponse,\n  ProfileInfo,\n} from '@backstage/core-plugin-api';\nimport { z } from 'zod';\n\n/** @internal */\nexport type SamlSession = {\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentityResponse;\n};\n\n/** @internal */\nexport const samlSessionSchema: z.ZodSchema<SamlSession> = z.object({\n  profile: z.object({\n    email: z.string().optional(),\n    displayName: z.string().optional(),\n    picture: z.string().optional(),\n  }),\n  backstageIdentity: z.object({\n    token: z.string(),\n    identity: z.object({\n      type: z.literal('user'),\n      userEntityRef: z.string(),\n      ownershipEntityRefs: z.array(z.string()),\n    }),\n  }),\n});\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthRequestOptions,\n  BackstageIdentityApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  SessionApi,\n  SessionState,\n  BackstageIdentityResponse,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { DirectAuthConnector } from '../../../../lib/AuthConnector';\nimport {\n  AuthSessionStore,\n  StaticAuthSessionManager,\n} from '../../../../lib/AuthSessionManager';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport { AuthApiCreateOptions } from '../types';\nimport { SamlSession, samlSessionSchema } from './types';\n\nexport type SamlAuthResponse = {\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentityResponse;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'saml',\n  title: 'SAML',\n  icon: () => null,\n};\n\n/**\n * Implements a general SAML based auth flow.\n *\n * @public\n */\nexport default class SamlAuth\n  implements ProfileInfoApi, BackstageIdentityApi, SessionApi\n{\n  static create(options: AuthApiCreateOptions) {\n    const {\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n    } = options;\n\n    const connector = new DirectAuthConnector<SamlSession>({\n      discoveryApi,\n      environment,\n      provider,\n    });\n\n    const sessionManager = new StaticAuthSessionManager<SamlSession>({\n      connector,\n    });\n\n    const authSessionStore = new AuthSessionStore<SamlSession>({\n      manager: sessionManager,\n      storageKey: `${provider.id}Session`,\n      schema: samlSessionSchema,\n    });\n\n    return new SamlAuth(authSessionStore);\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  private constructor(\n    private readonly sessionManager: SessionManager<SamlSession>,\n  ) {}\n\n  async signIn() {\n    await this.getBackstageIdentity({});\n  }\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentityResponse | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  microsoftAuthApiRef,\n  AuthRequestOptions,\n  AuthProviderInfo,\n  ConfigApi,\n  DiscoveryApi,\n  OAuthRequestApi,\n} from '@backstage/core-plugin-api';\nimport { OAuth2, OAuth2CreateOptions } from '../oauth2';\n\nconst DEFAULT_PROVIDER = {\n  id: 'microsoft',\n  title: 'Microsoft',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to Microsoft products.\n *\n * @public\n */\nexport default class MicrosoftAuth {\n  private oauth2: { [aud: string]: OAuth2 };\n  private configApi: ConfigApi | undefined;\n  private environment: string;\n  private provider: AuthProviderInfo;\n  private oauthRequestApi: OAuthRequestApi;\n  private discoveryApi: DiscoveryApi;\n  private scopeTransform: (scopes: string[]) => string[];\n\n  private static MicrosoftGraphID = '00000003-0000-0000-c000-000000000000';\n\n  static create(options: OAuth2CreateOptions): typeof microsoftAuthApiRef.T {\n    return new MicrosoftAuth(options);\n  }\n  private constructor(options: OAuth2CreateOptions) {\n    const {\n      configApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      discoveryApi,\n      defaultScopes = [\n        'openid',\n        'offline_access',\n        'profile',\n        'email',\n        'User.Read',\n      ],\n      scopeTransform = scopes => scopes.concat('offline_access'),\n    } = options;\n\n    this.configApi = configApi;\n    this.environment = environment;\n    this.provider = provider;\n    this.oauthRequestApi = oauthRequestApi;\n    this.discoveryApi = discoveryApi;\n    this.scopeTransform = scopeTransform;\n\n    this.oauth2 = {\n      [MicrosoftAuth.MicrosoftGraphID]: OAuth2.create({\n        configApi: this.configApi,\n        discoveryApi: this.discoveryApi,\n        oauthRequestApi: this.oauthRequestApi,\n        provider: this.provider,\n        environment: this.environment,\n        scopeTransform: this.scopeTransform,\n        defaultScopes,\n      }),\n    };\n  }\n\n  private microsoftGraph(): OAuth2 {\n    return this.oauth2[MicrosoftAuth.MicrosoftGraphID];\n  }\n\n  private static resourceForScopes(scope: string): Promise<string> {\n    const audiences = [\n      ...new Set(\n        scope\n          .split(' ')\n          .map(MicrosoftAuth.resourceForScope)\n          .filter(aud => aud !== 'openid'),\n      ),\n    ];\n\n    if (audiences.length > 1) {\n      return Promise.reject(\n        new Error(\n          `Requested access token with scopes from multiple Azure resources: ${audiences.join(\n            ', ',\n          )}. Access tokens can only have a single audience.`,\n        ),\n      );\n    }\n    const audience = audiences[0] ?? MicrosoftAuth.MicrosoftGraphID;\n    return Promise.resolve(audience);\n  }\n\n  private static resourceForScope(scope: string): string {\n    const groups = scope.match(/^(?<resourceURI>.*)\\/(?<scp>[^\\/]*)$/)?.groups;\n    if (groups) {\n      const { resourceURI } = groups;\n      const aud = resourceURI.replace(/^api:\\/\\//, '');\n      return aud;\n    }\n    switch (scope) {\n      case 'email':\n      case 'openid':\n      case 'offline_access':\n      case 'profile': {\n        return 'openid';\n      }\n      default:\n        return MicrosoftAuth.MicrosoftGraphID;\n    }\n  }\n\n  async getAccessToken(\n    scope?: string | string[],\n    options?: AuthRequestOptions,\n  ): Promise<string> {\n    const aud =\n      scope === undefined\n        ? MicrosoftAuth.MicrosoftGraphID\n        : await MicrosoftAuth.resourceForScopes(\n            Array.isArray(scope) ? scope.join(' ') : scope,\n          );\n    if (!(aud in this.oauth2)) {\n      this.oauth2[aud] = OAuth2.create({\n        configApi: this.configApi,\n        discoveryApi: this.discoveryApi,\n        oauthRequestApi: this.oauthRequestApi,\n        provider: this.provider,\n        environment: this.environment,\n        scopeTransform: this.scopeTransform,\n      });\n    }\n    return this.oauth2[aud].getAccessToken(scope, options);\n  }\n\n  getIdToken(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getIdToken(options);\n  }\n\n  getProfile(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getProfile(options);\n  }\n\n  getBackstageIdentity(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getBackstageIdentity(options);\n  }\n\n  signIn() {\n    return this.microsoftGraph().signIn();\n  }\n\n  signOut() {\n    return this.microsoftGraph().signOut();\n  }\n\n  sessionState$() {\n    return this.microsoftGraph().sessionState$();\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  oneloginAuthApiRef,\n  OAuthRequestApi,\n  AuthProviderInfo,\n  ConfigApi,\n  DiscoveryApi,\n} from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\n\n/**\n * OneLogin auth provider create options.\n * @public\n */\nexport type OneLoginAuthCreateOptions = {\n  configApi?: ConfigApi;\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n  environment?: string;\n  provider?: AuthProviderInfo;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'onelogin',\n  title: 'onelogin',\n  icon: () => null,\n};\n\nconst OIDC_SCOPES: Set<String> = new Set([\n  'openid',\n  'profile',\n  'email',\n  'phone',\n  'address',\n  'groups',\n  'offline_access',\n]);\n\nconst SCOPE_PREFIX: string = 'onelogin.';\n\n/**\n * Implements a OneLogin OAuth flow.\n *\n * @public\n */\nexport default class OneLoginAuth {\n  static create(\n    options: OneLoginAuthCreateOptions,\n  ): typeof oneloginAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: ['openid', 'email', 'profile', 'offline_access'],\n      scopeTransform(scopes) {\n        return scopes.map(scope => {\n          if (OIDC_SCOPES.has(scope)) {\n            return scope;\n          }\n\n          if (scope.startsWith(SCOPE_PREFIX)) {\n            return scope;\n          }\n\n          return `${SCOPE_PREFIX}${scope}`;\n        });\n      },\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageIdentityResponse,\n  bitbucketAuthApiRef,\n  ProfileInfo,\n} from '@backstage/core-plugin-api';\n\nimport { OAuthApiCreateOptions } from '../types';\nimport { OAuth2 } from '../oauth2';\n\nexport type BitbucketAuthResponse = {\n  providerInfo: {\n    accessToken: string;\n    scope: string;\n    expiresInSeconds: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentityResponse;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'bitbucket',\n  title: 'Bitbucket',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to Bitbucket products.\n *\n * @public\n */\nexport default class BitbucketAuth {\n  static create(options: OAuthApiCreateOptions): typeof bitbucketAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = ['team'],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageIdentityResponse,\n  bitbucketServerAuthApiRef,\n  ProfileInfo,\n} from '@backstage/core-plugin-api';\n\nimport { OAuthApiCreateOptions } from '../types';\nimport { OAuth2 } from '../oauth2';\n\nexport type BitbucketServerAuthResponse = {\n  providerInfo: {\n    accessToken: string;\n    scope: string;\n    expiresInSeconds: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentityResponse;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'bitbucketServer',\n  title: 'Bitbucket Server',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to Bitbucket Server.\n * @public\n */\nexport default class BitbucketServerAuth {\n  static create(\n    options: OAuthApiCreateOptions,\n  ): typeof bitbucketServerAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = ['PROJECT_ADMIN'],\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes,\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { atlassianAuthApiRef } from '@backstage/core-plugin-api';\nimport { OAuth2 } from '../oauth2';\nimport { OAuthApiCreateOptions } from '../types';\n\nconst DEFAULT_PROVIDER = {\n  id: 'atlassian',\n  title: 'Atlassian',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to Atlassian products.\n *\n * @public\n */\nexport default class AtlassianAuth {\n  static create(options: OAuthApiCreateOptions): typeof atlassianAuthApiRef.T {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n    } = options;\n\n    return OAuth2.create({\n      configApi,\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n    });\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AlertApi, AlertMessage } from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { PublishSubject } from '../../../lib/subjects';\n\n/**\n * Base implementation for the AlertApi that simply forwards alerts to consumers.\n *\n * @public\n */\nexport class AlertApiForwarder implements AlertApi {\n  private readonly subject = new PublishSubject<AlertMessage>();\n\n  post(alert: AlertMessage) {\n    this.subject.next(alert);\n  }\n\n  alert$(): Observable<AlertMessage> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { AnalyticsApi, AnalyticsEvent } from '@backstage/core-plugin-api';\n\n/**\n * An implementation of the AnalyticsApi that can be used to forward analytics\n * events to multiple concrete implementations.\n *\n * @public\n *\n * @example\n *\n * ```jsx\n * createApiFactory({\n *   api: analyticsApiRef,\n *   deps: { configApi: configApiRef, identityApi: identityApiRef, storageApi: storageApiRef },\n *   factory: ({ configApi, identityApi, storageApi }) =>\n *     MultipleAnalyticsApi.fromApis([\n *       VendorAnalyticsApi.fromConfig(configApi, { identityApi }),\n *       CustomAnalyticsApi.fromConfig(configApi, { identityApi, storageApi }),\n *     ]),\n * });\n * ```\n */\nexport class MultipleAnalyticsApi implements AnalyticsApi {\n  private constructor(private readonly actualApis: AnalyticsApi[]) {}\n\n  /**\n   * Create an AnalyticsApi implementation from an array of concrete\n   * implementations.\n   *\n   * @example\n   *\n   * ```jsx\n   * MultipleAnalyticsApi.fromApis([\n   *   SomeAnalyticsApi.fromConfig(configApi),\n   *   new CustomAnalyticsApi(),\n   * ]);\n   * ```\n   */\n  static fromApis(actualApis: AnalyticsApi[]) {\n    return new MultipleAnalyticsApi(actualApis);\n  }\n\n  /**\n   * Forward the event to all configured analytics API implementations.\n   */\n  captureEvent(event: AnalyticsEvent): void {\n    this.actualApis.forEach(analyticsApi => {\n      try {\n        analyticsApi.captureEvent(event);\n      } catch {\n        /* ignored */\n      }\n    });\n  }\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { AnalyticsApi, AnalyticsEvent } from '@backstage/core-plugin-api';\n\n/**\n * Base implementation for the AnalyticsApi that does nothing.\n *\n * @public\n */\nexport class NoOpAnalyticsApi implements AnalyticsApi {\n  captureEvent(_event: AnalyticsEvent): void {}\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppThemeApi, AppTheme } from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { BehaviorSubject } from '../../../lib/subjects';\n\nconst STORAGE_KEY = 'theme';\n\n/**\n * Exposes the themes installed in the app, and permits switching the currently\n * active theme.\n *\n * @public\n */\nexport class AppThemeSelector implements AppThemeApi {\n  static createWithStorage(themes: AppTheme[]) {\n    const selector = new AppThemeSelector(themes);\n\n    if (!window.localStorage) {\n      return selector;\n    }\n\n    const initialThemeId =\n      window.localStorage.getItem(STORAGE_KEY) ?? undefined;\n\n    selector.setActiveThemeId(initialThemeId);\n\n    selector.activeThemeId$().subscribe(themeId => {\n      if (themeId) {\n        window.localStorage.setItem(STORAGE_KEY, themeId);\n      } else {\n        window.localStorage.removeItem(STORAGE_KEY);\n      }\n    });\n\n    window.addEventListener('storage', event => {\n      if (event.key === STORAGE_KEY) {\n        const themeId = localStorage.getItem(STORAGE_KEY) ?? undefined;\n        selector.setActiveThemeId(themeId);\n      }\n    });\n\n    return selector;\n  }\n\n  private activeThemeId: string | undefined;\n  private readonly subject = new BehaviorSubject<string | undefined>(undefined);\n\n  constructor(private readonly themes: AppTheme[]) {}\n\n  getInstalledThemes(): AppTheme[] {\n    return this.themes.slice();\n  }\n\n  activeThemeId$(): Observable<string | undefined> {\n    return this.subject;\n  }\n\n  getActiveThemeId(): string | undefined {\n    return this.activeThemeId;\n  }\n\n  setActiveThemeId(themeId?: string): void {\n    this.activeThemeId = themeId;\n    this.subject.next(themeId);\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\n\nconst ERROR_PREFIX = 'Invalid discovery URL pattern,';\n\n/**\n * UrlPatternDiscovery is a lightweight DiscoveryApi implementation.\n * It uses a single template string to construct URLs for each plugin.\n *\n * @public\n */\nexport class UrlPatternDiscovery implements DiscoveryApi {\n  /**\n   * Creates a new UrlPatternDiscovery given a template. The the only\n   * interpolation done for the template is to replace instances of `{{pluginId}}`\n   * with the ID of the plugin being requested.\n   *\n   * Example pattern: `http://localhost:7007/api/{{ pluginId }}`\n   */\n  static compile(pattern: string): UrlPatternDiscovery {\n    const parts = pattern.split(/\\{\\{\\s*pluginId\\s*\\}\\}/);\n    const urlStr = parts.join('pluginId');\n\n    let url;\n    try {\n      url = new URL(urlStr);\n    } catch {\n      throw new Error(`${ERROR_PREFIX} URL '${urlStr}' is invalid`);\n    }\n    if (url.hash) {\n      throw new Error(`${ERROR_PREFIX} URL must not have a hash`);\n    }\n    if (url.search) {\n      throw new Error(`${ERROR_PREFIX} URL must not have a query`);\n    }\n    if (urlStr.endsWith('/')) {\n      throw new Error(`${ERROR_PREFIX} URL must not end with a slash`);\n    }\n\n    return new UrlPatternDiscovery(parts);\n  }\n\n  private constructor(private readonly parts: string[]) {}\n\n  async getBaseUrl(pluginId: string): Promise<string> {\n    return this.parts.join(encodeURIComponent(pluginId));\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Config } from '@backstage/config';\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\nimport { UrlPatternDiscovery } from './UrlPatternDiscovery';\n\n/**\n * FrontendHostDiscovery is a config driven DiscoveryApi implementation.\n * It uses the app-config to determine the url for a plugin.\n *\n * @public\n */\nexport class FrontendHostDiscovery implements DiscoveryApi {\n  /**\n   * Creates a new FrontendHostDiscovery discovery instance by reading\n   * the external target URL from the `discovery.endpoints` config section.\n   *\n   * eg.\n   * ```yaml\n   * discovery:\n   *  endpoints:\n   *    - target: https://internal.example.com/internal-catalog\n   *      plugins: [catalog]\n   *    - target: https://internal.example.com/secure/api/{{pluginId}}\n   *      plugins: [auth, permissions]\n   *    - target:\n   *        internal: https://internal.example.com/search\n   *        external: https://example.com/search\n   *      plugins: [search]\n   * ```\n   *\n   * If a plugin is not declared in the config, the discovery will fall back to using the baseUrl with\n   * the provided `pathPattern` appended. The default path pattern is `\"/api/{{ pluginId }}\"`.\n   */\n  static fromConfig(config: Config, options?: { pathPattern?: string }) {\n    const path = options?.pathPattern ?? '/api/{{ pluginId }}';\n    const baseUrl = config.getString('backend.baseUrl');\n\n    const endpoints = config\n      .getOptionalConfigArray('discovery.endpoints')\n      ?.flatMap(e => {\n        const target =\n          typeof e.get('target') === 'object'\n            ? e.getString('target.external')\n            : e.getString('target');\n        const discovery = UrlPatternDiscovery.compile(target);\n        return e\n          .getStringArray('plugins')\n          .map(pluginId => [pluginId, discovery] as const);\n      });\n\n    return new FrontendHostDiscovery(\n      new Map(endpoints),\n      UrlPatternDiscovery.compile(`${baseUrl}${path}`),\n    );\n  }\n\n  private constructor(\n    private readonly endpoints: Map<string, DiscoveryApi>,\n    private readonly defaultEndpoint: DiscoveryApi,\n  ) {}\n\n  async getBaseUrl(pluginId: string): Promise<string> {\n    const endpoint = this.endpoints.get(pluginId);\n    if (endpoint) {\n      return endpoint.getBaseUrl(pluginId);\n    }\n    return this.defaultEndpoint.getBaseUrl(pluginId);\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  ErrorApi,\n  ErrorApiError,\n  ErrorApiErrorContext,\n  AlertApi,\n} from '@backstage/core-plugin-api';\n\n/**\n * Decorates an ErrorApi by also forwarding error messages\n * to the alertApi with an 'error' severity.\n *\n * @public\n */\nexport class ErrorAlerter implements ErrorApi {\n  constructor(\n    private readonly alertApi: AlertApi,\n    private readonly errorApi: ErrorApi,\n  ) {}\n\n  post(error: ErrorApiError, context?: ErrorApiErrorContext) {\n    if (!context?.hidden) {\n      this.alertApi.post({ message: error.message, severity: 'error' });\n    }\n\n    return this.errorApi.post(error, context);\n  }\n\n  error$() {\n    return this.errorApi.error$();\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ErrorApi,\n  ErrorApiError,\n  ErrorApiErrorContext,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { PublishSubject } from '../../../lib/subjects';\n\n/**\n * Base implementation for the ErrorApi that simply forwards errors to consumers.\n *\n * @public\n */\nexport class ErrorApiForwarder implements ErrorApi {\n  private readonly subject = new PublishSubject<{\n    error: Error;\n    context?: ErrorApiErrorContext;\n  }>();\n\n  post(error: ErrorApiError, context?: ErrorApiErrorContext) {\n    this.subject.next({ error, context });\n  }\n\n  error$(): Observable<{ error: Error; context?: ErrorApiErrorContext }> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ErrorApi,\n  ErrorApiError,\n  ErrorApiErrorContext,\n} from '@backstage/core-plugin-api';\n\n/**\n * Utility class that helps with error forwarding.\n *\n * @public\n */\nexport class UnhandledErrorForwarder {\n  /**\n   * Add event listener, such that unhandled errors can be forwarded using an given `ErrorApi` instance\n   */\n  static forward(errorApi: ErrorApi, errorContext: ErrorApiErrorContext) {\n    window.addEventListener(\n      'unhandledrejection',\n      (e: PromiseRejectionEvent) => {\n        errorApi.post(e.reason as ErrorApiError, errorContext);\n      },\n    );\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  FeatureFlagState,\n  FeatureFlagsApi,\n  FeatureFlag,\n  FeatureFlagsSaveOptions,\n} from '@backstage/core-plugin-api';\n\nexport function validateFlagName(name: string): void {\n  if (name.length < 3) {\n    throw new Error(\n      `The '${name}' feature flag must have a minimum length of three characters.`,\n    );\n  }\n\n  if (name.length > 150) {\n    throw new Error(\n      `The '${name}' feature flag must not exceed 150 characters.`,\n    );\n  }\n\n  if (!name.match(/^[a-z]+[a-z0-9-]+$/)) {\n    throw new Error(\n      `The '${name}' feature flag must start with a lowercase letter and only contain lowercase letters, numbers and hyphens. ` +\n        'Examples: feature-flag-one, alpha, release-2020',\n    );\n  }\n}\n\n/**\n * A feature flags implementation that stores the flags in the browser's local\n * storage.\n *\n * @public\n */\nexport class LocalStorageFeatureFlags implements FeatureFlagsApi {\n  private registeredFeatureFlags: FeatureFlag[] = [];\n  private flags?: Map<string, FeatureFlagState>;\n\n  registerFlag(flag: FeatureFlag) {\n    validateFlagName(flag.name);\n    this.registeredFeatureFlags.push(flag);\n  }\n\n  getRegisteredFlags(): FeatureFlag[] {\n    return this.registeredFeatureFlags.slice();\n  }\n\n  isActive(name: string): boolean {\n    if (!this.flags) {\n      this.flags = this.load();\n    }\n    return this.flags.get(name) === FeatureFlagState.Active;\n  }\n\n  save(options: FeatureFlagsSaveOptions): void {\n    if (!this.flags) {\n      this.flags = this.load();\n    }\n    if (!options.merge) {\n      this.flags.clear();\n    }\n    for (const [name, state] of Object.entries(options.states)) {\n      this.flags.set(name, state);\n    }\n\n    const enabled = Array.from(this.flags.entries()).filter(\n      ([, state]) => state === FeatureFlagState.Active,\n    );\n    window.localStorage.setItem(\n      'featureFlags',\n      JSON.stringify(Object.fromEntries(enabled)),\n    );\n  }\n\n  private load(): Map<string, FeatureFlagState> {\n    try {\n      const jsonStr = window.localStorage.getItem('featureFlags');\n      if (!jsonStr) {\n        return new Map();\n      }\n      const json = JSON.parse(jsonStr) as unknown;\n      if (typeof json !== 'object' || json === null || Array.isArray(json)) {\n        return new Map();\n      }\n\n      const entries = Object.entries(json).filter(([name, value]) => {\n        validateFlagName(name);\n        return value === FeatureFlagState.Active;\n      });\n\n      return new Map(entries);\n    } catch {\n      return new Map();\n    }\n  }\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FetchApi } from '@backstage/core-plugin-api';\nimport { FetchMiddleware } from './types';\n\n/**\n * Builds a fetch API, based on the builtin fetch wrapped by a set of optional\n * middleware implementations that add behaviors.\n *\n * @remarks\n *\n * The middleware are applied in reverse order, i.e. the last one will be\n * \"closest\" to the base implementation. Passing in `[M1, M2, M3]` effectively\n * leads to `M1(M2(M3(baseImplementation)))`.\n *\n * @public\n */\nexport function createFetchApi(options: {\n  baseImplementation?: typeof fetch | undefined;\n  middleware?: FetchMiddleware | FetchMiddleware[] | undefined;\n}): FetchApi {\n  let result = options.baseImplementation || global.fetch;\n\n  const middleware = [options.middleware ?? []].flat().reverse();\n  for (const m of middleware) {\n    result = m.apply(result);\n  }\n\n  return {\n    fetch: result,\n  };\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { IdentityApi } from '@backstage/core-plugin-api';\nimport { FetchMiddleware } from './types';\n\n/**\n * A fetch middleware, which injects a Backstage token header when the user is\n * signed in.\n */\nexport class IdentityAuthInjectorFetchMiddleware implements FetchMiddleware {\n  static create(options: {\n    identityApi: IdentityApi;\n    config?: Config;\n    urlPrefixAllowlist?: string[];\n    allowUrl?: (url: string) => boolean;\n    header?: {\n      name: string;\n      value: (backstageToken: string) => string;\n    };\n  }): IdentityAuthInjectorFetchMiddleware {\n    const matcher = buildMatcher(options);\n    const headerName = options.header?.name || 'authorization';\n    const headerValue = options.header?.value || (token => `Bearer ${token}`);\n\n    return new IdentityAuthInjectorFetchMiddleware(\n      options.identityApi,\n      matcher,\n      headerName,\n      headerValue,\n    );\n  }\n\n  constructor(\n    public readonly identityApi: IdentityApi,\n    public readonly allowUrl: (url: string) => boolean,\n    public readonly headerName: string,\n    public readonly headerValue: (pluginId: string) => string,\n  ) {}\n\n  apply(next: typeof fetch): typeof fetch {\n    return async (input, init) => {\n      // Skip this middleware if the header already exists, or if the URL\n      // doesn't match any of the allowlist items, or if there was no token.\n      // NOTE(freben): The \"as any\" casts here and below are because of subtle\n      // undici type differences that happened in a node types bump. Those are\n      // immaterial to the code at hand at runtime, as the global fetch and\n      // Request are always taken from the same place.\n      const request = new Request(input as any, init);\n      const { token } = await this.identityApi.getCredentials();\n      if (\n        request.headers.get(this.headerName) ||\n        typeof token !== 'string' ||\n        !token ||\n        !this.allowUrl(request.url)\n      ) {\n        return next(input as any, init);\n      }\n\n      request.headers.set(this.headerName, this.headerValue(token));\n      return next(request);\n    };\n  }\n}\n\nfunction buildMatcher(options: {\n  config?: Config;\n  urlPrefixAllowlist?: string[];\n  allowUrl?: (url: string) => boolean;\n}): (url: string) => boolean {\n  if (options.allowUrl) {\n    return options.allowUrl;\n  } else if (options.urlPrefixAllowlist) {\n    return buildPrefixMatcher(options.urlPrefixAllowlist);\n  } else if (options.config) {\n    return buildPrefixMatcher([options.config.getString('backend.baseUrl')]);\n  }\n  return () => false;\n}\n\nfunction buildPrefixMatcher(prefixes: string[]): (url: string) => boolean {\n  const trimmedPrefixes = prefixes.map(prefix => prefix.replace(/\\/$/, ''));\n  return url =>\n    trimmedPrefixes.some(\n      prefix => url === prefix || url.startsWith(`${prefix}/`),\n    );\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\nimport { FetchMiddleware } from './types';\n\nfunction join(left: string, right: string): string {\n  if (!right || right === '/') {\n    return left;\n  }\n\n  return `${left.replace(/\\/$/, '')}/${right.replace(/^\\//, '')}`;\n}\n\n/**\n * Handles translation from plugin://some-plugin-id/<path> to concrete http(s)\n * URLs.\n */\nexport class PluginProtocolResolverFetchMiddleware implements FetchMiddleware {\n  constructor(private readonly discoveryApi: DiscoveryApi) {}\n\n  apply(next: typeof fetch): typeof fetch {\n    return async (input, init) => {\n      // NOTE(freben): The \"as any\" casts here and below are because of subtle\n      // undici type differences that happened in a node types bump. Those are\n      // immaterial to the code at hand at runtime, as the global fetch and\n      // Request are always taken from the same place.\n      const request = new Request(input as any, init);\n      const prefix = 'plugin://';\n\n      if (!request.url.startsWith(prefix)) {\n        return next(input as any, init);\n      }\n\n      // Switch to a known protocol, since browser URL parsing misbehaves wildly\n      // on foreign protocols\n      const { hostname, pathname, search, hash, username, password } = new URL(\n        `http://${request.url.substring(prefix.length)}`,\n      );\n\n      let base = await this.discoveryApi.getBaseUrl(hostname);\n      if (username || password) {\n        const baseUrl = new URL(base);\n        const authority = `${username}${password ? `:${password}` : ''}@`;\n        base = `${baseUrl.protocol}//${authority}${baseUrl.host}${baseUrl.pathname}`;\n      }\n\n      const target = `${join(base, pathname)}${search}${hash}`;\n      return next(\n        target,\n        typeof input === 'string' || isUrl(input) ? init : (input as any),\n      );\n    };\n  }\n}\n\nfunction isUrl(a: unknown): a is URL {\n  return typeof a === 'object' && a?.constructor === URL;\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { DiscoveryApi, IdentityApi } from '@backstage/core-plugin-api';\nimport { IdentityAuthInjectorFetchMiddleware } from './IdentityAuthInjectorFetchMiddleware';\nimport { PluginProtocolResolverFetchMiddleware } from './PluginProtocolResolverFetchMiddleware';\nimport { FetchMiddleware } from './types';\n\n/**\n * A collection of common middlewares for the FetchApi.\n *\n * @public\n */\nexport class FetchMiddlewares {\n  /**\n   * Handles translation from `plugin://` URLs to concrete http(s) URLs based on\n   * the discovery API.\n   *\n   * @remarks\n   *\n   * If the request is for `plugin://catalog/entities?filter=x=y`, the discovery\n   * API will be queried for `'catalog'`. If it returned\n   * `https://backstage.example.net/api/catalog`, the resulting query would be\n   * `https://backstage.example.net/api/catalog/entities?filter=x=y`.\n   *\n   * If the incoming URL protocol was not `plugin`, the request is just passed\n   * through verbatim to the underlying implementation.\n   */\n  static resolvePluginProtocol(options: {\n    discoveryApi: DiscoveryApi;\n  }): FetchMiddleware {\n    return new PluginProtocolResolverFetchMiddleware(options.discoveryApi);\n  }\n\n  /**\n   * Injects a Backstage token header when the user is signed in.\n   *\n   * @remarks\n   *\n   * Per default, an `Authorization: Bearer <token>` is generated. This can be\n   * customized using the `header` option.\n   *\n   * The header injection only happens on allowlisted URLs. Per default, if the\n   * `config` option is passed in, the `backend.baseUrl` is allowlisted, unless\n   * the `urlPrefixAllowlist` or `allowUrl` options are passed in, in which case\n   * they take precedence. If you pass in neither config nor an\n   * allowlist/callback, the middleware will have no effect since effectively no\n   * request will match the (nonexistent) rules.\n   */\n  static injectIdentityAuth(options: {\n    identityApi: IdentityApi;\n    config?: Config;\n    urlPrefixAllowlist?: string[];\n    allowUrl?: (url: string) => boolean;\n    header?: {\n      name: string;\n      value: (backstageToken: string) => string;\n    };\n  }): FetchMiddleware {\n    return IdentityAuthInjectorFetchMiddleware.create(options);\n  }\n\n  private constructor() {}\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Observable } from '@backstage/types';\nimport { BehaviorSubject } from '../../../lib/subjects';\n\ntype RequestQueueEntry<ResultType> = {\n  scopes: Set<string>;\n  resolve: (value: ResultType | PromiseLike<ResultType>) => void;\n  reject: (reason: Error) => void;\n};\n\nexport type PendingRequest<ResultType> = {\n  scopes: Set<string> | undefined;\n  resolve: (value: ResultType) => void;\n  reject: (reason: Error) => void;\n};\n\nexport function hasScopes(\n  searched: Set<string>,\n  searchFor: Set<string>,\n): boolean {\n  for (const scope of searchFor) {\n    if (!searched.has(scope)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function joinScopes(\n  scopes: Set<string>,\n  ...moreScopess: Set<string>[]\n): Set<string> {\n  const result = new Set(scopes);\n\n  for (const moreScopes of moreScopess) {\n    for (const scope of moreScopes) {\n      result.add(scope);\n    }\n  }\n\n  return result;\n}\n\n/**\n * The OAuthPendingRequests class is a utility for managing and observing\n * a stream of requests for oauth scopes for a single provider, and resolving\n * them correctly once requests are fulfilled.\n */\nexport class OAuthPendingRequests<ResultType> {\n  private requests: RequestQueueEntry<ResultType>[] = [];\n  private subject = new BehaviorSubject<PendingRequest<ResultType>>(\n    this.getCurrentPending(),\n  );\n\n  request(scopes: Set<string>): Promise<ResultType> {\n    return new Promise((resolve, reject) => {\n      this.requests.push({ scopes, resolve, reject });\n\n      this.subject.next(this.getCurrentPending());\n    });\n  }\n\n  resolve(scopes: Set<string>, result: ResultType): void {\n    this.requests = this.requests.filter(request => {\n      if (hasScopes(scopes, request.scopes)) {\n        request.resolve(result);\n        return false;\n      }\n      return true;\n    });\n\n    this.subject.next(this.getCurrentPending());\n  }\n\n  reject(error: Error) {\n    this.requests.forEach(request => request.reject(error));\n    this.requests = [];\n\n    this.subject.next(this.getCurrentPending());\n  }\n\n  pending(): Observable<PendingRequest<ResultType>> {\n    return this.subject;\n  }\n\n  private getCurrentPending(): PendingRequest<ResultType> {\n    const currentScopes =\n      this.requests.length === 0\n        ? undefined\n        : this.requests\n            .slice(1)\n            .reduce(\n              (acc, current) => joinScopes(acc, current.scopes),\n              this.requests[0].scopes,\n            );\n\n    return {\n      scopes: currentScopes,\n      resolve: (value: ResultType) => {\n        if (currentScopes) {\n          this.resolve(currentScopes, value);\n        }\n      },\n      reject: (reason: Error) => {\n        if (currentScopes) {\n          this.reject(reason);\n        }\n      },\n    };\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  OAuthRequestApi,\n  PendingOAuthRequest,\n  OAuthRequester,\n  OAuthRequesterOptions,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { OAuthPendingRequests, PendingRequest } from './OAuthPendingRequests';\nimport { BehaviorSubject } from '../../../lib/subjects';\n\n/**\n * The OAuthRequestManager is an implementation of the OAuthRequestApi.\n *\n * The purpose of this class and the API is to read a stream of incoming requests\n * of OAuth access tokens from different providers with varying scope, and funnel\n * them all together into a single request for each OAuth provider.\n *\n * @public\n */\nexport class OAuthRequestManager implements OAuthRequestApi {\n  private readonly subject = new BehaviorSubject<PendingOAuthRequest[]>([]);\n  private currentRequests: PendingOAuthRequest[] = [];\n  private handlerCount = 0;\n\n  createAuthRequester<T>(options: OAuthRequesterOptions<T>): OAuthRequester<T> {\n    const handler = new OAuthPendingRequests<T>();\n\n    const index = this.handlerCount;\n    this.handlerCount++;\n\n    handler.pending().subscribe({\n      next: scopeRequest => {\n        const newRequests = this.currentRequests.slice();\n        const request = this.makeAuthRequest(scopeRequest, options);\n        if (!request) {\n          delete newRequests[index];\n        } else {\n          newRequests[index] = request;\n        }\n        this.currentRequests = newRequests;\n        // Convert from sparse array to array of present items only\n        this.subject.next(newRequests.filter(Boolean));\n      },\n    });\n\n    return scopes => {\n      return handler.request(scopes);\n    };\n  }\n\n  // Converts the pending request and popup options into a popup request that we can forward to subscribers.\n  private makeAuthRequest(\n    request: PendingRequest<any>,\n    options: OAuthRequesterOptions<any>,\n  ): PendingOAuthRequest | undefined {\n    const { scopes } = request;\n    if (!scopes) {\n      return undefined;\n    }\n\n    return {\n      provider: options.provider,\n      trigger: async () => {\n        const result = await options.onAuthRequest(scopes);\n        request.resolve(result);\n      },\n      reject: () => {\n        const error = new Error('Login failed, rejected by user');\n        error.name = 'RejectedError';\n        request.reject(error);\n      },\n    };\n  }\n\n  authRequest$(): Observable<PendingOAuthRequest[]> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  StorageApi,\n  StorageValueSnapshot,\n  ErrorApi,\n} from '@backstage/core-plugin-api';\nimport { JsonValue, Observable } from '@backstage/types';\nimport ObservableImpl from 'zen-observable';\n\nexport const buckets = new Map<string, WebStorage>();\n\n/**\n * An implementation of the storage API, that uses the browser's local storage.\n *\n * @public\n */\nexport class WebStorage implements StorageApi {\n  constructor(\n    private readonly namespace: string,\n    private readonly errorApi: ErrorApi,\n  ) {}\n\n  private static hasSubscribed = false;\n\n  static create(options: {\n    errorApi: ErrorApi;\n    namespace?: string;\n  }): WebStorage {\n    return new WebStorage(options.namespace ?? '', options.errorApi);\n  }\n\n  private static addStorageEventListener() {\n    window.addEventListener('storage', event => {\n      for (const [bucketPath, webStorage] of buckets.entries()) {\n        if (event.key?.startsWith(bucketPath)) {\n          webStorage.handleStorageChange(event.key);\n        }\n      }\n    });\n  }\n\n  get<T>(key: string): T | undefined {\n    return this.snapshot(key).value as T | undefined;\n  }\n\n  snapshot<T extends JsonValue>(key: string): StorageValueSnapshot<T> {\n    let value = undefined;\n    let presence: 'present' | 'absent' = 'absent';\n    try {\n      const item = localStorage.getItem(this.getKeyName(key));\n      if (item) {\n        value = JSON.parse(item, (_key, val) => {\n          if (typeof val === 'object' && val !== null) {\n            Object.freeze(val);\n          }\n          return val;\n        });\n        presence = 'present';\n      }\n    } catch (e) {\n      this.errorApi.post(\n        new Error(`Error when parsing JSON config from storage for: ${key}`),\n      );\n    }\n    return { key, value, presence };\n  }\n\n  forBucket(name: string): WebStorage {\n    const bucketPath = `${this.namespace}/${name}`;\n    if (!buckets.has(bucketPath)) {\n      buckets.set(bucketPath, new WebStorage(bucketPath, this.errorApi));\n    }\n    return buckets.get(bucketPath)!;\n  }\n\n  async set<T>(key: string, data: T): Promise<void> {\n    localStorage.setItem(this.getKeyName(key), JSON.stringify(data));\n    this.notifyChanges(key);\n  }\n\n  async remove(key: string): Promise<void> {\n    localStorage.removeItem(this.getKeyName(key));\n    this.notifyChanges(key);\n  }\n\n  observe$<T extends JsonValue>(\n    key: string,\n  ): Observable<StorageValueSnapshot<T>> {\n    if (!WebStorage.hasSubscribed) {\n      WebStorage.addStorageEventListener();\n      WebStorage.hasSubscribed = true;\n    }\n    return this.observable.filter(({ key: messageKey }) => messageKey === key);\n  }\n\n  private handleStorageChange(eventKey: StorageEvent['key']) {\n    if (!eventKey?.startsWith(this.namespace)) {\n      return;\n    }\n    // Grab the part of this key that is local to this bucket\n    const trimmedKey = eventKey?.slice(`${this.namespace}/`.length);\n\n    // If the key still contains a slash, it means it's a sub-bucket\n    if (!trimmedKey.includes('/')) {\n      this.notifyChanges(decodeURIComponent(trimmedKey));\n    }\n  }\n\n  private getKeyName(key: string) {\n    return `${this.namespace}/${encodeURIComponent(key)}`;\n  }\n\n  private notifyChanges(key: string) {\n    const snapshot = this.snapshot(key);\n    for (const subscription of this.subscribers) {\n      subscription.next(snapshot);\n    }\n  }\n\n  private subscribers = new Set<\n    ZenObservable.SubscriptionObserver<StorageValueSnapshot<JsonValue>>\n  >();\n\n  private readonly observable = new ObservableImpl<\n    StorageValueSnapshot<JsonValue>\n  >(subscriber => {\n    this.subscribers.add(subscriber);\n    return () => {\n      this.subscribers.delete(subscriber);\n    };\n  });\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createContext } from 'react';\nimport { AppIdentityProxy } from '../apis/implementations/IdentityApi/AppIdentityProxy';\nimport { BackstageRouteObject } from '../routing/types';\n\nexport const InternalAppContext = createContext<\n  | undefined\n  | {\n      routeObjects: BackstageRouteObject[];\n      appIdentityProxy: AppIdentityProxy;\n    }\n>(undefined);\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport { createRoutesFromChildren, Route } from 'react-router-dom';\n\nexport function isReactRouterBeta(): boolean {\n  const [obj] = createRoutesFromChildren(<Route index element={<div />} />);\n  return !obj.index;\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useEffect } from 'react';\nimport { matchRoutes, useLocation } from 'react-router-dom';\nimport {\n  useAnalytics,\n  AnalyticsContext,\n  RouteRef,\n  AnalyticsEventAttributes,\n  BackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { BackstageRouteObject } from './types';\n\n/**\n * Returns an extension context given the current pathname and a list of\n * Backstage route objects.\n */\nconst getExtensionContext = (\n  pathname: string,\n  routes: BackstageRouteObject[],\n) => {\n  try {\n    // Find matching routes for the given path name.\n    const matches = matchRoutes(routes, { pathname });\n\n    // Of the matching routes, get the last (e.g. most specific) instance of\n    // the BackstageRouteObject that contains a routeRef. Filtering by routeRef\n    // ensures subRouteRefs are aligned to their parent routes' context.\n    const routeMatch = matches\n      ?.filter(match => match?.route.routeRefs?.size > 0)\n      .pop();\n    const routeObject = routeMatch?.route;\n\n    // If there is no route object, then allow inheritance of default context.\n    if (!routeObject) {\n      return undefined;\n    }\n\n    // If the matched route is the root route (no path), and the pathname is\n    // not the path of the homepage, then inherit from the default context.\n    if (routeObject.path === '' && pathname !== '/') {\n      return undefined;\n    }\n\n    // If there is a single route ref, use it.\n    let routeRef: RouteRef | undefined;\n    if (routeObject.routeRefs.size === 1) {\n      routeRef = routeObject.routeRefs.values().next().value;\n    }\n\n    // If there is a single plugin, use it.\n    let plugin: BackstagePlugin | undefined;\n    if (routeObject.plugins.size === 1) {\n      plugin = routeObject.plugins.values().next().value;\n    }\n\n    const params = Object.entries(\n      routeMatch?.params || {},\n    ).reduce<AnalyticsEventAttributes>((acc, [key, value]) => {\n      if (value !== undefined && key !== '*') {\n        acc[key] = value;\n      }\n      return acc;\n    }, {});\n\n    return {\n      extension: 'App',\n      pluginId: plugin?.getId() || 'root',\n      ...(routeRef ? { routeRef: (routeRef as { id?: string }).id } : {}),\n      _routeNodeType: routeObject.element as string,\n      params,\n    };\n  } catch {\n    return undefined;\n  }\n};\n\n/**\n * Performs the actual event capture on render.\n */\nconst TrackNavigation = ({\n  pathname,\n  search,\n  hash,\n  attributes,\n}: {\n  pathname: string;\n  search: string;\n  hash: string;\n  attributes?: AnalyticsEventAttributes;\n}) => {\n  const analytics = useAnalytics();\n  useEffect(() => {\n    analytics.captureEvent('navigate', `${pathname}${search}${hash}`, {\n      attributes,\n    });\n  }, [analytics, pathname, search, hash, attributes]);\n\n  return null;\n};\n\n/**\n * Logs a \"navigate\" event with appropriate plugin-level analytics context\n * attributes each time the user navigates to a page.\n */\nexport const RouteTracker = ({\n  routeObjects,\n}: {\n  routeObjects: BackstageRouteObject[];\n}) => {\n  const { pathname, search, hash } = useLocation();\n\n  const { params, ...attributes } = getExtensionContext(\n    pathname,\n    routeObjects,\n  ) || { params: {} };\n\n  return (\n    <AnalyticsContext attributes={attributes}>\n      <TrackNavigation\n        pathname={pathname}\n        search={search}\n        hash={hash}\n        attributes={params}\n      />\n    </AnalyticsContext>\n  );\n};\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useContext, ReactNode, ComponentType, useState } from 'react';\nimport {\n  attachComponentData,\n  ConfigApi,\n  configApiRef,\n  IdentityApi,\n  SignInPageProps,\n  useApi,\n  useApp,\n} from '@backstage/core-plugin-api';\nimport { InternalAppContext } from './InternalAppContext';\nimport { isReactRouterBeta } from './isReactRouterBeta';\nimport { RouteTracker } from '../routing/RouteTracker';\nimport { Route, Routes } from 'react-router-dom';\nimport { AppIdentityProxy } from '../apis/implementations/IdentityApi/AppIdentityProxy';\n\n/**\n * Get the app base path from the configured app baseUrl.\n *\n * The returned path does not have a trailing slash.\n */\nexport function getBasePath(configApi: ConfigApi) {\n  if (!isReactRouterBeta()) {\n    // When using rr v6 stable the base path is handled through the\n    // basename prop on the router component instead.\n    return '';\n  }\n\n  return readBasePath(configApi);\n}\n\n/**\n * Read the configured base path.\n *\n * The returned path does not have a trailing slash.\n */\nfunction readBasePath(configApi: ConfigApi) {\n  let { pathname } = new URL(\n    configApi.getOptionalString('app.baseUrl') ?? '/',\n    'http://sample.dev', // baseUrl can be specified as just a path\n  );\n  pathname = pathname.replace(/\\/*$/, '');\n  return pathname;\n}\n\n// This wraps the sign-in page and waits for sign-in to be completed before rendering the app\nfunction SignInPageWrapper({\n  component: Component,\n  appIdentityProxy,\n  children,\n}: {\n  component: ComponentType<SignInPageProps>;\n  appIdentityProxy: AppIdentityProxy;\n  children: ReactNode;\n}) {\n  const [identityApi, setIdentityApi] = useState<IdentityApi>();\n  const configApi = useApi(configApiRef);\n  const basePath = readBasePath(configApi);\n\n  if (!identityApi) {\n    return <Component onSignInSuccess={setIdentityApi} />;\n  }\n\n  appIdentityProxy.setTarget(identityApi, {\n    signOutTargetUrl: basePath || '/',\n  });\n  return <>{children}</>;\n}\n\n/**\n * Props for the {@link AppRouter} component.\n * @public\n */\nexport interface AppRouterProps {\n  children?: ReactNode;\n}\n\n/**\n * App router and sign-in page wrapper.\n *\n * @public\n * @remarks\n *\n * The AppRouter provides the routing context and renders the sign-in page.\n * Until the user has successfully signed in, this component will render\n * the sign-in page. Once the user has signed-in, it will instead render\n * the app, while providing routing and route tracking for the app.\n */\nexport function AppRouter(props: AppRouterProps) {\n  const { Router: RouterComponent, SignInPage: SignInPageComponent } =\n    useApp().getComponents();\n\n  const configApi = useApi(configApiRef);\n  const basePath = readBasePath(configApi);\n  const mountPath = `${basePath}/*`;\n  const internalAppContext = useContext(InternalAppContext);\n  if (!internalAppContext) {\n    throw new Error('AppRouter must be rendered within the AppProvider');\n  }\n  const { routeObjects, appIdentityProxy } = internalAppContext;\n\n  // If the app hasn't configured a sign-in page, we just continue as guest.\n  if (!SignInPageComponent) {\n    appIdentityProxy.setTarget(\n      {\n        getUserId: () => 'guest',\n        getIdToken: async () => undefined,\n        getProfile: () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getProfileInfo: async () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getBackstageIdentity: async () => ({\n          type: 'user',\n          userEntityRef: 'user:default/guest',\n          ownershipEntityRefs: ['user:default/guest'],\n        }),\n        getCredentials: async () => ({}),\n        signOut: async () => {},\n      },\n      { signOutTargetUrl: basePath || '/' },\n    );\n\n    if (isReactRouterBeta()) {\n      return (\n        <RouterComponent>\n          <RouteTracker routeObjects={routeObjects} />\n          <Routes>\n            <Route path={mountPath} element={<>{props.children}</>} />\n          </Routes>\n        </RouterComponent>\n      );\n    }\n\n    return (\n      <RouterComponent basename={basePath}>\n        <RouteTracker routeObjects={routeObjects} />\n        {props.children}\n      </RouterComponent>\n    );\n  }\n\n  if (isReactRouterBeta()) {\n    return (\n      <RouterComponent>\n        <RouteTracker routeObjects={routeObjects} />\n        <SignInPageWrapper\n          component={SignInPageComponent}\n          appIdentityProxy={appIdentityProxy}\n        >\n          <Routes>\n            <Route path={mountPath} element={<>{props.children}</>} />\n          </Routes>\n        </SignInPageWrapper>\n      </RouterComponent>\n    );\n  }\n\n  return (\n    <RouterComponent basename={basePath}>\n      <RouteTracker routeObjects={routeObjects} />\n      <SignInPageWrapper\n        component={SignInPageComponent}\n        appIdentityProxy={appIdentityProxy}\n      >\n        {props.children}\n      </SignInPageWrapper>\n    </RouterComponent>\n  );\n}\n\nattachComponentData(AppRouter, 'core.type', 'AppRouter');\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { isValidElement, ReactNode, ReactElement, Children } from 'react';\n\nexport type Discoverer = (element: ReactElement) => ReactNode;\n\nexport type Collector<Result, Context> = () => {\n  accumulator: Result;\n  visit(\n    accumulator: Result,\n    element: ReactElement,\n    parent: ReactElement | undefined,\n    context: Context,\n  ): Context;\n};\n\n/**\n * A function that allows you to traverse a tree of React elements using\n * varying methods to discover child nodes and collect data along the way.\n */\nexport function traverseElementTree<Results>(options: {\n  root: ReactNode;\n  discoverers: Discoverer[];\n  collectors: { [name in keyof Results]: Collector<Results[name], any> };\n}): Results {\n  const collectors: {\n    [name in string]: ReturnType<Collector<any, any>>;\n  } = {};\n\n  // Bootstrap all collectors, initializing the accumulators and providing the visitor function\n  for (const name in options.collectors) {\n    if (options.collectors.hasOwnProperty(name)) {\n      collectors[name] = options.collectors[name]();\n    }\n  }\n\n  // Internal representation of an element in the tree that we're iterating over\n  type QueueItem = {\n    node: ReactNode;\n    parent: ReactElement | undefined;\n    contexts: { [name in string]: unknown };\n  };\n\n  const queue = [\n    {\n      node: Children.toArray(options.root),\n      parent: undefined,\n      contexts: {},\n    } as QueueItem,\n  ];\n\n  while (queue.length !== 0) {\n    const { node, parent, contexts } = queue.shift()!;\n\n    // While the parent and the element we pass on to collectors and discoverers\n    // have been validated and are known to be React elements, the child nodes\n    // emitted by the discoverers are not.\n    Children.forEach(node, element => {\n      if (!isValidElement(element)) {\n        return;\n      }\n\n      const nextContexts: QueueItem['contexts'] = {};\n\n      // Collectors populate their result data using the current node, and compute\n      // context for the next iteration\n      for (const name in collectors) {\n        if (collectors.hasOwnProperty(name)) {\n          const collector = collectors[name];\n\n          nextContexts[name] = collector.visit(\n            collector.accumulator,\n            element,\n            parent,\n            contexts[name],\n          );\n        }\n      }\n\n      // Discoverers provide ways to continue the traversal from the current element\n      for (const discoverer of options.discoverers) {\n        const children = discoverer(element);\n        if (children) {\n          queue.push({\n            node: children,\n            parent: element,\n            contexts: nextContexts,\n          });\n        }\n      }\n    });\n  }\n\n  return Object.fromEntries(\n    Object.entries(collectors).map(([name, c]) => [name, c.accumulator]),\n  ) as Results;\n}\n\nexport function createCollector<Result, Context>(\n  accumulatorFactory: () => Result,\n  visit: ReturnType<Collector<Result, Context>>['visit'],\n): Collector<Result, Context> {\n  return () => ({ accumulator: accumulatorFactory(), visit });\n}\n\nexport function childDiscoverer(element: ReactElement): ReactNode {\n  return element.props?.children;\n}\n\nexport function routeElementDiscoverer(element: ReactElement): ReactNode {\n  if (element.props?.path && element.props?.element) {\n    return element.props?.element;\n  }\n  return undefined;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BackstagePlugin, getComponentData } from '@backstage/core-plugin-api';\nimport { createCollector } from '../extensions/traversal';\n\nexport const pluginCollector = createCollector(\n  () => new Set<BackstagePlugin>(),\n  (acc, node) => {\n    const plugin = getComponentData<BackstagePlugin>(node, 'core.plugin');\n    if (plugin) {\n      acc.add(plugin);\n    }\n  },\n);\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  featureFlagsApiRef,\n  useApi,\n  attachComponentData,\n} from '@backstage/core-plugin-api';\nimport React, { ReactNode } from 'react';\n\n/**\n * Props for the {@link FeatureFlagged} component.\n *\n * @public\n */\nexport type FeatureFlaggedProps = { children: ReactNode } & (\n  | { with: string }\n  | { without: string }\n);\n\n/**\n * Enables or disables rendering of its children based on the state of a given\n * feature flag.\n *\n * @public\n */\nexport const FeatureFlagged = (props: FeatureFlaggedProps) => {\n  const { children } = props;\n  const featureFlagApi = useApi(featureFlagsApiRef);\n  const isEnabled =\n    'with' in props\n      ? featureFlagApi.isActive(props.with)\n      : !featureFlagApi.isActive(props.without);\n  return <>{isEnabled ? children : null}</>;\n};\n\nattachComponentData(FeatureFlagged, 'core.featureFlagged', true);\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  RouteRef,\n  getComponentData,\n  BackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { isValidElement, ReactNode, Children } from 'react';\nimport { BackstageRouteObject } from './types';\nimport { createCollector } from '../extensions/traversal';\nimport { FeatureFlagged, FeatureFlaggedProps } from './FeatureFlagged';\n\n// We always add a child that matches all subroutes but without any route refs. This makes\n// sure that we're always able to match each route no matter how deep the navigation goes.\n// The route resolver then takes care of selecting the most specific match in order to find\n// mount points that are as deep in the routing tree as possible.\nexport const MATCH_ALL_ROUTE: BackstageRouteObject = {\n  caseSensitive: false,\n  path: '*',\n  element: 'match-all', // These elements aren't used, so we add in a bit of debug information\n  routeRefs: new Set(),\n  plugins: new Set(),\n};\n\nfunction stringifyNode(node: ReactNode): string {\n  const anyNode = node as { type?: { displayName?: string; name?: string } };\n  if (anyNode?.type) {\n    return (\n      anyNode.type.displayName ?? anyNode.type.name ?? String(anyNode.type)\n    );\n  }\n  return String(anyNode);\n}\n\nconst pluginSet = (\n  plugin: BackstagePlugin | undefined,\n): Set<BackstagePlugin> => {\n  const set = new Set<BackstagePlugin>();\n  if (plugin) {\n    set.add(plugin);\n  }\n  return set;\n};\n\ninterface RoutingV2CollectorContext {\n  routeRef?: RouteRef;\n  gatherPath?: string;\n  gatherRouteRef?: RouteRef;\n  obj?: BackstageRouteObject;\n  isElementAncestor?: boolean;\n}\n\n// This collects all the mount points and their plugins within an element tree.\n// Unlike regular traversal this ignores all other things, like path props and mount point gatherers.\nfunction collectSubTree(\n  node: ReactNode,\n  entries = new Array<{ routeRef: RouteRef; plugin?: BackstagePlugin }>(),\n) {\n  Children.forEach(node, element => {\n    if (!isValidElement(element)) {\n      return;\n    }\n\n    const routeRef = getComponentData<RouteRef>(element, 'core.mountPoint');\n    if (routeRef) {\n      const plugin = getComponentData<BackstagePlugin>(element, 'core.plugin');\n      entries.push({ routeRef, plugin });\n    }\n\n    collectSubTree(element.props.children, entries);\n  });\n\n  return entries;\n}\n\nexport const routingV2Collector = createCollector(\n  () => ({\n    paths: new Map<RouteRef, string>(),\n    parents: new Map<RouteRef, RouteRef | undefined>(),\n    objects: new Array<BackstageRouteObject>(),\n  }),\n  (acc, node, parent, ctx?: RoutingV2CollectorContext) => {\n    // If we're in an element prop, ignore everything\n    if (ctx?.isElementAncestor) {\n      return ctx;\n    }\n\n    // Start ignoring everything if we enter an element prop\n    if (parent?.props.element === node) {\n      return { ...ctx, isElementAncestor: true };\n    }\n\n    const pathProp: unknown = node.props?.path;\n\n    const mountPoint = getComponentData<RouteRef>(node, 'core.mountPoint');\n    if (mountPoint && pathProp) {\n      throw new Error(\n        `Path property may not be set directly on a routable extension \"${stringifyNode(\n          node,\n        )}\"`,\n      );\n    }\n\n    const parentChildren = ctx?.obj?.children ?? acc.objects;\n\n    if (pathProp !== undefined) {\n      if (typeof pathProp !== 'string') {\n        throw new Error(\n          `Element path must be a string at \"${stringifyNode(node)}\"`,\n        );\n      }\n\n      const path = pathProp.startsWith('/') ? pathProp.slice(1) : pathProp;\n\n      const elementProp = node.props.element;\n\n      if (getComponentData<boolean>(node, 'core.gatherMountPoints')) {\n        if (elementProp) {\n          throw new Error(\n            `Mount point gatherers may not have an element prop \"${stringifyNode(\n              node,\n            )}\"`,\n          );\n        }\n\n        const newObj = {\n          path,\n          element: 'gathered',\n          routeRefs: new Set<RouteRef>(),\n          caseSensitive: Boolean(node.props?.caseSensitive),\n          children: [MATCH_ALL_ROUTE],\n          plugins: new Set<BackstagePlugin>(),\n        };\n        parentChildren.push(newObj);\n\n        return {\n          obj: newObj,\n          gatherPath: path,\n          routeRef: ctx?.routeRef,\n          gatherRouteRef: ctx?.routeRef,\n        };\n      }\n\n      if (elementProp) {\n        const [extension, ...others] = collectSubTree(elementProp);\n        if (others.length > 0) {\n          throw new Error(\n            `Route element with path \"${pathProp}\" may not contain multiple routable extensions`,\n          );\n        }\n        if (!extension) {\n          return ctx;\n        }\n        const { routeRef, plugin } = extension;\n\n        const newObj = {\n          path,\n          element: 'mounted',\n          routeRefs: new Set([routeRef]),\n          caseSensitive: Boolean(node.props?.caseSensitive),\n          children: [MATCH_ALL_ROUTE],\n          plugins: pluginSet(plugin),\n        };\n        parentChildren.push(newObj);\n        acc.paths.set(routeRef, path);\n        acc.parents.set(routeRef, ctx?.routeRef);\n\n        return {\n          obj: newObj,\n          routeRef: routeRef ?? ctx?.routeRef,\n          gatherPath: path,\n          gatherRouteRef: ctx?.gatherRouteRef,\n        };\n      }\n    }\n\n    if (mountPoint) {\n      if (ctx?.gatherPath === undefined) {\n        throw new Error(\n          `Routable extension \"${stringifyNode(\n            node,\n          )}\" with mount point \"${mountPoint}\" must be assigned a path`,\n        );\n      }\n\n      ctx?.obj?.routeRefs.add(mountPoint);\n\n      const mountPointPlugin = getComponentData<BackstagePlugin>(\n        node,\n        'core.plugin',\n      );\n      if (mountPointPlugin) {\n        ctx?.obj?.plugins.add(mountPointPlugin);\n      }\n\n      acc.paths.set(mountPoint, ctx.gatherPath);\n      acc.parents.set(mountPoint, ctx?.gatherRouteRef);\n\n      return {\n        ...ctx,\n        routeRef: mountPoint,\n      };\n    }\n\n    return ctx;\n  },\n);\n\ninterface RoutingV1CollectorContext {\n  path?: string;\n  routeRef?: RouteRef;\n  obj?: BackstageRouteObject;\n  sticky?: boolean;\n}\n\n/**\n * This is the old V1 logic for collecting the routing model.\n * It is being replaced by a new collector because this collection\n * logic does not work well beyond react-router v6 beta.\n *\n * The breaking change is that react-router now requires route\n * elements to be `Route` components, and directly renders the\n * element prop rather than the `Route` itself. This means it is\n * no longer possible to create utility route components. In order\n * to fill this gap and in general simplify the route collection\n * logic, a new route collection logic is created.\n *\n * @internal\n */\nexport const routingV1Collector = createCollector(\n  () => ({\n    paths: new Map<RouteRef, string>(),\n    parents: new Map<RouteRef, RouteRef | undefined>(),\n    objects: new Array<BackstageRouteObject>(),\n  }),\n  (acc, node, parent, ctx?: RoutingV1CollectorContext) => {\n    // Ignore the top-level element within element props, since it's already been collected.\n    if (parent?.props.element === node) {\n      return ctx;\n    }\n\n    let currentObj = ctx?.obj;\n    let currentParentRouteRef = ctx?.routeRef;\n    let sticky = ctx?.sticky;\n\n    const path: string | undefined = node.props?.path;\n    const parentChildren = currentObj?.children ?? acc.objects;\n    const caseSensitive: boolean = Boolean(node.props?.caseSensitive);\n\n    // The context path is used during mount point gathering to assign the same path\n    // to all discovered mount points\n    let currentCtxPath = ctx?.path;\n\n    // Start gathering mount points when we encounter a mount point gathering flag\n    if (getComponentData<boolean>(node, 'core.gatherMountPoints')) {\n      if (!path) {\n        throw new Error('Mount point gatherer must have a path');\n      }\n      currentCtxPath = path;\n    }\n\n    // Route refs are discovered on the element itself, and on the top-level\n    // element within the element prop if it exists.\n    const element = node.props?.element;\n    let routeRef = getComponentData<RouteRef>(node, 'core.mountPoint');\n    if (!routeRef && isValidElement(element)) {\n      routeRef = getComponentData<RouteRef>(element, 'core.mountPoint');\n    }\n\n    if (routeRef) {\n      // First the path gathering\n\n      let routePath: string | undefined = path;\n      // If we're gathering mount points we use the context path as out path, unless\n      // the element has its own path, in which case we use that instead and stop gathering\n      if (currentCtxPath) {\n        if (routePath) {\n          currentCtxPath = undefined;\n        } else {\n          routePath = currentCtxPath;\n        }\n      }\n      if (!routePath) {\n        throw new Error('Mounted routable extension must have a path');\n      }\n      acc.paths.set(routeRef, routePath);\n\n      // Then the parent gathering\n\n      // \"sticky\" route ref is when we've encountered a mount point gatherer, and we want a\n      // mount points beneath it to have the same parent, regardless of internal structure\n      if (currentParentRouteRef && sticky) {\n        acc.parents.set(routeRef, currentParentRouteRef);\n\n        // When we encounter a mount point with an explicit path, we stop gathering\n        // mount points within the children and remove the sticky state\n        if (path) {\n          currentParentRouteRef = routeRef;\n          sticky = false;\n        }\n      } else {\n        acc.parents.set(routeRef, currentParentRouteRef);\n        currentParentRouteRef = routeRef;\n      }\n\n      // Then construct the objects\n\n      if (path) {\n        currentObj = {\n          caseSensitive,\n          path,\n          element: 'mounted',\n          routeRefs: new Set([routeRef]),\n          children: [MATCH_ALL_ROUTE],\n          plugins: pluginSet(\n            getComponentData<BackstagePlugin>(\n              node.props.element,\n              'core.plugin',\n            ),\n          ),\n        };\n        parentChildren.push(currentObj);\n      } else {\n        currentObj?.routeRefs.add(routeRef);\n      }\n    }\n\n    if (getComponentData<boolean>(node, 'core.gatherMountPoints')) {\n      sticky = true;\n    }\n\n    const isGatherer = getComponentData<boolean>(\n      node,\n      'core.gatherMountPoints',\n    );\n    if (isGatherer) {\n      if (!path) {\n        throw new Error('Mount point gatherer must have a path');\n      }\n      if (!routeRef) {\n        currentObj = {\n          caseSensitive,\n          path,\n          element: 'gathered',\n          routeRefs: new Set(),\n          children: [MATCH_ALL_ROUTE],\n          plugins: ctx?.obj?.plugins || new Set(),\n        };\n        parentChildren.push(currentObj);\n      }\n    }\n\n    return {\n      obj: currentObj,\n      path: currentCtxPath,\n      routeRef: currentParentRouteRef,\n      sticky,\n    };\n  },\n);\n\nexport const featureFlagCollector = createCollector(\n  () => new Set<string>(),\n  (acc, node) => {\n    if (node.type === FeatureFlagged) {\n      const props = node.props as FeatureFlaggedProps;\n      acc.add('with' in props ? props.with : props.without);\n    }\n  },\n);\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  RouteRef,\n  SubRouteRef,\n  ExternalRouteRef,\n  BackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { getOrCreateGlobalSingleton } from '@backstage/version-bridge';\n\ntype RouteRefType = Exclude<\n  keyof RouteRef,\n  'params' | 'path' | 'title' | 'icon'\n>;\nexport const routeRefType: RouteRefType = getOrCreateGlobalSingleton<any>(\n  'route-ref-type',\n  () => Symbol('route-ref-type'),\n);\n\nexport type AnyParams = { [param in string]: string } | undefined;\n\nexport type AnyRouteRef =\n  | RouteRef<any>\n  | SubRouteRef<any>\n  | ExternalRouteRef<any, any>;\n\n// The extra TS magic here is to require a single params argument if the RouteRef\n// had at least one param defined, but require 0 arguments if there are no params defined.\n// Without this we'd have to pass in empty object to all parameter-less RouteRefs\n// just to make TypeScript happy, or we would have to make the argument optional in\n// which case you might forget to pass it in when it is actually required.\nexport type RouteFunc<Params extends AnyParams> = (\n  ...[params]: Params extends undefined ? readonly [] : readonly [Params]\n) => string;\n\n// A duplicate of the react-router RouteObject, but with routeRef added\nexport interface BackstageRouteObject {\n  caseSensitive: boolean;\n  children?: BackstageRouteObject[];\n  element: React.ReactNode;\n  path: string;\n  routeRefs: Set<RouteRef>;\n  plugins: Set<BackstagePlugin>;\n}\n\nexport function isRouteRef<Params extends AnyParams>(\n  routeRef:\n    | RouteRef<Params>\n    | SubRouteRef<Params>\n    | ExternalRouteRef<Params, any>,\n): routeRef is RouteRef<Params> {\n  return routeRef[routeRefType] === 'absolute';\n}\n\nexport function isSubRouteRef<Params extends AnyParams>(\n  routeRef:\n    | RouteRef<Params>\n    | SubRouteRef<Params>\n    | ExternalRouteRef<Params, any>,\n): routeRef is SubRouteRef<Params> {\n  return routeRef[routeRefType] === 'sub';\n}\n\nexport function isExternalRouteRef<\n  Params extends AnyParams,\n  Optional extends boolean,\n>(\n  routeRef:\n    | RouteRef<Params>\n    | SubRouteRef<Params>\n    | ExternalRouteRef<Params, Optional>,\n): routeRef is ExternalRouteRef<Params, Optional> {\n  return routeRef[routeRefType] === 'external';\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Joins a list of paths together, avoiding trailing and duplicate slashes\nexport function joinPaths(...paths: string[]): string {\n  const normalized = paths.join('/').replace(/\\/\\/+/g, '/');\n  if (normalized !== '/' && normalized.endsWith('/')) {\n    return normalized.slice(0, -1);\n  }\n  return normalized;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { generatePath, matchRoutes } from 'react-router-dom';\nimport {\n  AnyRouteRef,\n  BackstageRouteObject,\n  AnyParams,\n  RouteFunc,\n  routeRefType,\n  isRouteRef,\n  isSubRouteRef,\n  isExternalRouteRef,\n} from './types';\nimport {\n  RouteRef,\n  ExternalRouteRef,\n  SubRouteRef,\n} from '@backstage/core-plugin-api';\nimport { joinPaths } from './helpers';\nimport mapValues from 'lodash/mapValues';\n\n/**\n * Resolves the absolute route ref that our target route ref is pointing pointing to, as well\n * as the relative target path.\n *\n * Returns an undefined target ref if one could not be fully resolved.\n */\nfunction resolveTargetRef(\n  anyRouteRef: AnyRouteRef,\n  routePaths: Map<RouteRef, string>,\n  routeBindings: Map<AnyRouteRef, AnyRouteRef | undefined>,\n): readonly [RouteRef | undefined, string] {\n  // First we figure out which absolute route ref we're dealing with, an if there was an sub route path to append.\n  // For sub routes it will be the parent path, while for external routes it will be the bound route.\n  let targetRef: RouteRef;\n  let subRoutePath = '';\n  if (isRouteRef(anyRouteRef)) {\n    targetRef = anyRouteRef;\n  } else if (isSubRouteRef(anyRouteRef)) {\n    targetRef = anyRouteRef.parent;\n    subRoutePath = anyRouteRef.path;\n  } else if (isExternalRouteRef(anyRouteRef)) {\n    const resolvedRoute = routeBindings.get(anyRouteRef);\n    if (!resolvedRoute) {\n      return [undefined, ''];\n    }\n    if (isRouteRef(resolvedRoute)) {\n      targetRef = resolvedRoute;\n    } else if (isSubRouteRef(resolvedRoute)) {\n      targetRef = resolvedRoute.parent;\n      subRoutePath = resolvedRoute.path;\n    } else {\n      throw new Error(\n        `ExternalRouteRef was bound to invalid target, ${resolvedRoute}`,\n      );\n    }\n  } else if (anyRouteRef[routeRefType]) {\n    throw new Error(\n      `Unknown or invalid route ref type, ${anyRouteRef[routeRefType]}`,\n    );\n  } else {\n    throw new Error(`Unknown object passed to useRouteRef, got ${anyRouteRef}`);\n  }\n\n  // Bail if no absolute path could be resolved\n  if (!targetRef) {\n    return [undefined, ''];\n  }\n\n  // Find the path that our target route is bound to\n  const resolvedPath = routePaths.get(targetRef);\n  if (resolvedPath === undefined) {\n    return [undefined, ''];\n  }\n\n  // SubRouteRefs join the path from the parent route with its own path\n  const targetPath = joinPaths(resolvedPath, subRoutePath);\n  return [targetRef, targetPath];\n}\n\n/**\n * Resolves the complete base path for navigating to the target RouteRef.\n */\nfunction resolveBasePath(\n  targetRef: RouteRef,\n  sourceLocation: Parameters<typeof matchRoutes>[1],\n  routePaths: Map<RouteRef, string>,\n  routeParents: Map<RouteRef, RouteRef | undefined>,\n  routeObjects: BackstageRouteObject[],\n) {\n  // While traversing the app element tree we build up the routeObjects structure\n  // used here. It is the same kind of structure that react-router creates, with the\n  // addition that associated route refs are stored throughout the tree. This lets\n  // us look up all route refs that can be reached from our source location.\n  // Because of the similar route object structure, we can use `matchRoutes` from\n  // react-router to do the lookup of our current location.\n  const match = matchRoutes(routeObjects, sourceLocation) ?? [];\n\n  // While we search for a common routing root between our current location and\n  // the target route, we build a list of all route refs we find that we need\n  // to traverse to reach the target.\n  const refDiffList = Array<RouteRef>();\n\n  let matchIndex = -1;\n  for (\n    let targetSearchRef: RouteRef | undefined = targetRef;\n    targetSearchRef;\n    targetSearchRef = routeParents.get(targetSearchRef)\n  ) {\n    // The match contains a list of all ancestral route refs present at our current location\n    // Starting at the desired target ref and traversing back through its parents, we search\n    // for a target ref that is present in the match for our current location. When a match\n    // is found it means we have found a common base to resolve the route from.\n    matchIndex = match.findIndex(m =>\n      (m.route as BackstageRouteObject).routeRefs.has(targetSearchRef!),\n    );\n    if (matchIndex !== -1) {\n      break;\n    }\n\n    // Every time we move a step up in the ancestry of the target ref, we add the current ref\n    // to the diff list, which ends up being the list of route refs to traverse form the common base\n    // in order to reach our target.\n    refDiffList.unshift(targetSearchRef);\n  }\n\n  // If our target route is present in the initial match we need to construct the final path\n  // from the parent of the matched route segment. That's to allow the caller of the route\n  // function to supply their own params.\n  if (refDiffList.length === 0) {\n    matchIndex -= 1;\n  }\n\n  // This is the part of the route tree that the target and source locations have in common.\n  // We re-use the existing pathname directly along with all params.\n  const parentPath = matchIndex === -1 ? '' : match[matchIndex].pathname;\n\n  // This constructs the mid section of the path using paths resolved from all route refs\n  // we need to traverse to reach our target except for the very last one. None of these\n  // paths are allowed to require any parameters, as the caller would have no way of knowing\n  // what parameters those are.\n  const diffPaths = refDiffList.slice(0, -1).map(ref => {\n    const path = routePaths.get(ref);\n    if (path === undefined) {\n      throw new Error(`No path for ${ref}`);\n    }\n    if (path.includes(':')) {\n      throw new Error(\n        `Cannot route to ${targetRef} with parent ${ref} as it has parameters`,\n      );\n    }\n    return path;\n  });\n\n  return `${joinPaths(parentPath, ...diffPaths)}/`;\n}\n\nexport class RouteResolver {\n  constructor(\n    private readonly routePaths: Map<RouteRef, string>,\n    private readonly routeParents: Map<RouteRef, RouteRef | undefined>,\n    private readonly routeObjects: BackstageRouteObject[],\n    private readonly routeBindings: Map<\n      ExternalRouteRef,\n      RouteRef | SubRouteRef\n    >,\n    private readonly appBasePath: string, // base path without a trailing slash\n  ) {}\n\n  resolve<Params extends AnyParams>(\n    anyRouteRef:\n      | RouteRef<Params>\n      | SubRouteRef<Params>\n      | ExternalRouteRef<Params, any>,\n    sourceLocation: Parameters<typeof matchRoutes>[1],\n  ): RouteFunc<Params> | undefined {\n    // First figure out what our target absolute ref is, as well as our target path.\n    const [targetRef, targetPath] = resolveTargetRef(\n      anyRouteRef,\n      this.routePaths,\n      this.routeBindings,\n    );\n    if (!targetRef) {\n      return undefined;\n    }\n\n    // The location that we get passed in uses the full path, so start by trimming off\n    // the app base path prefix in case we're running the app on a sub-path.\n    let relativeSourceLocation: Parameters<typeof matchRoutes>[1];\n    if (typeof sourceLocation === 'string') {\n      relativeSourceLocation = this.trimPath(sourceLocation);\n    } else if (sourceLocation.pathname) {\n      relativeSourceLocation = {\n        ...sourceLocation,\n        pathname: this.trimPath(sourceLocation.pathname),\n      };\n    } else {\n      relativeSourceLocation = sourceLocation;\n    }\n\n    // Next we figure out the base path, which is the combination of the common parent path\n    // between our current location and our target location, as well as the additional path\n    // that is the difference between the parent path and the base of our target location.\n    const basePath =\n      this.appBasePath +\n      resolveBasePath(\n        targetRef,\n        relativeSourceLocation,\n        this.routePaths,\n        this.routeParents,\n        this.routeObjects,\n      );\n\n    const routeFunc: RouteFunc<Params> = (...[params]) => {\n      // We selectively encode some some known-dangerous characters in the\n      // params. The reason that we don't perform a blanket `encodeURIComponent`\n      // here is that this encoding was added defensively long after the initial\n      // release of this code. There's likely to be many users of this code that\n      // already encode their parameters knowing that this code didn't do this\n      // for them in the past. Therefore, we are extra careful NOT to include\n      // the percent character in this set, even though that might seem like a\n      // bad idea.\n      const encodedParams =\n        params &&\n        mapValues(params, value => {\n          if (typeof value === 'string') {\n            return value.replaceAll(/[&?#;\\/]/g, c => encodeURIComponent(c));\n          }\n          return value;\n        });\n      return joinPaths(basePath, generatePath(targetPath, encodedParams));\n    };\n    return routeFunc;\n  }\n\n  private trimPath(targetPath: string) {\n    if (!targetPath) {\n      return targetPath;\n    }\n\n    if (targetPath.startsWith(this.appBasePath)) {\n      return targetPath.slice(this.appBasePath.length);\n    }\n    return targetPath;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { ReactNode } from 'react';\nimport {\n  ExternalRouteRef,\n  RouteRef,\n  SubRouteRef,\n} from '@backstage/core-plugin-api';\nimport {\n  createVersionedValueMap,\n  createVersionedContext,\n} from '@backstage/version-bridge';\nimport { RouteResolver } from './RouteResolver';\nimport { BackstageRouteObject } from './types';\n\nconst RoutingContext = createVersionedContext<{ 1: RouteResolver }>(\n  'routing-context',\n);\n\ntype ProviderProps = {\n  routePaths: Map<RouteRef, string>;\n  routeParents: Map<RouteRef, RouteRef | undefined>;\n  routeObjects: BackstageRouteObject[];\n  routeBindings: Map<ExternalRouteRef, RouteRef | SubRouteRef>;\n  basePath?: string;\n  children: ReactNode;\n};\n\nexport const RoutingProvider = ({\n  routePaths,\n  routeParents,\n  routeObjects,\n  routeBindings,\n  basePath = '',\n  children,\n}: ProviderProps) => {\n  const resolver = new RouteResolver(\n    routePaths,\n    routeParents,\n    routeObjects,\n    routeBindings,\n    basePath,\n  );\n\n  const versionedValue = createVersionedValueMap({ 1: resolver });\n  return (\n    <RoutingContext.Provider value={versionedValue}>\n      {children}\n    </RoutingContext.Provider>\n  );\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstagePlugin,\n  ExternalRouteRef,\n  RouteRef,\n  SubRouteRef,\n} from '@backstage/core-plugin-api';\nimport { joinPaths } from './helpers';\nimport { AnyRouteRef } from './types';\n\n// Validates that there is no duplication of route parameter names\nexport function validateRouteParameters(\n  routePaths: Map<AnyRouteRef, string>,\n  routeParents: Map<AnyRouteRef, AnyRouteRef | undefined>,\n) {\n  const notLeafRoutes = new Set(routeParents.values());\n  notLeafRoutes.delete(undefined);\n\n  for (const route of routeParents.keys()) {\n    if (notLeafRoutes.has(route)) {\n      continue;\n    }\n\n    let currentRouteRef: AnyRouteRef | undefined = route;\n\n    let fullPath = '';\n    while (currentRouteRef) {\n      const path = routePaths.get(currentRouteRef);\n      if (path === undefined) {\n        throw new Error(`No path for ${currentRouteRef}`);\n      }\n      fullPath = joinPaths(path, fullPath);\n      currentRouteRef = routeParents.get(currentRouteRef);\n    }\n\n    const params = fullPath.match(/:(\\w+)/g);\n    if (params) {\n      for (let j = 0; j < params.length; j++) {\n        for (let i = j + 1; i < params.length; i++) {\n          if (params[i] === params[j]) {\n            throw new Error(\n              `Parameter ${params[i]} is duplicated in path ${fullPath}`,\n            );\n          }\n        }\n      }\n    }\n  }\n}\n\n// Validates that all non-optional external routes have been bound\nexport function validateRouteBindings(\n  routeBindings: Map<ExternalRouteRef, RouteRef | SubRouteRef>,\n  plugins: Iterable<BackstagePlugin<{}, Record<string, ExternalRouteRef>>>,\n) {\n  for (const plugin of plugins) {\n    if (!plugin.externalRoutes) {\n      continue;\n    }\n\n    for (const [name, externalRouteRef] of Object.entries(\n      plugin.externalRoutes,\n    )) {\n      if (externalRouteRef.optional) {\n        continue;\n      }\n\n      if (!routeBindings.has(externalRouteRef)) {\n        throw new Error(\n          `External route '${name}' of the '${plugin.getId()}' plugin must be bound to a target route. ` +\n            'See https://backstage.io/link?bind-routes for details.',\n        );\n      }\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { PropsWithChildren } from 'react';\nimport {\n  createVersionedValueMap,\n  createVersionedContext,\n} from '@backstage/version-bridge';\nimport { AppContext as AppContextV1 } from './types';\n\nconst AppContext = createVersionedContext<{ 1: AppContextV1 }>('app-context');\n\ntype Props = {\n  appContext: AppContextV1;\n};\n\nexport const AppContextProvider = ({\n  appContext,\n  children,\n}: PropsWithChildren<Props>) => {\n  const versionedValue = createVersionedValueMap({ 1: appContext });\n\n  return <AppContext.Provider value={versionedValue} children={children} />;\n};\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  IdentityApi,\n  ProfileInfo,\n  BackstageUserIdentity,\n} from '@backstage/core-plugin-api';\n\nfunction mkError(thing: string) {\n  return new Error(\n    `Tried to access IdentityApi ${thing} before app was loaded`,\n  );\n}\n\nfunction logDeprecation(thing: string) {\n  // eslint-disable-next-line no-console\n  console.warn(\n    `WARNING: Call to ${thing} is deprecated and will break in the future`,\n  );\n}\n\n// We use this for a period of backwards compatibility. It is a hidden\n// compatibility that will allow old plugins to continue working for a limited time.\ntype CompatibilityIdentityApi = IdentityApi & {\n  getUserId?(): string;\n  getIdToken?(): Promise<string | undefined>;\n  getProfile?(): ProfileInfo;\n};\n\n/**\n * Implementation of the connection between the App-wide IdentityApi\n * and sign-in page.\n */\nexport class AppIdentityProxy implements IdentityApi {\n  private target?: CompatibilityIdentityApi;\n  private waitForTarget: Promise<CompatibilityIdentityApi>;\n  private resolveTarget: (api: CompatibilityIdentityApi) => void = () => {};\n  private signOutTargetUrl = '/';\n\n  constructor() {\n    this.waitForTarget = new Promise<CompatibilityIdentityApi>(resolve => {\n      this.resolveTarget = resolve;\n    });\n  }\n\n  // This is called by the app manager once the sign-in page provides us with an implementation\n  setTarget(\n    identityApi: CompatibilityIdentityApi,\n    targetOptions: { signOutTargetUrl: string },\n  ) {\n    this.target = identityApi;\n    this.signOutTargetUrl = targetOptions.signOutTargetUrl;\n    this.resolveTarget(identityApi);\n  }\n\n  getUserId(): string {\n    if (!this.target) {\n      throw mkError('getUserId');\n    }\n    if (!this.target.getUserId) {\n      throw new Error('IdentityApi does not implement getUserId');\n    }\n    logDeprecation('getUserId');\n    return this.target.getUserId();\n  }\n\n  getProfile(): ProfileInfo {\n    if (!this.target) {\n      throw mkError('getProfile');\n    }\n    if (!this.target.getProfile) {\n      throw new Error('IdentityApi does not implement getProfile');\n    }\n    logDeprecation('getProfile');\n    return this.target.getProfile();\n  }\n\n  async getProfileInfo(): Promise<ProfileInfo> {\n    return this.waitForTarget.then(target => target.getProfileInfo());\n  }\n\n  async getBackstageIdentity(): Promise<BackstageUserIdentity> {\n    const identity = await this.waitForTarget.then(target =>\n      target.getBackstageIdentity(),\n    );\n    if (!identity.userEntityRef.match(/^.*:.*\\/.*$/)) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `WARNING: The App IdentityApi provided an invalid userEntityRef, '${identity.userEntityRef}'. ` +\n          `It must be a full Entity Reference of the form '<kind>:<namespace>/<name>'.`,\n      );\n    }\n\n    return identity;\n  }\n\n  async getCredentials(): Promise<{ token?: string | undefined }> {\n    return this.waitForTarget.then(target => target.getCredentials());\n  }\n\n  async getIdToken(): Promise<string | undefined> {\n    return this.waitForTarget.then(target => {\n      if (!target.getIdToken) {\n        throw new Error('IdentityApi does not implement getIdToken');\n      }\n      logDeprecation('getIdToken');\n      return target.getIdToken();\n    });\n  }\n\n  async signOut(): Promise<void> {\n    await this.waitForTarget.then(target => target.signOut());\n    window.location.href = this.signOutTargetUrl;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useMemo, useEffect, useState, PropsWithChildren } from 'react';\nimport { useApi, appThemeApiRef, AppTheme } from '@backstage/core-plugin-api';\nimport useObservable from 'react-use/lib/useObservable';\n\n// This tries to find the most accurate match, but also falls back to less\n// accurate results in order to avoid errors.\nfunction resolveTheme(\n  themeId: string | undefined,\n  shouldPreferDark: boolean,\n  themes: AppTheme[],\n) {\n  if (themeId !== undefined) {\n    const selectedTheme = themes.find(theme => theme.id === themeId);\n    if (selectedTheme) {\n      return selectedTheme;\n    }\n  }\n\n  if (shouldPreferDark) {\n    const darkTheme = themes.find(theme => theme.variant === 'dark');\n    if (darkTheme) {\n      return darkTheme;\n    }\n  }\n\n  const lightTheme = themes.find(theme => theme.variant === 'light');\n  if (lightTheme) {\n    return lightTheme;\n  }\n\n  return themes[0];\n}\n\nconst useShouldPreferDarkTheme = () => {\n  const mediaQuery = useMemo(\n    () => window.matchMedia('(prefers-color-scheme: dark)'),\n    [],\n  );\n  const [shouldPreferDark, setPrefersDark] = useState(mediaQuery.matches);\n\n  useEffect(() => {\n    const listener = (event: MediaQueryListEvent) => {\n      setPrefersDark(event.matches);\n    };\n    mediaQuery.addListener(listener);\n    return () => {\n      mediaQuery.removeListener(listener);\n    };\n  }, [mediaQuery]);\n\n  return shouldPreferDark;\n};\n\nexport function AppThemeProvider({ children }: PropsWithChildren<{}>) {\n  const appThemeApi = useApi(appThemeApiRef);\n  const themeId = useObservable(\n    appThemeApi.activeThemeId$(),\n    appThemeApi.getActiveThemeId(),\n  );\n\n  // Browser feature detection won't change over time, so ignore lint rule\n  const shouldPreferDark = Boolean(window.matchMedia)\n    ? useShouldPreferDarkTheme() // eslint-disable-line react-hooks/rules-of-hooks\n    : false;\n\n  const appTheme = resolveTheme(\n    themeId,\n    shouldPreferDark,\n    appThemeApi.getInstalledThemes(),\n  );\n  if (!appTheme) {\n    throw new Error('App has no themes');\n  }\n\n  return <appTheme.Provider children={children} />;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { AppConfigLoader } from './types';\n\n/**\n * The default config loader, which expects that config is available at compile-time\n * in `process.env.APP_CONFIG`. APP_CONFIG should be an array of config objects as\n * returned by the config loader.\n *\n * It will also load runtime config from the __APP_INJECTED_RUNTIME_CONFIG__ string,\n * which can be rewritten at runtime to contain an additional JSON config object.\n * If runtime config is present, it will be placed first in the config array, overriding\n * other config values.\n *\n * @public\n */\nexport const defaultConfigLoader: AppConfigLoader = async () =>\n  defaultConfigLoaderSync();\n\n/** @internal */\nexport function defaultConfigLoaderSync(\n  // This string may be replaced at runtime to provide additional config.\n  // It should be replaced by a JSON-serialized config object.\n  // It's a param so we can test it, but at runtime this will always fall back to default.\n  runtimeConfigJson: string = '__APP_INJECTED_RUNTIME_CONFIG__',\n) {\n  const appConfig = process.env.APP_CONFIG;\n  if (!appConfig) {\n    throw new Error('No static configuration provided');\n  }\n  if (!Array.isArray(appConfig)) {\n    throw new Error('Static configuration has invalid format');\n  }\n  const configs = appConfig.slice() as unknown as AppConfig[];\n\n  // Avoiding this string also being replaced at runtime\n  if (\n    runtimeConfigJson !==\n    '__app_injected_runtime_config__'.toLocaleUpperCase('en-US')\n  ) {\n    try {\n      const data = JSON.parse(runtimeConfigJson) as JsonObject;\n      if (Array.isArray(data)) {\n        configs.push(...data);\n      } else {\n        configs.push({ data, context: 'env' });\n      }\n    } catch (error) {\n      throw new Error(`Failed to load runtime configuration, ${error}`);\n    }\n  }\n\n  const windowAppConfig = (window as any).__APP_CONFIG__;\n  if (windowAppConfig) {\n    configs.push({\n      context: 'window',\n      data: windowAppConfig,\n    });\n  }\n  return configs;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiRef, ApiHolder } from '@backstage/core-plugin-api';\n\ntype ApiImpl<T = unknown> = readonly [ApiRef<T>, T];\n\n/** @internal */\nclass ApiRegistryBuilder {\n  private apis: [string, unknown][] = [];\n\n  add<T, I extends T>(api: ApiRef<T>, impl: I): I {\n    this.apis.push([api.id, impl]);\n    return impl;\n  }\n\n  build(): ApiRegistry {\n    // eslint-disable-next-line @typescript-eslint/no-use-before-define\n    return new ApiRegistry(new Map(this.apis));\n  }\n}\n\n/**\n * A registry for utility APIs.\n *\n * @internal\n */\nexport class ApiRegistry implements ApiHolder {\n  static builder() {\n    return new ApiRegistryBuilder();\n  }\n\n  /**\n   * Creates a new ApiRegistry with a list of API implementations.\n   *\n   * @param apis - A list of pairs mapping an ApiRef to its respective implementation\n   */\n  static from(apis: ApiImpl[]) {\n    return new ApiRegistry(new Map(apis.map(([api, impl]) => [api.id, impl])));\n  }\n\n  /**\n   * Creates a new ApiRegistry with a single API implementation.\n   *\n   * @param api - ApiRef for the API to add\n   * @param impl - Implementation of the API to add\n   */\n  static with<T>(api: ApiRef<T>, impl: T): ApiRegistry {\n    return new ApiRegistry(new Map([[api.id, impl]]));\n  }\n\n  constructor(private readonly apis: Map<string, unknown>) {}\n\n  /**\n   * Returns a new ApiRegistry with the provided API added to the existing ones.\n   *\n   * @param api - ApiRef for the API to add\n   * @param impl - Implementation of the API to add\n   */\n  with<T>(api: ApiRef<T>, impl: T): ApiRegistry {\n    return new ApiRegistry(new Map([...this.apis, [api.id, impl]]));\n  }\n\n  get<T>(api: ApiRef<T>): T | undefined {\n    return this.apis.get(api.id) as T | undefined;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  RouteRef,\n  SubRouteRef,\n  ExternalRouteRef,\n} from '@backstage/core-plugin-api';\nimport { AppOptions, AppRouteBinder } from './types';\n\nexport function resolveRouteBindings(bindRoutes: AppOptions['bindRoutes']) {\n  const result = new Map<ExternalRouteRef, RouteRef | SubRouteRef>();\n\n  if (bindRoutes) {\n    const bind: AppRouteBinder = (\n      externalRoutes,\n      targetRoutes: { [name: string]: RouteRef | SubRouteRef },\n    ) => {\n      for (const [key, value] of Object.entries(targetRoutes)) {\n        const externalRoute = externalRoutes[key];\n        if (!externalRoute) {\n          throw new Error(`Key ${key} is not an existing external route`);\n        }\n        if (!value && !externalRoute.optional) {\n          throw new Error(\n            `External route ${key} is required but was undefined`,\n          );\n        }\n        if (value) {\n          result.set(externalRoute, value);\n        }\n      }\n    };\n    bindRoutes({ bind });\n  }\n\n  return result;\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Internal import to avoid code duplication, this will lead to duplication in build output\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { AppLanguageApi } from '@backstage/core-plugin-api/alpha';\nimport { Observable } from '@backstage/types';\nimport { BehaviorSubject } from '../../../lib';\n\nconst STORAGE_KEY = 'language';\nexport const DEFAULT_LANGUAGE = 'en';\n\n/** @alpha */\nexport interface AppLanguageSelectorOptions {\n  defaultLanguage?: string;\n  availableLanguages?: string[];\n}\n\n/**\n * Exposes the available languages in the app and allows for switching of the active language.\n *\n * @alpha\n */\nexport class AppLanguageSelector implements AppLanguageApi {\n  static create(options?: AppLanguageSelectorOptions) {\n    const languages = options?.availableLanguages ?? [DEFAULT_LANGUAGE];\n    if (languages.length !== new Set(languages).size) {\n      throw new Error(\n        `Supported languages may not contain duplicates, got '${languages.join(\n          \"', '\",\n        )}'`,\n      );\n    }\n    if (!languages.includes(DEFAULT_LANGUAGE)) {\n      throw new Error(`Supported languages must include '${DEFAULT_LANGUAGE}'`);\n    }\n\n    const initialLanguage = options?.defaultLanguage ?? DEFAULT_LANGUAGE;\n    if (!languages.includes(initialLanguage)) {\n      throw new Error(\n        `Initial language must be one of the supported languages, got '${initialLanguage}'`,\n      );\n    }\n\n    return new AppLanguageSelector(languages, initialLanguage);\n  }\n\n  static createWithStorage(options?: AppLanguageSelectorOptions) {\n    const selector = AppLanguageSelector.create(options);\n\n    if (!window.localStorage) {\n      return selector;\n    }\n\n    const storedLanguage = window.localStorage.getItem(STORAGE_KEY);\n    const { languages } = selector.getAvailableLanguages();\n    if (storedLanguage && languages.includes(storedLanguage)) {\n      selector.setLanguage(storedLanguage);\n    }\n\n    selector.language$().subscribe(({ language }) => {\n      if (language !== window.localStorage.getItem(STORAGE_KEY)) {\n        window.localStorage.setItem(STORAGE_KEY, language);\n      }\n    });\n\n    window.addEventListener('storage', event => {\n      if (event.key === STORAGE_KEY) {\n        const language = localStorage.getItem(STORAGE_KEY) ?? undefined;\n        if (language) {\n          selector.setLanguage(language);\n        }\n      }\n    });\n\n    return selector;\n  }\n\n  #languages: string[];\n  #language: string;\n  #subject: BehaviorSubject<{ language: string }>;\n\n  private constructor(languages: string[], initialLanguage: string) {\n    this.#languages = languages;\n    this.#language = initialLanguage;\n    this.#subject = new BehaviorSubject<{ language: string }>({\n      language: this.#language,\n    });\n  }\n\n  getAvailableLanguages(): { languages: string[] } {\n    return { languages: this.#languages.slice() };\n  }\n\n  setLanguage(language?: string | undefined): void {\n    const lng = language ?? DEFAULT_LANGUAGE;\n    if (lng === this.#language) {\n      return;\n    }\n    if (lng && !this.#languages.includes(lng)) {\n      throw new Error(\n        `Failed to change language to '${lng}', available languages are '${this.#languages.join(\n          \"', '\",\n        )}'`,\n      );\n    }\n    this.#language = lng;\n    this.#subject.next({ language: lng });\n  }\n\n  getLanguage(): { language: string } {\n    return { language: this.#language };\n  }\n\n  language$(): Observable<{ language: string }> {\n    return this.#subject;\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  TranslationMessages,\n  TranslationRef,\n} from '@backstage/core-plugin-api/alpha';\n\n/** @alpha */\nexport interface TranslationResource<TId extends string = string> {\n  $$type: '@backstage/TranslationResource';\n  id: TId;\n}\n\n/** @internal */\nexport type InternalTranslationResourceLoader = () => Promise<{\n  messages: { [key in string]: string | null };\n}>;\n\n/** @internal */\nexport interface InternalTranslationResource<TId extends string = string>\n  extends TranslationResource<TId> {\n  version: 'v1';\n  resources: Array<{\n    language: string;\n    loader: InternalTranslationResourceLoader;\n  }>;\n}\n\n/** @internal */\nexport function toInternalTranslationResource<TId extends string>(\n  resource: TranslationResource<TId>,\n): InternalTranslationResource<TId> {\n  const r = resource as InternalTranslationResource<TId>;\n  if (r.$$type !== '@backstage/TranslationResource') {\n    throw new Error(`Invalid translation resource, bad type '${r.$$type}'`);\n  }\n  if (r.version !== 'v1') {\n    throw new Error(`Invalid translation resource, bad version '${r.version}'`);\n  }\n\n  return r;\n}\n\n/** @alpha */\nexport interface TranslationResourceOptions<\n  TId extends string,\n  TMessages extends { [key in string]: string },\n  TTranslations extends {\n    [language in string]: () => Promise<{\n      default:\n        | TranslationMessages<TId>\n        | { [key in keyof TMessages]: string | null };\n    }>;\n  },\n> {\n  ref: TranslationRef<TId, TMessages>;\n\n  translations: TTranslations;\n}\n\n/** @alpha */\nexport function createTranslationResource<\n  TId extends string,\n  TMessages extends { [key in string]: string },\n  TTranslations extends {\n    [language in string]: () => Promise<{\n      default:\n        | TranslationMessages<TId>\n        | { [key in keyof TMessages]: string | null };\n    }>;\n  },\n>(\n  options: TranslationResourceOptions<TId, TMessages, TTranslations>,\n): TranslationResource<TId> {\n  return {\n    $$type: '@backstage/TranslationResource',\n    version: 'v1',\n    id: options.ref.id,\n    resources: Object.entries(options.translations).map(\n      ([language, loader]) => ({\n        language,\n        loader: () =>\n          loader().then(m => {\n            const value = m.default;\n            return {\n              messages:\n                value?.$$type === '@backstage/TranslationMessages'\n                  ? value.messages\n                  : value,\n            };\n          }),\n      }),\n    ),\n  } as InternalTranslationResource<TId>;\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  createTranslationResource,\n  TranslationResource,\n} from './TranslationResource';\n\n/** @alpha */\nexport interface TranslationRef<\n  TId extends string = string,\n  TMessages extends { [key in string]: string } = { [key in string]: string },\n> {\n  $$type: '@backstage/TranslationRef';\n\n  id: TId;\n\n  T: TMessages;\n}\n\n/** @internal */\ntype AnyMessages = { [key in string]: string };\n\n/** @ignore */\ntype AnyNestedMessages = { [key in string]: AnyNestedMessages | string };\n\n/**\n * Flattens a nested message declaration into a flat object with dot-separated keys.\n *\n * @ignore\n */\ntype FlattenedMessages<TMessages extends AnyNestedMessages> =\n  // Flatten out object keys into a union structure of objects, e.g. { a: 'a', b: 'b' } -> { a: 'a' } | { b: 'b' }\n  // Any nested object will be flattened into the individual unions, e.g. { a: 'a', b: { x: 'x', y: 'y' } } -> { a: 'a' } | { 'b.x': 'x', 'b.y': 'y' }\n  // We create this structure by first nesting the desired union types into the original object, and\n  // then extract them by indexing with `keyof TMessages` to form the union.\n  // Throughout this the objects are wrapped up in a function parameter, which allows us to have the\n  // final step of flipping this unions around to an intersection by inferring the function parameter.\n  {\n    [TKey in keyof TMessages]: (\n      _: TMessages[TKey] extends infer TValue // \"local variable\" for the value\n        ? TValue extends AnyNestedMessages\n          ? FlattenedMessages<TValue> extends infer TNested // Recurse into nested messages, \"local variable\" for the result\n            ? {\n                [TNestedKey in keyof TNested as `${TKey & string}.${TNestedKey &\n                  string}`]: TNested[TNestedKey];\n              }\n            : never\n          : { [_ in TKey]: TValue } // Primitive object values are passed through with the same key\n        : never,\n    ) => void;\n    // The `[keyof TMessages]` extracts the object values union from our flattened structure, still wrapped up in function parameters.\n    // The `extends (_: infer TIntersection) => void` flips the union to an intersection, at which point we have the correct type.\n  }[keyof TMessages] extends (_: infer TIntersection) => void\n    ? // This object mapping just expands similar to the Expand<> utility type, providing nicer type hints\n      {\n        readonly [TExpandKey in keyof TIntersection]: TIntersection[TExpandKey];\n      }\n    : never;\n\n/** @internal */\nexport interface InternalTranslationRef<\n  TId extends string = string,\n  TMessages extends { [key in string]: string } = { [key in string]: string },\n> extends TranslationRef<TId, TMessages> {\n  version: 'v1';\n\n  getDefaultMessages(): AnyMessages;\n\n  getDefaultResource(): TranslationResource | undefined;\n}\n\n/** @alpha */\nexport interface TranslationRefOptions<\n  TId extends string,\n  TNestedMessages extends AnyNestedMessages,\n  TTranslations extends {\n    [language in string]: () => Promise<{\n      default: {\n        [key in keyof FlattenedMessages<TNestedMessages>]: string | null;\n      };\n    }>;\n  },\n> {\n  id: TId;\n  messages: TNestedMessages;\n  translations?: TTranslations;\n}\n\nfunction flattenMessages(nested: AnyNestedMessages): AnyMessages {\n  const entries = new Array<[string, string]>();\n\n  function visit(obj: AnyNestedMessages, prefix: string): void {\n    for (const [key, value] of Object.entries(obj)) {\n      if (typeof value === 'string') {\n        entries.push([prefix + key, value]);\n      } else {\n        visit(value, `${prefix}${key}.`);\n      }\n    }\n  }\n\n  visit(nested, '');\n\n  return Object.fromEntries(entries);\n}\n\n/** @internal */\nclass TranslationRefImpl<\n  TId extends string,\n  TNestedMessages extends AnyNestedMessages,\n> implements InternalTranslationRef<TId, FlattenedMessages<TNestedMessages>>\n{\n  #id: TId;\n  #messages: FlattenedMessages<TNestedMessages>;\n  #resources: TranslationResource | undefined;\n\n  constructor(options: TranslationRefOptions<TId, TNestedMessages, any>) {\n    this.#id = options.id;\n    this.#messages = flattenMessages(\n      options.messages,\n    ) as FlattenedMessages<TNestedMessages>;\n  }\n\n  $$type = '@backstage/TranslationRef' as const;\n\n  version = 'v1' as const;\n\n  get id(): TId {\n    return this.#id;\n  }\n\n  get T(): never {\n    throw new Error('Not implemented');\n  }\n\n  getDefaultMessages(): AnyMessages {\n    return this.#messages;\n  }\n\n  setDefaultResource(resources: TranslationResource): void {\n    this.#resources = resources;\n  }\n\n  getDefaultResource(): TranslationResource | undefined {\n    return this.#resources;\n  }\n\n  toString() {\n    return `TranslationRef{id=${this.id}}`;\n  }\n}\n\n/** @alpha */\nexport function createTranslationRef<\n  TId extends string,\n  const TNestedMessages extends AnyNestedMessages,\n  TTranslations extends {\n    [language in string]: () => Promise<{\n      default: {\n        [key in keyof FlattenedMessages<TNestedMessages>]: string | null;\n      };\n    }>;\n  },\n>(\n  config: TranslationRefOptions<TId, TNestedMessages, TTranslations>,\n): TranslationRef<TId, FlattenedMessages<TNestedMessages>> {\n  const ref = new TranslationRefImpl(config);\n  if (config.translations) {\n    ref.setDefaultResource(\n      createTranslationResource({\n        ref,\n        translations: config.translations as any,\n      }),\n    );\n  }\n  return ref;\n}\n\n/** @internal */\nexport function toInternalTranslationRef<\n  TId extends string,\n  TMessages extends AnyMessages,\n>(ref: TranslationRef<TId, TMessages>): InternalTranslationRef<TId, TMessages> {\n  const r = ref as InternalTranslationRef<TId, TMessages>;\n  if (r.$$type !== '@backstage/TranslationRef') {\n    throw new Error(`Invalid translation ref, bad type '${r.$$type}'`);\n  }\n  if (r.version !== 'v1') {\n    throw new Error(`Invalid translation ref, bad version '${r.version}'`);\n  }\n  return r;\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AppLanguageApi,\n  TranslationApi,\n  TranslationFunction,\n  TranslationMessages,\n  TranslationRef,\n  TranslationResource,\n  TranslationSnapshot,\n} from '@backstage/core-plugin-api/alpha';\nimport { createInstance as createI18n, type i18n as I18n } from 'i18next';\nimport ObservableImpl from 'zen-observable';\n\n// Internal import to avoid code duplication, this will lead to duplication in build output\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport {\n  toInternalTranslationResource,\n  InternalTranslationResourceLoader,\n} from '../../../../../core-plugin-api/src/translation/TranslationResource';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport {\n  toInternalTranslationRef,\n  InternalTranslationRef,\n} from '../../../../../core-plugin-api/src/translation/TranslationRef';\nimport { Observable } from '@backstage/types';\nimport { DEFAULT_LANGUAGE } from '../AppLanguageApi/AppLanguageSelector';\n\n/** @alpha */\nexport interface I18nextTranslationApiOptions {\n  languageApi: AppLanguageApi;\n  resources?: Array<TranslationMessages | TranslationResource>;\n}\n\nfunction removeNulls(\n  messages: Record<string, string | null>,\n): Record<string, string> {\n  return Object.fromEntries(\n    Object.entries(messages).filter(\n      (e): e is [string, string] => e[1] !== null,\n    ),\n  );\n}\n\n/**\n * The built-in i18next backend loading logic doesn't handle on the fly switches\n * of language very well. It gets a bit confused about whether resources are actually\n * loaded or not, so instead we implement our own resource loader.\n */\nclass ResourceLoader {\n  /** Loaded resources by loader key */\n  #loaded = new Set<string>();\n  /** Resource loading promises by loader key */\n  #loading = new Map<string, Promise<void>>();\n  /** Loaders for each resource language */\n  #loaders = new Map<string, InternalTranslationResourceLoader>();\n\n  constructor(\n    private readonly onLoad: (loaded: {\n      language: string;\n      namespace: string;\n      messages: Record<string, string | null>;\n    }) => void,\n  ) {}\n\n  addTranslationResource(resource: TranslationResource) {\n    const internalResource = toInternalTranslationResource(resource);\n    for (const entry of internalResource.resources) {\n      const key = this.#getLoaderKey(entry.language, internalResource.id);\n\n      // First loader to register wins, this means that resources registered in the app\n      // have priority over default resource from translation refs\n      if (!this.#loaders.has(key)) {\n        this.#loaders.set(key, entry.loader);\n      }\n    }\n  }\n\n  #getLoaderKey(language: string, namespace: string) {\n    return `${language}/${namespace}`;\n  }\n\n  needsLoading(language: string, namespace: string) {\n    const key = this.#getLoaderKey(language, namespace);\n    const loader = this.#loaders.get(key);\n    if (!loader) {\n      return false;\n    }\n\n    return !this.#loaded.has(key);\n  }\n\n  async load(language: string, namespace: string): Promise<void> {\n    const key = this.#getLoaderKey(language, namespace);\n\n    const loader = this.#loaders.get(key);\n    if (!loader) {\n      return;\n    }\n\n    if (this.#loaded.has(key)) {\n      return;\n    }\n\n    const loading = this.#loading.get(key);\n    if (loading) {\n      await loading;\n      return;\n    }\n\n    const load = loader().then(\n      result => {\n        this.onLoad({ language, namespace, messages: result.messages });\n        this.#loaded.add(key);\n      },\n      error => {\n        this.#loaded.add(key); // Do not try to load failed resources again\n        throw error;\n      },\n    );\n    this.#loading.set(key, load);\n    await load;\n  }\n}\n\n/** @alpha */\nexport class I18nextTranslationApi implements TranslationApi {\n  static create(options: I18nextTranslationApiOptions) {\n    const { languages } = options.languageApi.getAvailableLanguages();\n\n    const i18n = createI18n({\n      fallbackLng: DEFAULT_LANGUAGE,\n      supportedLngs: languages,\n      interpolation: {\n        escapeValue: false,\n      },\n      ns: [],\n      defaultNS: false,\n      fallbackNS: false,\n\n      // Disable resource loading on init, meaning i18n will be ready to use immediately\n      initImmediate: false,\n    });\n\n    i18n.init();\n    if (!i18n.isInitialized) {\n      throw new Error('i18next was unexpectedly not initialized');\n    }\n\n    const { language: initialLanguage } = options.languageApi.getLanguage();\n    if (initialLanguage !== DEFAULT_LANGUAGE) {\n      i18n.changeLanguage(initialLanguage);\n    }\n\n    const loader = new ResourceLoader(loaded => {\n      i18n.addResourceBundle(\n        loaded.language,\n        loaded.namespace,\n        removeNulls(loaded.messages),\n        false, // do not merge with existing translations\n        true, // overwrite translations\n      );\n    });\n\n    const resources = options?.resources || [];\n    // Iterate in reverse, giving higher priority to resources registered later\n    for (let i = resources.length - 1; i >= 0; i--) {\n      const resource = resources[i];\n      if (resource.$$type === '@backstage/TranslationResource') {\n        loader.addTranslationResource(resource);\n      } else if (resource.$$type === '@backstage/TranslationMessages') {\n        // Overrides for default messages, created with createTranslationMessages and installed via app\n        i18n.addResourceBundle(\n          DEFAULT_LANGUAGE,\n          resource.id,\n          removeNulls(resource.messages),\n          true, // merge with existing translations\n          false, // do not overwrite translations\n        );\n      }\n    }\n\n    const instance = new I18nextTranslationApi(\n      i18n,\n      loader,\n      options.languageApi.getLanguage().language,\n    );\n\n    options.languageApi.language$().subscribe(({ language }) => {\n      instance.#changeLanguage(language);\n    });\n\n    return instance;\n  }\n\n  #i18n: I18n;\n  #loader: ResourceLoader;\n  #language: string;\n\n  /** Keep track of which refs we have registered default resources for */\n  #registeredRefs = new Set<string>();\n  /** Notify observers when language changes */\n  #languageChangeListeners = new Set<() => void>();\n\n  private constructor(i18n: I18n, loader: ResourceLoader, language: string) {\n    this.#i18n = i18n;\n    this.#loader = loader;\n    this.#language = language;\n  }\n\n  getTranslation<TMessages extends { [key in string]: string }>(\n    translationRef: TranslationRef<string, TMessages>,\n  ): TranslationSnapshot<TMessages> {\n    const internalRef = toInternalTranslationRef(translationRef);\n\n    this.#registerDefaults(internalRef);\n\n    return this.#createSnapshot(internalRef);\n  }\n\n  translation$<TMessages extends { [key in string]: string }>(\n    translationRef: TranslationRef<string, TMessages>,\n  ): Observable<TranslationSnapshot<TMessages>> {\n    const internalRef = toInternalTranslationRef(translationRef);\n\n    this.#registerDefaults(internalRef);\n\n    return new ObservableImpl<TranslationSnapshot<TMessages>>(subscriber => {\n      let loadTicket = {}; // To check for stale loads\n\n      const loadResource = () => {\n        loadTicket = {};\n        const ticket = loadTicket;\n        this.#loader.load(this.#language, internalRef.id).then(\n          () => {\n            if (ticket === loadTicket) {\n              const snapshot = this.#createSnapshot(internalRef);\n              if (snapshot.ready) {\n                subscriber.next(snapshot);\n              }\n            }\n          },\n          error => {\n            if (ticket === loadTicket) {\n              subscriber.error(Array.isArray(error) ? error[0] : error);\n            }\n          },\n        );\n      };\n\n      const onChange = () => {\n        const snapshot = this.#createSnapshot(internalRef);\n        if (snapshot.ready) {\n          subscriber.next(snapshot);\n        } else {\n          loadResource();\n        }\n      };\n\n      if (this.#loader.needsLoading(this.#language, internalRef.id)) {\n        loadResource();\n      }\n\n      this.#languageChangeListeners.add(onChange);\n      return () => {\n        this.#languageChangeListeners.delete(onChange);\n      };\n    });\n  }\n\n  #changeLanguage(language: string): void {\n    if (this.#language !== language) {\n      this.#language = language;\n      this.#i18n.changeLanguage(language);\n      this.#languageChangeListeners.forEach(listener => listener());\n    }\n  }\n\n  #createSnapshot<TMessages extends { [key in string]: string }>(\n    internalRef: InternalTranslationRef<string, TMessages>,\n  ): TranslationSnapshot<TMessages> {\n    if (this.#loader.needsLoading(this.#language, internalRef.id)) {\n      return { ready: false };\n    }\n\n    const t = this.#i18n.getFixedT(\n      null,\n      internalRef.id,\n    ) as TranslationFunction<TMessages>;\n\n    return {\n      ready: true,\n      t,\n    };\n  }\n\n  #registerDefaults(internalRef: InternalTranslationRef): void {\n    if (this.#registeredRefs.has(internalRef.id)) {\n      return;\n    }\n    this.#registeredRefs.add(internalRef.id);\n\n    const defaultMessages = internalRef.getDefaultMessages();\n    this.#i18n.addResourceBundle(\n      DEFAULT_LANGUAGE,\n      internalRef.id,\n      defaultMessages,\n      true, // merge with existing translations\n      false, // do not overwrite translations\n    );\n\n    const defaultResource = internalRef.getDefaultResource();\n    if (defaultResource) {\n      this.#loader.addTranslationResource(defaultResource);\n    }\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig, ConfigReader } from '@backstage/config';\n\n/**\n * Creates a base URL that uses to the current document origin.\n */\nfunction createLocalBaseUrl(fullUrl: string): string {\n  const url = new URL(fullUrl);\n  url.protocol = document.location.protocol;\n  url.hostname = document.location.hostname;\n  url.port = document.location.port;\n  return url.toString().replace(/\\/$/, '');\n}\n\n/**\n * If we are able to override the app and backend base URLs to values that\n * match the origin of the current location, then this function returns a\n * new array of app configs that contain the overrides.\n *\n * @internal\n */\nexport function overrideBaseUrlConfigs(inputConfigs: AppConfig[]): AppConfig[] {\n  const urlConfigReader = ConfigReader.fromConfigs(inputConfigs);\n\n  // In tests we may not have `app.baseUrl` or `backend.baseUrl`, to keep them optional\n  const appBaseUrl = urlConfigReader.getOptionalString('app.baseUrl');\n  const backendBaseUrl = urlConfigReader.getOptionalString('backend.baseUrl');\n\n  let configs = inputConfigs;\n\n  let newBackendBaseUrl: string | undefined = undefined;\n  let newAppBaseUrl: string | undefined = undefined;\n\n  if (appBaseUrl && backendBaseUrl) {\n    const appOrigin = new URL(appBaseUrl).origin;\n    const backendOrigin = new URL(backendBaseUrl).origin;\n\n    if (appOrigin === backendOrigin) {\n      const maybeNewBackendBaseUrl = createLocalBaseUrl(backendBaseUrl);\n      if (backendBaseUrl !== maybeNewBackendBaseUrl) {\n        newBackendBaseUrl = maybeNewBackendBaseUrl;\n      }\n    }\n  }\n\n  if (appBaseUrl) {\n    const maybeNewAppBaseUrl = createLocalBaseUrl(appBaseUrl);\n    if (appBaseUrl !== maybeNewAppBaseUrl) {\n      newAppBaseUrl = maybeNewAppBaseUrl;\n    }\n  }\n\n  // Only add the relative config if there is actually data to add.\n  if (newAppBaseUrl || newBackendBaseUrl) {\n    configs = configs.concat({\n      data: {\n        app: newAppBaseUrl && {\n          baseUrl: newAppBaseUrl,\n        },\n        backend: newBackendBaseUrl && {\n          baseUrl: newBackendBaseUrl,\n        },\n      },\n      context: 'relative-resolver',\n    });\n  }\n\n  return configs;\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport React, {\n  ComponentType,\n  PropsWithChildren,\n  Suspense,\n  useMemo,\n  useRef,\n} from 'react';\nimport useAsync from 'react-use/lib/useAsync';\nimport {\n  ApiProvider,\n  AppThemeSelector,\n  ConfigReader,\n  LocalStorageFeatureFlags,\n} from '../apis';\nimport {\n  AnyApiFactory,\n  ApiHolder,\n  IconComponent,\n  AppTheme,\n  appThemeApiRef,\n  configApiRef,\n  AppThemeApi,\n  ConfigApi,\n  featureFlagsApiRef,\n  identityApiRef,\n  BackstagePlugin,\n  FeatureFlag,\n} from '@backstage/core-plugin-api';\nimport {\n  AppLanguageApi,\n  appLanguageApiRef,\n  translationApiRef,\n  TranslationMessages,\n  TranslationResource,\n} from '@backstage/core-plugin-api/alpha';\nimport { ApiFactoryRegistry, ApiResolver } from '../apis/system';\nimport {\n  childDiscoverer,\n  routeElementDiscoverer,\n  traverseElementTree,\n} from '../extensions/traversal';\nimport { pluginCollector } from '../plugins/collectors';\nimport {\n  featureFlagCollector,\n  routingV1Collector,\n  routingV2Collector,\n} from '../routing/collectors';\nimport { RoutingProvider } from '../routing/RoutingProvider';\nimport {\n  validateRouteParameters,\n  validateRouteBindings,\n} from '../routing/validation';\nimport { AppContextProvider } from './AppContext';\nimport { AppIdentityProxy } from '../apis/implementations/IdentityApi/AppIdentityProxy';\nimport {\n  AppComponents,\n  AppConfigLoader,\n  AppContext,\n  AppOptions,\n  BackstageApp,\n} from './types';\nimport { AppThemeProvider } from './AppThemeProvider';\nimport { defaultConfigLoader } from './defaultConfigLoader';\nimport { ApiRegistry } from '../apis/system/ApiRegistry';\nimport { resolveRouteBindings } from './resolveRouteBindings';\nimport { isReactRouterBeta } from './isReactRouterBeta';\nimport { InternalAppContext } from './InternalAppContext';\nimport { AppRouter, getBasePath } from './AppRouter';\nimport { AppLanguageSelector } from '../apis/implementations/AppLanguageApi';\nimport { I18nextTranslationApi } from '../apis/implementations/TranslationApi';\nimport { overrideBaseUrlConfigs } from './overrideBaseUrlConfigs';\n\ntype CompatiblePlugin =\n  | BackstagePlugin\n  | (Omit<BackstagePlugin, 'getFeatureFlags'> & {\n      output(): Array<{ type: 'feature-flag'; name: string }>;\n    });\n\nfunction useConfigLoader(\n  configLoader: AppConfigLoader | undefined,\n  components: AppComponents,\n  appThemeApi: AppThemeApi,\n): { api: ConfigApi } | { node: JSX.Element } {\n  // Keeping this synchronous when a config loader isn't set simplifies tests a lot\n  const hasConfig = Boolean(configLoader);\n  const config = useAsync(configLoader || (() => Promise.resolve([])));\n\n  let noConfigNode = undefined;\n\n  if (hasConfig && config.loading) {\n    const { Progress } = components;\n    noConfigNode = <Progress />;\n  } else if (config.error) {\n    const { BootErrorPage } = components;\n    noConfigNode = <BootErrorPage step=\"load-config\" error={config.error} />;\n  }\n\n  const { ThemeProvider = AppThemeProvider } = components;\n\n  // Before the config is loaded we can't use a router, so exit early\n  if (noConfigNode) {\n    return {\n      node: (\n        <ApiProvider apis={ApiRegistry.with(appThemeApiRef, appThemeApi)}>\n          <ThemeProvider>{noConfigNode}</ThemeProvider>\n        </ApiProvider>\n      ),\n    };\n  }\n\n  const configReader = ConfigReader.fromConfigs(\n    config.value?.length ? overrideBaseUrlConfigs(config.value) : [],\n  );\n\n  return { api: configReader };\n}\n\nclass AppContextImpl implements AppContext {\n  constructor(private readonly app: AppManager) {}\n\n  getPlugins(): BackstagePlugin[] {\n    return this.app.getPlugins();\n  }\n\n  getSystemIcon(key: string): IconComponent | undefined {\n    return this.app.getSystemIcon(key);\n  }\n\n  getSystemIcons(): Record<string, IconComponent> {\n    return this.app.getSystemIcons();\n  }\n\n  getComponents(): AppComponents {\n    return this.app.getComponents();\n  }\n}\n\nexport class AppManager implements BackstageApp {\n  private apiHolder?: ApiHolder;\n  private configApi?: ConfigApi;\n\n  private readonly apis: Iterable<AnyApiFactory>;\n  private readonly icons: NonNullable<AppOptions['icons']>;\n  private readonly plugins: Set<CompatiblePlugin>;\n  private readonly featureFlags: (FeatureFlag &\n    Omit<FeatureFlag, 'pluginId'>)[];\n  private readonly components: AppComponents;\n  private readonly themes: AppTheme[];\n  private readonly configLoader?: AppConfigLoader;\n  private readonly defaultApis: Iterable<AnyApiFactory>;\n  private readonly bindRoutes: AppOptions['bindRoutes'];\n  private readonly appLanguageApi: AppLanguageApi;\n  private readonly translationResources: Array<\n    TranslationResource | TranslationMessages\n  >;\n\n  private readonly appIdentityProxy = new AppIdentityProxy();\n  private readonly apiFactoryRegistry: ApiFactoryRegistry;\n\n  constructor(options: AppOptions) {\n    this.apis = options.apis ?? [];\n    this.icons = options.icons;\n    this.plugins = new Set((options.plugins as CompatiblePlugin[]) ?? []);\n    this.featureFlags = options.featureFlags ?? [];\n    this.components = options.components;\n    this.themes = options.themes as AppTheme[];\n    this.configLoader = options.configLoader ?? defaultConfigLoader;\n    this.defaultApis = options.defaultApis ?? [];\n    this.bindRoutes = options.bindRoutes;\n    this.apiFactoryRegistry = new ApiFactoryRegistry();\n    this.appLanguageApi = AppLanguageSelector.createWithStorage({\n      defaultLanguage: options.__experimentalTranslations?.defaultLanguage,\n      availableLanguages:\n        options.__experimentalTranslations?.availableLanguages,\n    });\n    this.translationResources =\n      options.__experimentalTranslations?.resources ?? [];\n  }\n\n  getPlugins(): BackstagePlugin[] {\n    return Array.from(this.plugins) as BackstagePlugin[];\n  }\n\n  getSystemIcon(key: string): IconComponent | undefined {\n    return this.icons[key];\n  }\n\n  getSystemIcons(): Record<string, IconComponent> {\n    return this.icons;\n  }\n\n  getComponents(): AppComponents {\n    return this.components;\n  }\n\n  createRoot(element: JSX.Element): ComponentType<PropsWithChildren<{}>> {\n    const AppProvider = this.getProvider();\n    const AppRoot = () => {\n      return <AppProvider>{element}</AppProvider>;\n    };\n    return AppRoot;\n  }\n\n  #getProviderCalled = false;\n  getProvider(): ComponentType<PropsWithChildren<{}>> {\n    if (this.#getProviderCalled) {\n      throw new Error(\n        'app.getProvider() or app.createRoot() has already been called, and can only be called once',\n      );\n    }\n    this.#getProviderCalled = true;\n\n    const appContext = new AppContextImpl(this);\n\n    // We only validate routes once\n    let routesHaveBeenValidated = false;\n\n    const Provider = ({ children }: PropsWithChildren<{}>) => {\n      const needsFeatureFlagRegistrationRef = useRef(true);\n      const appThemeApi = useMemo(\n        () => AppThemeSelector.createWithStorage(this.themes),\n        [],\n      );\n\n      const { routing, featureFlags, routeBindings } = useMemo(() => {\n        const usesReactRouterBeta = isReactRouterBeta();\n        if (usesReactRouterBeta) {\n          // eslint-disable-next-line no-console\n          console.warn(`\nDEPRECATION WARNING: React Router Beta is deprecated and support for it will be removed in a future release.\n                     Please migrate to use React Router v6 stable.\n                     See https://backstage.io/docs/tutorials/react-router-stable-migration\n`);\n        }\n\n        const result = traverseElementTree({\n          root: children,\n          discoverers: [childDiscoverer, routeElementDiscoverer],\n          collectors: {\n            routing: usesReactRouterBeta\n              ? routingV1Collector\n              : routingV2Collector,\n            collectedPlugins: pluginCollector,\n            featureFlags: featureFlagCollector,\n          },\n        });\n\n        // TODO(Rugvip): Restructure the public API so that we can get an immediate view of\n        //               the app, rather than having to wait for the provider to render.\n        //               For now we need to push the additional plugins we find during\n        //               collection and then make sure we initialize things afterwards.\n        result.collectedPlugins.forEach(plugin => this.plugins.add(plugin));\n        this.verifyPlugins(this.plugins);\n\n        // Initialize APIs once all plugins are available\n        this.getApiHolder();\n        return {\n          ...result,\n          routeBindings: resolveRouteBindings(this.bindRoutes),\n        };\n      }, [children]);\n\n      if (!routesHaveBeenValidated) {\n        routesHaveBeenValidated = true;\n        validateRouteParameters(routing.paths, routing.parents);\n        validateRouteBindings(\n          routeBindings,\n          this.plugins as Iterable<BackstagePlugin>,\n        );\n      }\n\n      const loadedConfig = useConfigLoader(\n        this.configLoader,\n        this.components,\n        appThemeApi,\n      );\n\n      const hasConfigApi = 'api' in loadedConfig;\n      if (hasConfigApi) {\n        const { api } = loadedConfig as { api: Config };\n        this.configApi = api;\n      }\n\n      if ('node' in loadedConfig) {\n        // Loading or error\n        return loadedConfig.node;\n      }\n\n      // We can't register feature flags just after the element traversal, because the\n      // config API isn't available yet and implementations frequently depend on it.\n      // Instead we make it happen immediately, to make sure all flags are available\n      // for the first render.\n      if (hasConfigApi && needsFeatureFlagRegistrationRef.current) {\n        needsFeatureFlagRegistrationRef.current = false;\n\n        const featureFlagsApi = this.getApiHolder().get(featureFlagsApiRef)!;\n\n        if (featureFlagsApi) {\n          for (const flag of this.featureFlags) {\n            featureFlagsApi.registerFlag({\n              ...flag,\n              pluginId: '',\n            });\n          }\n          for (const plugin of this.plugins.values()) {\n            if ('getFeatureFlags' in plugin) {\n              for (const flag of plugin.getFeatureFlags()) {\n                featureFlagsApi.registerFlag({\n                  name: flag.name,\n                  pluginId: plugin.getId(),\n                });\n              }\n            } else {\n              for (const output of plugin.output()) {\n                if (output.type === 'feature-flag') {\n                  featureFlagsApi.registerFlag({\n                    name: output.name,\n                    pluginId: plugin.getId(),\n                  });\n                }\n              }\n            }\n          }\n\n          // Go through the featureFlags returned from the traversal and\n          // register those now the configApi has been loaded\n          const registeredFlags = featureFlagsApi.getRegisteredFlags();\n          const flagNames = new Set(registeredFlags.map(f => f.name));\n          for (const name of featureFlags) {\n            // Prevents adding duplicate feature flags\n            if (!flagNames.has(name)) {\n              featureFlagsApi.registerFlag({ name, pluginId: '' });\n            }\n          }\n        }\n      }\n\n      const { ThemeProvider = AppThemeProvider, Progress } = this.components;\n\n      return (\n        <ApiProvider apis={this.getApiHolder()}>\n          <AppContextProvider appContext={appContext}>\n            <ThemeProvider>\n              <RoutingProvider\n                routePaths={routing.paths}\n                routeParents={routing.parents}\n                routeObjects={routing.objects}\n                routeBindings={routeBindings}\n                basePath={getBasePath(loadedConfig.api)}\n              >\n                <InternalAppContext.Provider\n                  value={{\n                    routeObjects: routing.objects,\n                    appIdentityProxy: this.appIdentityProxy,\n                  }}\n                >\n                  <Suspense fallback={<Progress />}>{children}</Suspense>\n                </InternalAppContext.Provider>\n              </RoutingProvider>\n            </ThemeProvider>\n          </AppContextProvider>\n        </ApiProvider>\n      );\n    };\n    return Provider;\n  }\n\n  getRouter(): ComponentType<PropsWithChildren<{}>> {\n    return AppRouter;\n  }\n\n  private getApiHolder(): ApiHolder {\n    if (this.apiHolder) {\n      // Register additional plugins if they have been added.\n      // Routes paths, objects and others are already updated in the provider when children of it change\n      for (const plugin of this.plugins) {\n        for (const factory of plugin.getApis()) {\n          if (!this.apiFactoryRegistry.get(factory.api)) {\n            this.apiFactoryRegistry.register('default', factory);\n          }\n        }\n      }\n      ApiResolver.validateFactories(\n        this.apiFactoryRegistry,\n        this.apiFactoryRegistry.getAllApis(),\n      );\n      return this.apiHolder;\n    }\n    this.apiFactoryRegistry.register('static', {\n      api: appThemeApiRef,\n      deps: {},\n      factory: () => AppThemeSelector.createWithStorage(this.themes),\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: configApiRef,\n      deps: {},\n      factory: () => {\n        if (!this.configApi) {\n          throw new Error(\n            'Tried to access config API before config was loaded',\n          );\n        }\n        return this.configApi;\n      },\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: identityApiRef,\n      deps: {},\n      factory: () => this.appIdentityProxy,\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: appLanguageApiRef,\n      deps: {},\n      factory: () => this.appLanguageApi,\n    });\n\n    // The translation API is registered as a default API so that it can be overridden.\n    // It will be up to the implementer of the new API to register translation resources.\n    this.apiFactoryRegistry.register('default', {\n      api: translationApiRef,\n      deps: { languageApi: appLanguageApiRef },\n      factory: ({ languageApi }) =>\n        I18nextTranslationApi.create({\n          languageApi,\n          resources: this.translationResources,\n        }),\n    });\n\n    // It's possible to replace the feature flag API, but since we must have at least\n    // one implementation we add it here directly instead of through the defaultApis.\n    this.apiFactoryRegistry.register('default', {\n      api: featureFlagsApiRef,\n      deps: {},\n      factory: () => new LocalStorageFeatureFlags(),\n    });\n    for (const factory of this.defaultApis) {\n      this.apiFactoryRegistry.register('default', factory);\n    }\n\n    for (const plugin of this.plugins) {\n      for (const factory of plugin.getApis()) {\n        if (!this.apiFactoryRegistry.register('default', factory)) {\n          throw new Error(\n            `Plugin ${plugin.getId()} tried to register duplicate or forbidden API factory for ${\n              factory.api\n            }`,\n          );\n        }\n      }\n    }\n\n    for (const factory of this.apis) {\n      if (!this.apiFactoryRegistry.register('app', factory)) {\n        throw new Error(\n          `Duplicate or forbidden API factory for ${factory.api} in app`,\n        );\n      }\n    }\n\n    ApiResolver.validateFactories(\n      this.apiFactoryRegistry,\n      this.apiFactoryRegistry.getAllApis(),\n    );\n\n    this.apiHolder = new ApiResolver(this.apiFactoryRegistry);\n    return this.apiHolder;\n  }\n\n  private verifyPlugins(plugins: Iterable<CompatiblePlugin>) {\n    const pluginIds = new Set<string>();\n\n    for (const plugin of plugins) {\n      const id = plugin.getId();\n      if (pluginIds.has(id)) {\n        throw new Error(`Duplicate plugin found '${id}'`);\n      }\n      pluginIds.add(id);\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppManager } from './AppManager';\nimport { AppOptions, BackstageApp } from './types';\n\n/**\n * Creates a new Backstage App where the full set of options are required.\n *\n * @public\n * @param options - A set of options for creating the app\n * @returns\n * @remarks\n *\n * You will most likely want to use {@link @backstage/app-defaults#createApp},\n * however, this low-level API allows you to provide a full set of options,\n * including your own `components`, `icons`, `defaultApis`, and `themes`. This\n * is particularly useful if you are not using `@backstage/core-components` or\n * Material UI, as it allows you to avoid those dependencies completely.\n */\nexport function createSpecializedApp(options: AppOptions): BackstageApp {\n  return new AppManager(options);\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { ReactNode, useMemo } from 'react';\nimport { useRoutes } from 'react-router-dom';\nimport {\n  attachComponentData,\n  useApp,\n  useElementFilter,\n} from '@backstage/core-plugin-api';\nimport { isReactRouterBeta } from '../app/isReactRouterBeta';\n\nlet warned = false;\n\ntype RouteObject = {\n  path: string;\n  element: ReactNode;\n  children?: RouteObject[];\n};\n\n/**\n * Props for the {@link FlatRoutes} component.\n *\n * @public\n */\nexport type FlatRoutesProps = {\n  children: ReactNode;\n};\n\n/**\n * A wrapper around a set of routes.\n *\n * @remarks\n *\n * The root of the routing hierarchy in your app should use this component,\n * instead of the one from `react-router-dom`. This ensures that all of the\n * plugin route and utility API wiring happens under the hood.\n *\n * @public\n */\nexport const FlatRoutes = (props: FlatRoutesProps): JSX.Element | null => {\n  const app = useApp();\n  const { NotFoundErrorPage } = app.getComponents();\n  const isBeta = useMemo(() => isReactRouterBeta(), []);\n  const routes = useElementFilter(props.children, elements =>\n    elements\n      .getElements<{\n        path?: string;\n        element?: ReactNode;\n        children?: ReactNode;\n      }>()\n      .flatMap<RouteObject>(child => {\n        let path = child.props.path;\n\n        // TODO(Rugvip): Work around plugins registering empty paths, remove once deprecated routes are gone\n        if (path === '') {\n          return [];\n        }\n        path = path?.replace(/\\/\\*$/, '') ?? '/';\n\n        let element = isBeta ? child : child.props.element;\n        if (!isBeta && !element) {\n          element = child;\n          if (!warned && process.env.NODE_ENV !== 'test') {\n            // eslint-disable-next-line no-console\n            console.warn(\n              'DEPRECATION WARNING: All elements within <FlatRoutes> must be of type <Route> with an element prop. ' +\n                'Existing usages of <Navigate key=[path] to=[to] /> should be replaced with <Route path=[path] element={<Navigate to=[to] />} />.',\n            );\n            warned = true;\n          }\n        }\n\n        return [\n          {\n            // Each route matches any sub route, except for the explicit root path\n            path,\n            element,\n            children: child.props.children\n              ? [\n                  // These are the children of each route, which we all add in under a catch-all\n                  // subroute in order to make them available to `useOutlet`\n                  {\n                    path: path === '/' ? '/' : '*', // The root path must require an exact match\n                    element: child.props.children,\n                  },\n                ]\n              : undefined,\n          },\n        ];\n      })\n      // Routes are sorted to work around a bug where prefixes are unexpectedly matched\n      // TODO(Rugvip): This can be removed once react-router v6 beta is no longer supported\n      .sort((a, b) => b.path.localeCompare(a.path))\n      .map(obj => ({ ...obj, path: obj.path === '/' ? '/' : `${obj.path}/*` })),\n  );\n\n  // TODO(Rugvip): Possibly add a way to skip this, like a noNotFoundPage prop\n  const withNotFound = [\n    ...routes,\n    {\n      path: '*',\n      element: <NotFoundErrorPage />,\n    },\n  ];\n\n  return useRoutes(withNotFound);\n};\n\nattachComponentData(FlatRoutes, 'core.type', 'FlatRoutes');\n"],"names":["__publicField","ScopePriority","warned","hasScopes","DEFAULT_PROVIDER","SCOPE_PREFIX","STORAGE_KEY","_a","_language","__privateAdd","__privateSet","__privateGet","createI18n"],"mappings":"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"}