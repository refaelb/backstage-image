{"version":3,"file":"index.esm.js","sources":["../src/lib/globalObject.ts","../src/lib/VersionedValue.ts","../src/lib/VersionedContext.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028\nfunction getGlobalObject() {\n  if (typeof window !== 'undefined' && window.Math === Math) {\n    return window;\n  }\n  // eslint-disable-next-line no-restricted-globals\n  if (typeof self !== 'undefined' && self.Math === Math) {\n    // eslint-disable-next-line no-restricted-globals\n    return self;\n  }\n  // eslint-disable-next-line no-new-func\n  return Function('return this')();\n}\n\nconst globalObject = getGlobalObject();\n\nconst makeKey = (id: string) => `__@backstage/${id}__`;\n\n/**\n * Serializes access to a global singleton value, with the first caller creating the value.\n *\n * @public\n */\nexport function getOrCreateGlobalSingleton<T>(\n  id: string,\n  supplier: () => T,\n): T {\n  const key = makeKey(id);\n\n  let value = globalObject[key];\n  if (value) {\n    return value;\n  }\n\n  value = supplier();\n  globalObject[key] = value;\n  return value;\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The versioned value interface is a container for a set of values that\n * can be looked up by version. It is intended to be used as a container\n * for values that can be versioned independently of package versions.\n *\n * @public\n */\nexport type VersionedValue<Versions extends { [version: number]: unknown }> = {\n  atVersion<Version extends keyof Versions>(\n    version: Version,\n  ): Versions[Version] | undefined;\n};\n\n/**\n * Creates a container for a map of versioned values that implements VersionedValue.\n *\n * @public\n */\nexport function createVersionedValueMap<\n  Versions extends { [version: number]: unknown },\n>(versions: Versions): VersionedValue<Versions> {\n  Object.freeze(versions);\n  const versionedValue: VersionedValue<Versions> = {\n    atVersion(version) {\n      return versions[version];\n    },\n  };\n  Object.defineProperty(versionedValue, '$map', {\n    configurable: true,\n    enumerable: true,\n    get() {\n      return versions;\n    },\n  });\n  return versionedValue;\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createContext, useContext, Context } from 'react';\nimport { getOrCreateGlobalSingleton } from './globalObject';\nimport { createVersionedValueMap, VersionedValue } from './VersionedValue';\n\n/**\n * Get the existing or create a new versioned React context that's\n * stored inside a global singleton.\n *\n * @param key - A key that uniquely identifies the context.\n * @public\n * @example\n *\n * ```ts\n * const MyContext = createVersionedContext<{ 1: string }>('my-context');\n *\n * const MyContextProvider = ({children}) => (\n *   <MyContext.Provider value={createVersionedValueMap({ 1: 'value-for-version-1' })}>\n *     {children}\n *   <MyContext.Provider>\n * )\n * ```\n */\nexport function createVersionedContext<\n  Versions extends { [version in number]: unknown },\n>(key: string): Context<VersionedValue<Versions> | undefined> {\n  return getOrCreateGlobalSingleton(key, () =>\n    createContext<VersionedValue<Versions> | undefined>(undefined),\n  );\n}\n\n/**\n * A hook that simplifies the consumption of a versioned contexts that's\n * stored inside a global singleton.\n *\n * @param key - A key that uniquely identifies the context.\n * @public\n * @example\n *\n * ```ts\n * const versionedHolder = useVersionedContext<{ 1: string }>('my-context');\n *\n * if (!versionedHolder) {\n *   throw new Error('My context is not available!')\n * }\n *\n * const myValue = versionedHolder.atVersion(1);\n *\n * // ...\n * ```\n */\nexport function useVersionedContext<\n  Versions extends { [version in number]: unknown },\n>(key: string): VersionedValue<Versions> | undefined {\n  return useContext(createVersionedContext<Versions>(key));\n}\n\n/**\n * Creates a helper for writing tests towards multiple different\n * combinations of versions provided from a context.\n *\n * @param key - A key that uniquely identifies the context.\n * @public\n * @example\n *\n * ```ts\n * const context = createVersionedContextForTesting('my-context');\n *\n * afterEach(() => {\n *   context.reset();\n * });\n *\n * it('should work when provided with version 1', () => {\n *   context.set({1: 'value-for-version-1'})\n *\n *   // ...\n * })\n * ```\n */\nexport function createVersionedContextForTesting(key: string) {\n  return {\n    set(versions: { [version in number]: unknown }) {\n      (globalThis as any)[`__@backstage/${key}__`] = createContext(\n        createVersionedValueMap(versions),\n      );\n    },\n    reset() {\n      delete (globalThis as any)[`__@backstage/${key}__`];\n    },\n  };\n}\n"],"names":[],"mappings":";;AAiBA,SAAS,eAAkB,GAAA;AACzB,EAAA,IAAI,OAAO,MAAA,KAAW,WAAe,IAAA,MAAA,CAAO,SAAS,IAAM,EAAA;AACzD,IAAO,OAAA,MAAA,CAAA;AAAA,GACT;AAEA,EAAA,IAAI,OAAO,IAAA,KAAS,WAAe,IAAA,IAAA,CAAK,SAAS,IAAM,EAAA;AAErD,IAAO,OAAA,IAAA,CAAA;AAAA,GACT;AAEA,EAAO,OAAA,QAAA,CAAS,aAAa,CAAE,EAAA,CAAA;AACjC,CAAA;AAEA,MAAM,eAAe,eAAgB,EAAA,CAAA;AAErC,MAAM,OAAU,GAAA,CAAC,EAAe,KAAA,CAAA,aAAA,EAAgB,EAAE,CAAA,EAAA,CAAA,CAAA;AAOlC,SAAA,0BAAA,CACd,IACA,QACG,EAAA;AACH,EAAM,MAAA,GAAA,GAAM,QAAQ,EAAE,CAAA,CAAA;AAEtB,EAAI,IAAA,KAAA,GAAQ,aAAa,GAAG,CAAA,CAAA;AAC5B,EAAA,IAAI,KAAO,EAAA;AACT,IAAO,OAAA,KAAA,CAAA;AAAA,GACT;AAEA,EAAA,KAAA,GAAQ,QAAS,EAAA,CAAA;AACjB,EAAA,YAAA,CAAa,GAAG,CAAI,GAAA,KAAA,CAAA;AACpB,EAAO,OAAA,KAAA,CAAA;AACT;;ACnBO,SAAS,wBAEd,QAA8C,EAAA;AAC9C,EAAA,MAAA,CAAO,OAAO,QAAQ,CAAA,CAAA;AACtB,EAAA,MAAM,cAA2C,GAAA;AAAA,IAC/C,UAAU,OAAS,EAAA;AACjB,MAAA,OAAO,SAAS,OAAO,CAAA,CAAA;AAAA,KACzB;AAAA,GACF,CAAA;AACA,EAAO,MAAA,CAAA,cAAA,CAAe,gBAAgB,MAAQ,EAAA;AAAA,IAC5C,YAAc,EAAA,IAAA;AAAA,IACd,UAAY,EAAA,IAAA;AAAA,IACZ,GAAM,GAAA;AACJ,MAAO,OAAA,QAAA,CAAA;AAAA,KACT;AAAA,GACD,CAAA,CAAA;AACD,EAAO,OAAA,cAAA,CAAA;AACT;;ACbO,SAAS,uBAEd,GAA4D,EAAA;AAC5D,EAAO,OAAA,0BAAA;AAAA,IAA2B,GAAA;AAAA,IAAK,MACrC,cAAoD,KAAS,CAAA,CAAA;AAAA,GAC/D,CAAA;AACF,CAAA;AAsBO,SAAS,oBAEd,GAAmD,EAAA;AACnD,EAAO,OAAA,UAAA,CAAW,sBAAiC,CAAA,GAAG,CAAC,CAAA,CAAA;AACzD,CAAA;AAwBO,SAAS,iCAAiC,GAAa,EAAA;AAC5D,EAAO,OAAA;AAAA,IACL,IAAI,QAA4C,EAAA;AAC9C,MAAC,UAAmB,CAAA,CAAA,aAAA,EAAgB,GAAG,CAAA,EAAA,CAAI,CAAI,GAAA,aAAA;AAAA,QAC7C,wBAAwB,QAAQ,CAAA;AAAA,OAClC,CAAA;AAAA,KACF;AAAA,IACA,KAAQ,GAAA;AACN,MAAQ,OAAA,UAAA,CAAmB,CAAgB,aAAA,EAAA,GAAG,CAAI,EAAA,CAAA,CAAA,CAAA;AAAA,KACpD;AAAA,GACF,CAAA;AACF;;;;"}