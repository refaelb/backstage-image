{"version":3,"file":"index.js","sources":["../src/RequesterUtils.ts","../src/BaseResource.ts"],"sourcesContent":["import { decamelizeKeys } from 'xcase';\nimport FormData, { Headers } from 'form-data';\nimport { stringify } from 'qs';\n\n// Types\nexport interface Constructable<T = any> {\n  new (...args: any[]): T;\n}\n\nexport interface RequesterType {\n  get(endpoint: string, options?: Record<string, unknown>): Promise<any>;\n  post(endpoint: string, options?: Record<string, unknown>): Promise<any>;\n  put(endpoint: string, options?: Record<string, unknown>): Promise<any>;\n  delete(endpoint: string, options?: Record<string, unknown>): Promise<any>;\n  stream?(endpoint: string, options?: Record<string, unknown>): NodeJS.ReadableStream;\n}\n\nexport type DefaultResourceOptions = {\n  headers: { [header: string]: string };\n  requestTimeout: number;\n  url: string;\n  rejectUnauthorized: boolean;\n};\n\nexport type DefaultRequestOptions = {\n  body?: FormData | Record<string, unknown>;\n  query?: Record<string, unknown>;\n  sudo?: string;\n  method?: string;\n};\n\nexport type DefaultRequestReturn = {\n  headers: Record<string, string> | Headers;\n  timeout?: number;\n  method: string;\n  searchParams?: string;\n  prefixUrl?: string;\n  body?: string | FormData;\n};\n\n// Utility methods\nexport function formatQuery(params: Record<string, unknown> = {}): string {\n  const decamelized = decamelizeKeys(params);\n\n  return stringify(decamelized, { arrayFormat: 'brackets' });\n}\n\nexport type OptionsHandlerFn = (\n  serviceOptions: DefaultResourceOptions,\n  requestOptions: DefaultRequestOptions,\n) => DefaultRequestReturn;\nexport function defaultOptionsHandler(\n  resourceOptions: DefaultResourceOptions,\n  { body, query, sudo, method = 'get' }: DefaultRequestOptions = {},\n): DefaultRequestReturn {\n  const { headers: preconfiguredHeaders, requestTimeout, url } = resourceOptions;\n  const headers = { ...preconfiguredHeaders };\n  let bod: FormData | string;\n\n  if (sudo) headers.sudo = sudo;\n\n  // FIXME: Not the best comparison, but...it will have to do for now.\n  if (typeof body === 'object' && body.constructor.name !== 'FormData') {\n    bod = JSON.stringify(decamelizeKeys(body));\n    headers['content-type'] = 'application/json';\n  } else {\n    bod = body as FormData;\n  }\n\n  return {\n    headers,\n    timeout: requestTimeout,\n    method,\n    searchParams: formatQuery(query),\n    prefixUrl: url,\n    body: bod,\n  };\n}\n\nexport type RequestHandlerFn = (\n  endpoint: string,\n  options?: Record<string, unknown>,\n) =>\n  | any\n  | Promise<{\n      body: Record<string, unknown> | Record<string, unknown>[];\n      headers: Record<string, unknown> | Headers;\n      status: number;\n    }>;\n\nexport function createRequesterFn(\n  optionsHandler: OptionsHandlerFn,\n  requestHandler: RequestHandlerFn,\n): (serviceOptions: DefaultResourceOptions) => RequesterType {\n  const methods = ['get', 'post', 'put', 'delete', 'stream'];\n\n  return (serviceOptions) => {\n    const requester: RequesterType = {} as RequesterType;\n\n    methods.forEach((m) => {\n      requester[m] = (endpoint: string, options: Record<string, unknown>) => {\n        const requestOptions = optionsHandler(serviceOptions, { ...options, method: m });\n\n        return requestHandler(endpoint, requestOptions);\n      };\n    });\n\n    return requester;\n  };\n}\n\nfunction extendClass<T extends Constructable>(Base: T, customConfig: Record<string, unknown>): T {\n  return class extends Base {\n    constructor(...options: any[]) {\n      const [config, ...opts] = options;\n\n      super({ ...customConfig, ...config }, ...opts);\n    }\n  };\n}\n\nexport function presetResourceArguments<T>(\n  resources: T,\n  customConfig: Record<string, unknown> = {},\n) {\n  const updated = {};\n\n  Object.entries(resources)\n    .filter(([, s]) => typeof s === 'function') // FIXME: Odd default artifact included in this list during testing\n    .forEach(([k, r]) => {\n      updated[k] = extendClass(r, customConfig);\n    });\n\n  return updated as T;\n}\n","import { RequesterType, DefaultResourceOptions } from './RequesterUtils';\n\nexport interface BaseResourceOptions<C> {\n  oauthToken?: string;\n  token?: string;\n  jobToken?: string;\n  host?: string;\n  prefixUrl?: string;\n  version?: 3 | 4;\n  rejectUnauthorized?: boolean;\n  camelize?: C;\n  requesterFn?: (resourceOptions: DefaultResourceOptions) => RequesterType;\n  requestTimeout?: number;\n  profileToken?: string;\n  sudo?: string | number;\n  profileMode?: 'execution' | 'memory';\n}\n\nexport class BaseResource<C extends boolean = false> {\n  public readonly url: string;\n\n  public readonly requester: RequesterType;\n\n  public readonly requestTimeout: number;\n\n  public readonly headers: { [header: string]: string };\n\n  public readonly camelize: C | undefined;\n\n  public readonly rejectUnauthorized: boolean;\n\n  constructor({\n    token,\n    jobToken,\n    oauthToken,\n    sudo,\n    profileToken,\n    requesterFn,\n    camelize,\n    profileMode = 'execution',\n    host = 'https://gitlab.com',\n    prefixUrl = '',\n    version = 4,\n    rejectUnauthorized = true,\n    requestTimeout = 300000,\n  }: BaseResourceOptions<C> = {}) {\n    if (!requesterFn) throw new ReferenceError('requesterFn must be passed');\n\n    this.url = [host, 'api', `v${version}`, prefixUrl].join('/');\n\n    this.headers = {\n      'user-agent': 'gitbeaker',\n    };\n    this.rejectUnauthorized = rejectUnauthorized;\n    this.camelize = camelize;\n    this.requestTimeout = requestTimeout;\n\n    // Handle auth tokens\n    if (oauthToken) this.headers.authorization = `Bearer ${oauthToken}`;\n    else if (jobToken) this.headers['job-token'] = jobToken;\n    else if (token) this.headers['private-token'] = token;\n\n    // Profiling\n    if (profileToken) {\n      this.headers['X-Profile-Token'] = profileToken;\n      this.headers['X-Profile-Mode'] = profileMode;\n    }\n\n    // Set sudo\n    if (sudo) this.headers.Sudo = `${sudo}`;\n\n    // Set requester instance using this information\n    this.requester = requesterFn({ ...this });\n  }\n}\n"],"names":["decamelizeKeys","stringify"],"mappings":"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"}