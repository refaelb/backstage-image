"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAsyncAbortable = void 0;
const react_1 = require("react");
const useAsync_1 = require("../useAsync");
/**
 * Like `useAsync`, but also provides `AbortSignal` as the first argument to the async function.
 *
 * @param asyncFn Function that returns a promise.
 * @param initialValue Value that will be set on initialisation before the async function is
 * executed.
 */
function useAsyncAbortable(asyncFn, initialValue) {
    const abortController = (0, react_1.useRef)();
    const fn = async (...args) => {
        // Abort previous async
        abortController.current?.abort();
        // Create new controller for ongoing async call
        const ac = new AbortController();
        abortController.current = ac;
        // Pass down abort signal and received arguments
        return asyncFn(ac.signal, ...args).finally(() => {
            // Unset ref uf the call is last
            if (abortController.current === ac) {
                abortController.current = undefined;
            }
        });
    };
    const [state, asyncActions, asyncMeta] = (0, useAsync_1.useAsync)(fn, initialValue);
    return [
        state,
        (0, react_1.useMemo)(() => {
            const actions = {
                reset() {
                    actions.abort();
                    asyncActions.reset();
                },
                abort() {
                    abortController.current?.abort();
                },
            };
            return {
                ...asyncActions,
                ...actions,
            };
        }, []),
        { ...asyncMeta, abortController: abortController.current },
    ];
}
exports.useAsyncAbortable = useAsyncAbortable;
